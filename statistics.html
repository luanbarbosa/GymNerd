<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GymNerd | Stats</title>
    <link rel="icon" type="image/svg+xml" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <script src="auth.js"></script>
    <script src="gn-i18n.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="db.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --primary: #3b82f6; 
            --primary-grad: linear-gradient(135deg, #60a5fa 0%, #2563eb 100%); 
            --bg: #0f172a; 
            --card: #1e293b; 
            --text: #f8fafc; 
            --text-dim: #94a3b8; 
            --success: #10b981; 
            --danger: #ef4444;
            --card-border: rgba(255, 255, 255, 0.08);
        }
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); max-width: 500px; margin: 0 auto; padding: 20px; animation: fadeIn 0.3s ease-out; line-height: 1.5; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .header { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; }
        .header h2 { font-size: 1.75rem; font-weight: 800; letter-spacing: -0.025em; background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; }
        .back-btn { text-decoration: none; font-size: 1.5rem; color: var(--text); }
        
        /* Dashboard Grid */
        .stats-overview { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 24px; }
        .stat-card { background: var(--card); padding: 16px; border-radius: 20px; border: 1px solid var(--card-border); display: flex; flex-direction: column; gap: 4px; }
        .stat-label { font-size: 0.75rem; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em; }
        .stat-value { font-size: 1.5rem; font-weight: 800; color: var(--text); }
        .stat-sub { font-size: 0.7rem; color: var(--text-dim); opacity: 0.8; }

        .main-grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 32px; }

        .card { background: var(--card); padding: 20px; border-radius: 24px; border: 1px solid var(--card-border); box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .calendar-card { width: 100%; box-sizing: border-box; }
        
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .calendar-header h3 { font-size: 0.9rem; margin: 0; text-transform: capitalize; }
        .nav-btn { background: rgba(255,255,255,0.05); border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 0.8rem; color: white; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .day-name { font-size: 0.6rem; text-align: center; color: var(--text-dim); font-weight: bold; padding-bottom: 4px; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-size: 0.7rem; }
        
        .past-no-workout { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .has-workout { background: var(--success); color: white; font-weight: bold; }
        .future-day { background: rgba(255,255,255,0.02); color: #475569; border: 1px solid rgba(255,255,255,0.05); }
        .today { border: 1.5px solid var(--primary); }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .section-title { margin-top: 32px; margin-bottom: 16px; font-weight: 800; font-size: 1.5rem; letter-spacing: -0.025em; background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; width: fit-content; text-transform: capitalize; grid-column: 1 / -1; }
        .chart-box { background: var(--card); padding: 20px; border-radius: 24px; border: 1px solid var(--card-border); }
        .chart-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .chart-thumb { width: 64px; height: 52px; border-radius: 8px; object-fit: contain; object-position: center; background: #fff; }
        .canvas-wrapper { height: 180px; }
    </style>
</head>
<body>
    <div class="header"><a href="index.html" class="back-btn">←</a><h2 data-i18n="page_statistics"></h2></div>

    <div id="stats-overview" class="stats-overview"></div>


    <div class="main-grid">
        <div class="card calendar-card">
        <div class="calendar-header">
            <button class="nav-btn" onclick="changeMonth(-1)">❮</button>
            <h3 id="monthDisplay"></h3>
            <button class="nav-btn" onclick="changeMonth(1)">❯</button>
        </div>
        <div class="calendar-grid" id="dayNames"></div>
        <div class="calendar-grid" id="calendarGrid"></div>
        </div>

        <div class="card frequency-card">
            <div class="calendar-header">
            <h3 data-i18n="workout_frequency"></h3>
                <select id="frequencyFilter" onchange="updateFrequencyChart()" class="nav-btn" style="width: auto; border: 1px solid rgba(255,255,255,0.1);">
                <option value="month" selected data-i18n="monthly">Monthly</option>
                <option value="year" data-i18n="yearly">Yearly</option>
            </select>
        </div>
            <div class="canvas-wrapper" style="height: 200px;">
            <canvas id="frequencyChart"></canvas>
        </div>
        </div>

        <div class="card" id="weightCard">
            <div class="calendar-header"><h3 data-i18n="weight_progress"></h3></div>
            <div class="canvas-wrapper" style="height: 200px;">
                <canvas id="weightChart"></canvas>
            </div>
        </div>
    </div>

    <div class="stats-grid" id="chartsWrapper"></div>

    <script>
        const FALLBACK_IMG = (typeof defaultImage !== 'undefined') ? defaultImage : "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM5NGFhYjgiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cmVjdCB4PSIzIiB5PSIzIiB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHJ4PSIyIiByeT0iMiIvPjxjaXJjbGUgY3g9IjguNSIgY3k9IjguNSIgcj0iMS41Ii8+PHBhdGggZD0iTTIxIDE1bC01LTUtNCA0LTQtNC04IDgiLz48L3N2Zz4=";
        
        let currentViewDate = new Date();

        async function init() {
            const logs = await db.logs.toArray();
            renderCalendar(logs);
            renderCharts(logs);
            updateStreakBadge();
            updateFrequencyChart(logs);
            renderWeightChart();
        }

        async function renderWeightChart() {
            await ensureDbOpen();
            const weights = await db.weights.orderBy('date').toArray();
            const ctx = document.getElementById('weightChart').getContext('2d');
            if (!weights || weights.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '14px sans-serif';
                ctx.fillStyle = '#94a3b8';
                ctx.fillText(GN_I18N.t('no_weight_data'), 20, 40);
                return;
            }
            const labels = weights.map(w => w.date.slice(5));
            const data = weights.map(w => w.weight);
            if (window.weightChartInstance) window.weightChartInstance.destroy();
            window.weightChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: GN_I18N.t('weight_kg'),
                        data,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16,185,129,0.1)',
                        borderWidth: 3,
                        tension: 0.3,
                        pointRadius: 4,
                        pointBackgroundColor: '#10b981',
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: {
                            grace: '15%',
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#94a3b8', font: { size: 10 } }
                        }
                    }
                }
            });
        }

        function changeMonth(offset) {
            currentViewDate.setMonth(currentViewDate.getMonth() + offset);
            init();
        }

        async function getImg(id, isCustom = false) {
            if (!id) return FALLBACK_IMG;
            const imgTable = isCustom ? db.custom_images : db.catalog_images;
            const imgRecord = await imgTable.get(id);
            return imgRecord ? imgRecord.data : FALLBACK_IMG;
        }

        function renderCalendar(logs) {
            const grid = document.getElementById('calendarGrid');
            const display = document.getElementById('monthDisplay');
            const dayNamesContainer = document.getElementById('dayNames');
            const lang = (window.GN_I18N && GN_I18N.getLang) ? GN_I18N.getLang() : 'en';
            const locale = lang === 'pt' ? 'pt' : 'en';
            // render localized short weekday names; start Monday for Portuguese
            const weekStartsOnMonday = (lang === 'pt');
            dayNamesContainer.innerHTML = '';
            const startIndex = weekStartsOnMonday ? 1 : 0; // 0 = Sunday, 1 = Monday
            for (let i = 0; i < 7; i++) {
                const dayIndex = (startIndex + i) % 7;
                // 2021-01-03 is a Sunday; add offset to get correct weekday
                const d = new Date(2021, 0, 3 + dayIndex);
                const short = d.toLocaleString(locale, { weekday: 'short' });
                dayNamesContainer.innerHTML += `<div class="day-name">${short}</div>`;
            }
            grid.innerHTML = "";
            const year = currentViewDate.getFullYear(), month = currentViewDate.getMonth();
            const today = new Date(); today.setHours(0,0,0,0);
            display.innerText = currentViewDate.toLocaleString(locale, { month: 'long', year: 'numeric' });
            const firstDayIndex = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const workoutDates = new Set(logs.map(l => l.date));

            // Adjust first day index when week starts on Monday
            const adjustedFirstDayIndex = weekStartsOnMonday ? ((firstDayIndex + 6) % 7) : firstDayIndex;
            for (let i = 0; i < adjustedFirstDayIndex; i++) grid.innerHTML += `<div></div>`;
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dateObj = new Date(year, month, d);
                let status = workoutDates.has(dateStr) ? "has-workout" : (dateObj < today ? "past-no-workout" : "future-day");
                if (dateObj.getTime() === today.getTime()) status += " today";
                grid.innerHTML += `<div class="calendar-day ${status}">${d}</div>`;
            }
        }

        async function renderCharts(logs) {
            const wrapper = document.getElementById('chartsWrapper');

            // exercise type localization is provided by GN_I18N.localizeExerciseType
            const [catalogEx, customEx] = await Promise.all([
                db.catalog_exercises.toArray(),
                db.custom_exercises.toArray()
            ]);
            const allExercises = [
                ...catalogEx.map(ex => ({ ...ex, isCustom: false })),
                ...customEx.map(ex => ({ ...ex, isCustom: true }))
            ];
            const exMap = allExercises.reduce((acc, ex) => { acc[`${ex.id}-${!!ex.isCustom}`] = ex; return acc; }, {});

            const groupedByType = {};
            const lineDataLabelsPlugin = {
                id: 'lineDataLabels',
                afterDatasetsDraw(chart) {
                    const { ctx, data } = chart;
                    ctx.save();
                    ctx.font = 'bold 10px sans-serif';
                    ctx.fillStyle = '#94a3b8';
                    ctx.textAlign = 'center';
                    chart.getDatasetMeta(0).data.forEach((point, index) => {
                        const value = data.datasets[0].data[index];
                        ctx.fillText(value, point.x, point.y - 10);
                    });
                    ctx.restore();
                }
            };

            logs.forEach(l => {
                const exKey = `${l.exerciseId}-${l.isCustom !== undefined ? !!l.isCustom : l.exerciseId > 0}`;
                const ex = exMap[exKey];
                const type = ex ? ex.type : 'Other';
                const exId = exKey;
                if (!groupedByType[type]) groupedByType[type] = {};
                if (!groupedByType[type][exId]) groupedByType[type][exId] = [];
                groupedByType[type][exId].push(l);
            });

            wrapper.innerHTML = "";

            for (const type of Object.keys(groupedByType).sort()) {
                const sectionTitle = document.createElement('h3');
                sectionTitle.className = 'section-title';
                sectionTitle.innerText = (window.GN_I18N && typeof GN_I18N.localizeExerciseType === 'function') ? GN_I18N.localizeExerciseType(type) : type;
                wrapper.appendChild(sectionTitle);

                const exercisesInType = groupedByType[type];
                for (const exId of Object.keys(exercisesInType)) {
                    const entries = exercisesInType[exId].sort((a,b) => new Date(a.date) - new Date(b.date));
                    const lastEntry = entries[entries.length - 1];
                    const currentEx = exMap[exId];
                    const lang = (window.GN_I18N && GN_I18N.getLang) ? GN_I18N.getLang() : 'en';
                    const displayName = currentEx ? ((lang === 'pt' && currentEx.namePT) ? currentEx.namePT : currentEx.name) : GN_I18N.t('unknown_exercise');
                    const imgSrc = await getImg(currentEx?.imageId, currentEx?.isCustom);
                    
                    const box = document.createElement('div'); 
                    box.className = 'chart-box';
                    const canvasId = `c-${lastEntry.exerciseId}-${!!lastEntry.isCustom}`.replace(/-/g, '_');
                    
                    box.innerHTML = `
                        <div class="chart-header">
                            <img src="${imgSrc}" class="chart-thumb">
                            <strong>${displayName}</strong>
                        </div>
                        <div class="canvas-wrapper"><canvas id="${canvasId}"></canvas></div>`;
                    wrapper.appendChild(box);

                    new Chart(document.getElementById(canvasId), {
                        type: 'line', 
                        plugins: [lineDataLabelsPlugin],
                        data: { 
                            labels: entries.map(e => e.date.slice(5)), 
                            datasets: [{ 
                                data: entries.map(e => e.weight), 
                                borderColor: '#3b82f6', 
                                borderWidth: 3,
                                tension: 0.4, 
                                fill: true,
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                pointRadius: 4,
                                pointBackgroundColor: '#3b82f6',
                                pointHoverRadius: 6
                            }] 
                        },
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false, 
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { display: false },
                                y: { 
                                    grace: '15%',
                                    grid: { color: 'rgba(255,255,255,0.05)' }, 
                                    ticks: { color: '#94a3b8', font: { size: 10 } } 
                                }
                            }
                        }
                    });
                }
            }
        }

        let frequencyChart = null;
        async function updateFrequencyChart(logs) {
            if (!logs) logs = await db.logs.toArray();
            const period = document.getElementById('frequencyFilter').value;
            const lang = (window.GN_I18N && GN_I18N.getLang) ? GN_I18N.getLang() : 'en';
            const locale = lang === 'pt' ? 'pt' : 'en';
            const uniqueDates = [...new Set(logs.map(l => l.date))].sort();
            const counts = {};
            const today = new Date();

            if (period === 'year') {
                uniqueDates.forEach(d => {
                    const year = d.split('-')[0];
                    counts[year] = (counts[year] || 0) + 1;
                });
            } else if (period === 'month') {
                const currentYear = today.getFullYear();
                for (let i = 0; i < 12; i++) {
                    const monthName = new Date(currentYear, i, 1).toLocaleString(locale, { month: 'short' });
                    counts[monthName] = 0;
                }
                uniqueDates.forEach(d => {
                    const [y, m, day] = d.split('-').map(Number);
                    if (y === currentYear) {
                        const monthName = new Date(y, m - 1, day).toLocaleString(locale, { month: 'short' });
                        if (counts.hasOwnProperty(monthName)) counts[monthName]++;
                    }
                });
            }

            const ctx = document.getElementById('frequencyChart').getContext('2d');
            if (frequencyChart) frequencyChart.destroy();

            const barDataLabelsPlugin = {
                id: 'barDataLabels',
                afterDatasetsDraw(chart) {
                    const { ctx } = chart;
                    ctx.save();
                    ctx.font = 'bold 10px sans-serif';
                    ctx.fillStyle = '#94a3b8';
                    ctx.textAlign = 'center';
                    chart.data.datasets.forEach((dataset, i) => {
                        chart.getDatasetMeta(i).data.forEach((bar, index) => {
                            const value = dataset.data[index];
                            if (value > 0) ctx.fillText(value, bar.x, bar.y - 5);
                        });
                    });
                    ctx.restore();
                }
            };

            frequencyChart = new Chart(ctx, {
                type: 'bar',
                plugins: [barDataLabelsPlugin],
                data: {
                    labels: Object.keys(counts),
                    datasets: [{
                        data: Object.values(counts),
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderRadius: 8,
                        hoverBackgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grace: '15%', ticks: { stepSize: 1, color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                    }
                }
            });
        }

        async function updateStreakBadge() {
            const overview = document.getElementById('stats-overview');
            
            // Ensure DB is open (iOS fix)
            await ensureDbOpen();
            
            const allLogs = await db.logs.toArray();
            const workoutDates = [...new Set(allLogs.map(l => l.date))].sort();
            
            if (workoutDates.length === 0) {
                overview.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-label">${GN_I18N.t('current_streak')}</div>
                        <div class="stat-value">0 <span style="font-size: 0.9rem">${GN_I18N.t('days')}</span></div>
                        <div class="stat-sub">${GN_I18N.t('start_your_journey')}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">${GN_I18N.t('best_record')}</div>
                        <div class="stat-value">0 <span style="font-size: 0.9rem">${GN_I18N.t('days')}</span></div>
                        <div class="stat-sub">${GN_I18N.t('no_records_yet')}</div>
                    </div>
                `;
                return;
            }

            const streaks = calculateStreaks(workoutDates);
            const { current, longest, daysSince } = streaks;

            overview.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">${GN_I18N.t('current_streak')}</div>
                    <div class="stat-value" style="color: ${current > 0 ? 'var(--success)' : 'var(--text)'}">
                        ${current} <span style="font-size: 0.9rem">${GN_I18N.t('days')}</span>
                    </div>
                    <div class="stat-sub">${current > 0 ? GN_I18N.t('keep_it_up') : (daysSince + ' ' + GN_I18N.t('days_since_last'))}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">${GN_I18N.t('best_record')}</div>
                    <div class="stat-value">${longest} <span style="font-size: 0.9rem">${GN_I18N.t('days')}</span></div>
                    <div class="stat-sub">${GN_I18N.t('personal_best')}</div>
                </div>
            `;
        }

        // Apply translations and localized title, then initialize
        if (window.GN_I18N) {
            try { GN_I18N.applyTranslations(document); } catch(e){}
            try { document.title = GN_I18N.t('title_main') + ' | ' + GN_I18N.t('page_statistics'); } catch(e){}
        }

        init();
    </script>
</body>
</html>
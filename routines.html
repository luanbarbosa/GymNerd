<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GymNerd | Routines</title>
    <link rel="icon" type="image/svg+xml" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <script src="auth.js"></script>
    <script src="drive-storage.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="db.js"></script>
    <style>
        :root { --primary: #3b82f6; --primary-grad: linear-gradient(135deg, #60a5fa 0%, #2563eb 100%); --secondary-grad: linear-gradient(135deg, #D1D5DB 0%, #9CA3AF 100%); --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --text-dim: #94a3b8; --success: #10b981; --danger: #ef4444; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); max-width: 500px; margin: 0 auto; padding: 20px; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .header h2 { font-weight: 800; letter-spacing: -0.5px; background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; }
        .back-btn { text-decoration: none; font-size: 1.5rem; color: var(--text); }
        .card { background: var(--card); padding: 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px; }
        .input-group { display: flex; flex-direction: column; gap: 10px; }
        input, button { padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); font-size: 1rem; background: rgba(255,255,255,0.05); color: white; }
        
        button.primary { background: var(--primary-grad); color: white; border: none; font-weight: bold; cursor: pointer; }
        button.update { background: var(--success); color: white; border: none; font-weight: bold; cursor: pointer; display: none; }
        .cancel-link { text-align: center; font-size: 0.8rem; color: #ef4444; cursor: pointer; display: none; margin-top: 5px; text-decoration: underline; }

        /* Search Modal Styles */
        .modal { position: fixed; top: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 500px; height: 100%; background: var(--bg); z-index: 1000; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .modal-sub { z-index: 1100; }
        .form-group { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        .form-group label { font-size: 0.75rem; font-weight: 800; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em; }
        .form-group input, .form-group select { padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: var(--card); color: white; font-size: 1rem; outline: none; }
        .image-preview-box { width: 100%; height: 200px; background: var(--card); border: 2px dashed rgba(255,255,255,0.1); border-radius: 16px; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; }
        .save-btn { background: var(--primary-grad); color: white; border: none; padding: 16px; border-radius: 16px; font-weight: 800; font-size: 1.1rem; cursor: pointer; margin-top: 10px; box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2); }
        .category-section { background: var(--card); border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); overflow: hidden; margin-bottom: 12px; }
        .category-summary { padding: 16px 20px; cursor: pointer; list-style: none; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; font-weight: 800; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.1em; }
        .category-summary::-webkit-details-marker { display: none; }
        .category-summary .chevron { transition: transform 0.2s; color: var(--text-dim); }
        .category-section[open] .category-summary .chevron { transform: rotate(180deg); }
        .exercise-grid { display: grid; gap: 12px; padding: 0 12px 16px 12px; }
        
        .exercise-card { background: var(--card); border-radius: 16px; padding: 12px; display: flex; align-items: center; gap: 16px; border: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: transform 0.2s; }
        .exercise-card:active { transform: scale(0.98); }
        .exercise-info { flex-grow: 1; }
        .exercise-name { font-weight: 700; font-size: 1rem; margin: 0; }
        .exercise-name-pt { font-size: 0.85rem; color: var(--text-dim); margin-top: 2px; }
        .copy-btn { background: none; border: none; color: var(--text-dim); cursor: pointer; padding: 8px; display: flex; align-items: center; justify-content: center; transition: color 0.2s; }
        .copy-btn:hover { color: var(--primary); }

        .custom-badge {
            font-size: 0.6rem;
            background: rgba(59, 130, 246, 0.15);
            color: var(--primary);
            padding: 2px 6px;
            border-radius: 6px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border: 1px solid rgba(59, 130, 246, 0.3);
            display: inline-block;
            margin-top: 4px;
        }

        .selected-ex-list { margin: 15px 0; display: flex; flex-direction: column; gap: 10px; }
        .selected-ex-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; }
        .selected-ex-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .selected-ex-title { font-weight: 700; font-size: 0.95rem; }

        .set-row-input { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; }
        .set-row-input input { width: 70px; padding: 8px; font-size: 0.8rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: #000; }
        .add-set-btn { background: rgba(255,255,255,0.05); border: 1px dashed rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; cursor: pointer; color: var(--text-dim); margin-bottom: 10px; }
        .remove-set-btn { background: none; border: none; color: #ef4444; cursor: pointer; font-size: 1rem; padding: 0 5px; }
        .ex-thumb { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; background: #000; flex-shrink: 0; }

        .hidden { display: none !important; }
        .workout-card { background: var(--card); padding: 20px; border-radius: 16px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05); }
        .workout-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .workout-name { font-weight: 800; font-size: 1.2rem; color: var(--primary); }
        .exercise-tag { display: block; background: rgba(255,255,255,0.03); padding: 12px; border-radius: 12px; font-size: 0.85rem; margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.05); }
        
        .set-pills { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
        .set-pill { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 3px 8px; border-radius: 6px; font-size: 0.7rem; color: var(--text-dim); font-weight: 600; }
        
        .actions { display: flex; gap: 12px; }
        .edit-btn { color: var(--primary); background: rgba(255,255,255,0.05); border: none; cursor: pointer; display: flex; align-items: center; padding: 10px; border-radius: 10px; transition: background 0.2s; }
        .del-btn { color: var(--danger); background: rgba(255,255,255,0.05); border: none; cursor: pointer; display: flex; align-items: center; padding: 10px; border-radius: 10px; transition: background 0.2s; }

        .section-title { margin-top: 40px; margin-bottom: 20px; font-weight: 800; font-size: 1.5rem; letter-spacing: -0.5px; padding-left: 5px; background: var(--secondary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; width: fit-content; }
    </style>
</head>
<body>
    <div class="header"><a href="index.html" class="back-btn">‚Üê</a><h2>My Workouts</h2></div>

    <div class="card">
        <div class="input-group">
            <label style="font-size:0.8rem; font-weight:bold">Workout Name</label>
            <input type="text" id="workoutName" placeholder="e.g. Leg Day">
            <input type="hidden" id="editId">
            
            <label style="font-size:0.8rem; font-weight:bold; margin-top: 10px;">Routine Exercises</label>
            <button type="button" class="add-set-btn" style="width: 100%; padding: 14px; font-size: 1rem; margin-top: 5px; border-style: solid; background: rgba(255,255,255,0.05);" onclick="openSearchModal()">üîç Add Exercise</button>
    <div id="searchModal" class="modal hidden">
        <div class="header">
            <button class="back-btn" onclick="closeSearchModal()">‚Üê</button>
            <h2>Add Exercise</h2>
        </div>
        <div class="input-group">
            <button type="button" class="add-set-btn" style="border-style: solid; background: var(--card); color: var(--primary); font-weight: 800; margin-bottom: 10px;" onclick="openCreateModal()">‚ûï Create Custom Exercise</button>
            <input type="text" id="modalSearchInput" placeholder="Search by name..." oninput="updateModalResults()">
        </div>
        <div id="modalResults" class="exercise-list" style="margin-top: 10px;"></div>
    </div>

    <div id="customExModal" class="modal modal-sub hidden">
        <div class="header">
            <button class="back-btn" onclick="closeCustomModal()">‚Üê</button>
            <h2 id="customModalTitle">Custom Exercise</h2>
        </div>
        <div class="form-group">
            <input type="hidden" id="exId">
            <label>Name</label>
            <input type="text" id="exName" placeholder="e.g. Bench Press">
            <label>Name (Portuguese)</label>
            <input type="text" id="exNamePT" placeholder="e.g. Supino Reto">
            <label>Type</label>
            <select id="exType">
                <option value="chest">Chest</option><option value="leg">Legs</option><option value="back">Back</option><option value="shoulder">Shoulders</option><option value="arm">Arms</option>
            </select>
            <label>Image</label>
            <input type="file" id="exImageInput" accept="image/*" onchange="handleImageUpload(event)" style="display:none">
            <div class="image-preview-box" onclick="document.getElementById('exImageInput').click()">
                <img id="exImagePreview" src="" class="hidden" style="width: 100%; height: 100%; object-fit: cover;">
                <div id="uploadPlaceholder">üì∏ Tap to upload</div>
            </div>
            <button class="save-btn" onclick="saveCustomExercise()">Save Exercise</button>
        </div>
    </div>

            <div id="selectedList" class="selected-ex-list"></div>
            
            <button id="addBtn" class="primary" onclick="saveWorkout()">Create Workout</button>
            <button id="updateBtn" class="update" onclick="updateWorkout()">Update Workout</button>
            <div id="cancelEdit" class="cancel-link" onclick="resetForm()">Cancel Editing</div>
        </div>
    </div>

    <h3 class="section-title">Workouts</h3>
    <div id="workout-list"></div>

    <script>

        let allExercises = [];
        let images = {};
        let currentImageData = null;

        async function init() {
            try {
                await ensureDbOpen();

                const EXERCISES_URL = 'https://raw.githubusercontent.com/luanbarbosa/GymNerd/refs/heads/feature/catalog/catalog/exercises.json';
                const IMAGES_URL = 'https://raw.githubusercontent.com/luanbarbosa/GymNerd/refs/heads/feature/catalog/catalog/images.json';

                const [exRes, imgRes, localEx, localImgs] = await Promise.all([
                    fetch(EXERCISES_URL),
                    fetch(IMAGES_URL),
                    db.exercises.toArray(),
                    db.images.toArray()
                ]);
                
                const remoteCatalog = await exRes.json();
                const rawRemoteImages = await imgRes.json();
                
                // Map remote images by ID
                images = rawRemoteImages.reduce((acc, img) => {
                    acc[img.id] = img.data;
                    return acc;
                }, {});

                // Merge local images
                localImgs.forEach(img => {
                    images[img.id] = img.data;
                });

                // Combine remote and local exercises
                allExercises = [
                    ...remoteCatalog, 
                    ...localEx.map(ex => ({ ...ex, isCustom: true }))
                ];

                renderWorkouts();
                updateModalResults();
            } catch (err) {
                console.error("Failed to load exercises:", err);
            }
        }

        function openSearchModal() {
            document.getElementById('searchModal').classList.remove('hidden');
            updateModalResults();
        }

        function closeSearchModal() {
            document.getElementById('searchModal').classList.add('hidden');
        }

        function updateModalResults() {
            const query = document.getElementById('modalSearchInput').value.toLowerCase();
            const resultsDiv = document.getElementById('modalResults');
            const forceOpen = query.length > 0;
            
            const filtered = allExercises.filter(ex => 
                ex.name.toLowerCase().includes(query) ||
                (ex.namePT && ex.namePT.toLowerCase().includes(query))
            );

            if (filtered.length === 0) {
                resultsDiv.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-dim)">No exercises found</div>';
                return;
            }

            const groups = filtered.reduce((acc, ex) => {
                if (!acc[ex.type]) acc[ex.type] = [];
                acc[ex.type].push(ex);
                return acc;
            }, {});

            resultsDiv.innerHTML = Object.keys(groups).sort().map(type => `
                <details class="category-section" ${forceOpen ? 'open' : ''}>
                    <summary class="category-summary">
                        <span>${type}</span>
                        <svg class="chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </summary>
                    <div class="exercise-grid">
                        ${groups[type].map(ex => `
                            <div class="exercise-card" onclick="addExerciseToRoutine(${ex.id}, [], ${!!ex.isCustom}); closeSearchModal();">
                                <img src="${images[ex.imageId] || ''}" class="ex-thumb" style="width: 50px; height: 50px;">
                                <div class="exercise-info">
                                    <div class="exercise-name">${ex.name}</div>
                                    ${ex.isCustom ? `<span class="custom-badge">Custom</span>` : ''}
                                    ${ex.namePT ? `<div class="exercise-name-pt">${ex.namePT}</div>` : ''}
                                </div>
                                <div class="actions" onclick="event.stopPropagation()" style="display: flex; gap: 4px;">
                                    ${ex.isCustom ? `
                                        <button class="copy-btn" onclick="editExercise(${ex.id})" title="Edit">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                        </button>
                                    ` : ''}
                                    <button class="copy-btn" onclick="copyExercise(${ex.id}, ${!!ex.isCustom})" title="Copy">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </details>
            `).join('');
        }

        function openCreateModal() {
            document.getElementById('customModalTitle').innerText = "Custom Exercise";
            document.getElementById('exId').value = '';
            document.getElementById('exName').value = '';
            document.getElementById('exNamePT').value = '';
            document.getElementById('exType').selectedIndex = 0;
            currentImageData = null;
            document.getElementById('exImagePreview').classList.add('hidden');
            document.getElementById('uploadPlaceholder').classList.remove('hidden');
            document.getElementById('customExModal').classList.remove('hidden');
        }

        function closeCustomModal() {
            document.getElementById('customExModal').classList.add('hidden');
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 400;
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    currentImageData = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById('exImagePreview').src = currentImageData;
                    document.getElementById('exImagePreview').classList.remove('hidden');
                    document.getElementById('uploadPlaceholder').classList.add('hidden');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function copyExercise(exId, isCustom = false) {
            const ex = allExercises.find(e => e.id === exId && !!e.isCustom === !!isCustom);
            if (!ex) return;
            document.getElementById('exId').value = '';
            document.getElementById('exName').value = ex.name;
            document.getElementById('exNamePT').value = ex.namePT || '';
            document.getElementById('exType').value = ex.type;
            const imgData = images[ex.imageId];
            if (imgData) {
                currentImageData = imgData;
                document.getElementById('exImagePreview').src = imgData;
                document.getElementById('exImagePreview').classList.remove('hidden');
                document.getElementById('uploadPlaceholder').classList.add('hidden');
            } else {
                currentImageData = null;
                document.getElementById('exImagePreview').classList.add('hidden');
                document.getElementById('uploadPlaceholder').classList.remove('hidden');
            }
            document.getElementById('customModalTitle').innerText = "Copy Exercise";
            document.getElementById('customExModal').classList.remove('hidden');
        }

        async function editExercise(exId) {
            const ex = allExercises.find(e => e.id === exId && e.isCustom);
            if (!ex) return;
            document.getElementById('exId').value = ex.id;
            document.getElementById('exName').value = ex.name;
            document.getElementById('exNamePT').value = ex.namePT || '';
            document.getElementById('exType').value = ex.type;
            const imgData = images[ex.imageId];
            if (imgData) {
                currentImageData = imgData;
                document.getElementById('exImagePreview').src = imgData;
                document.getElementById('exImagePreview').classList.remove('hidden');
                document.getElementById('uploadPlaceholder').classList.add('hidden');
            } else {
                currentImageData = null;
                document.getElementById('exImagePreview').classList.add('hidden');
                document.getElementById('uploadPlaceholder').classList.remove('hidden');
            }
            document.getElementById('customModalTitle').innerText = "Edit Exercise";
            document.getElementById('customExModal').classList.remove('hidden');
        }

        async function saveCustomExercise() {
            const id = document.getElementById('exId').value;
            const name = document.getElementById('exName').value.trim();
            const namePT = document.getElementById('exNamePT').value.trim();
            const type = document.getElementById('exType').value;
            if (!name) { alert("Please enter a name for the exercise."); return; }
            try {
                await ensureDbOpen();
                let imageId = 0;
                if (currentImageData) {
                    imageId = Date.now();
                    await db.images.put({ id: imageId, data: currentImageData });
                }
                const exerciseData = { name, namePT, type, imageId };
                if (id) {
                    await db.exercises.update(parseInt(id), exerciseData);
                    alert("Exercise updated!");
                } else {
                    await db.exercises.add(exerciseData);
                    alert("Exercise saved to your local collection!");
                }
                localStorage.setItem('has_local_changes', 'true');
                closeCustomModal();
                await init(); 
            } catch (err) {
                console.error("Error saving custom exercise:", err);
                alert("Failed to save exercise: " + err.message);
            }
        }

        function addExerciseToRoutine(exId, sets = [], isCustom = false) {
            const ex = allExercises.find(e => e.id === exId && !!e.isCustom === !!isCustom);
            if (!ex) return;

            const container = document.getElementById('selectedList');
            const card = document.createElement('div');
            card.className = 'selected-ex-card';
            card.dataset.id = exId;
            card.dataset.isCustom = isCustom;
            
            card.innerHTML = `
                <div class="selected-ex-header">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <img src="${images[ex.imageId] || ''}" class="ex-thumb">
                        <span class="selected-ex-title">${ex.name}</span>
                    </div>
                    <button type="button" class="remove-set-btn" onclick="this.closest('.selected-ex-card').remove()">√ó</button>
                </div>
                <div class="sets-container"></div>
                <button type="button" class="add-set-btn" onclick="addSetRowToCard(this)">+ Add Set</button>
            `;
            container.appendChild(card);

            const setsContainer = card.querySelector('.sets-container');
            if (sets.length > 0) {
                sets.forEach((s, i) => addSetRowToContainer(setsContainer, i + 1, s.reps, s.weight));
            } else {
                addSetRowToContainer(setsContainer, 1);
            }
        }

        function addSetRowToCard(btn) {
            const container = btn.previousElementSibling;
            const nextNum = container.children.length + 1;
            addSetRowToContainer(container, nextNum);
        }

        function addSetRowToContainer(container, num, reps = "", weight = "") {
            if (reps === "" && weight === "" && container.lastElementChild) {
                reps = container.lastElementChild.querySelector('.set-reps').value;
                weight = container.lastElementChild.querySelector('.set-weight').value;
            }

            const div = document.createElement('div');
            div.className = 'set-row-input';
            div.innerHTML = `
                <span style="font-size:0.7rem; color:#64748b; width:20px">S${num}</span>
                <input type="number" placeholder="Reps" class="set-reps" value="${reps}">
                <input type="number" step="0.5" placeholder="Kg" class="set-weight" value="${weight}">
                <button type="button" class="remove-set-btn" onclick="removeSetRow(this)">√ó</button>
            `;
            container.appendChild(div);
        }

        function removeSetRow(btn) {
            const container = btn.parentElement.parentElement;
            btn.parentElement.remove();
            Array.from(container.children).forEach((row, i) => {
                row.querySelector('span').innerText = `S${i + 1}`;
            });
        }

        function getSelectedExercisesData() {
            return Array.from(document.querySelectorAll('.selected-ex-card')).map(card => {
                const id = parseInt(card.dataset.id);
                const isCustom = card.dataset.isCustom === 'true';
                const sets = Array.from(card.querySelectorAll('.set-row-input')).map(row => ({
                    reps: parseInt(row.querySelector('.set-reps').value) || 0,
                    weight: parseFloat(row.querySelector('.set-weight').value) || 0
                }));
                return { id, sets, isCustom };
            });
        }

        async function saveWorkout() {
            const name = document.getElementById('workoutName').value;
            const exerciseIds = getSelectedExercisesData();
            if (!name || exerciseIds.length === 0) return alert("Missing name or exercises for the routine");
            await db.routines.add({ name, exerciseIds });
            localStorage.setItem('has_local_changes', 'true');
            resetForm();
            renderWorkouts();
        }

        async function prepareEdit(id) {
            const workout = await db.routines.get(id);
            if (!workout) return;

            document.getElementById('workoutName').value = workout.name;
            document.getElementById('editId').value = id;
            
            const container = document.getElementById('selectedList');
            container.innerHTML = "";

            for (const item of workout.exerciseIds) {
                const exId = typeof item === 'object' ? item.id : item;
                const isCustom = typeof item === 'object' ? !!item.isCustom : false;
                let sets = [];
                if (typeof item === 'object') {
                    if (Array.isArray(item.sets)) {
                        sets = item.sets;
                    } else {
                        for(let i=0; i<(item.sets||3); i++) sets.push({reps: item.reps, weight: item.weight});
                    }
                }
                addExerciseToRoutine(exId, sets, isCustom);
            }

            // UI Changes
            document.getElementById('addBtn').style.display = 'none';
            document.getElementById('updateBtn').style.display = 'block';
            document.getElementById('cancelEdit').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function updateWorkout() {
            const id = parseInt(document.getElementById('editId').value);
            const name = document.getElementById('workoutName').value;
            const exerciseIds = getSelectedExercisesData();

            if (!name || exerciseIds.length === 0) return alert("Missing name or exercises for the routine");

            await db.routines.update(id, { name, exerciseIds });
            localStorage.setItem('has_local_changes', 'true');
            resetForm();
            renderWorkouts();
        }

        function resetForm() {
            document.getElementById('workoutName').value = "";
            document.getElementById('editId').value = "";
            document.getElementById('selectedList').innerHTML = "";
            document.getElementById('addBtn').style.display = 'block';
            document.getElementById('updateBtn').style.display = 'none';
            document.getElementById('cancelEdit').style.display = 'none';
        }

        async function renderWorkouts() {
            const workouts = await db.routines.toArray();
            const container = document.getElementById('workout-list');
            container.innerHTML = workouts.map(w => {
                const tags = w.exerciseIds.map(item => {
                    const id = typeof item === 'object' ? item.id : item;
                    const isCustom = typeof item === 'object' ? !!item.isCustom : false;
                    const ex = allExercises.find(e => e.id === id && !!e.isCustom === isCustom);
                    if (!ex) return "";

                    let setsHtml = '';
                    if (typeof item === 'object' && Array.isArray(item.sets)) {
                        setsHtml = `<div class="set-pills">` + 
                            item.sets.map(s => `<span class="set-pill">${s.reps} √ó ${s.weight}kg</span>`).join('') + 
                            `</div>`;
                    } else if (typeof item === 'object') {
                        // Fallback for old structure
                        setsHtml = `<div class="set-pills"><span class="set-pill">${item.sets} sets √ó ${item.reps} √ó ${item.weight}kg</span></div>`;
                    }

                    return `<div class="exercise-tag">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                            <img src="${images[ex.imageId] || ''}" class="ex-thumb" style="width: 30px; height: 30px;">
                            <strong>${ex.name}</strong>
                        </div>
                        ${setsHtml}
                    </div>`;
                }).join('');

                return `
                    <div class="workout-card">
                        <div class="workout-header">
                            <span class="workout-name">${w.name}</span>
                            <div class="actions">
                                <button class="edit-btn" onclick="prepareEdit(${w.id})" title="Edit">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                                </button>
                                <button class="del-btn" onclick="deleteWorkout(${w.id})" title="Delete">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                </button>
                            </div>
                        </div>
                        <div>${tags}</div>
                    </div>
                `;
            }).join('');
        }

        async function deleteWorkout(id) {
            if(confirm("Delete routine?")) { await db.routines.delete(id); localStorage.setItem('has_local_changes', 'true'); renderWorkouts(); }
        }

        init();
    </script>
</body>
</html>
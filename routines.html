<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GymNerd | Rotinas</title>
    <link rel="icon" type="image/svg+xml" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <script src="auth.js"></script>
    <script src="gn-i18n.js"></script>
    <script src="drive-storage.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="db.js"></script>
    <style>
        :root { --primary: #3b82f6; --primary-grad: linear-gradient(135deg, #60a5fa 0%, #2563eb 100%); --secondary-grad: linear-gradient(135deg, #D1D5DB 0%, #9CA3AF 100%); --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --text-dim: #94a3b8; --success: #10b981; --danger: #ef4444; --header-height: 56px; --tabs-height: 64px; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); max-width: 500px; margin: 0 auto; padding: 20px; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .header { display: flex; align-items: center; gap: 15px; margin-bottom: 6px; position: sticky; top: 0; z-index: 1200; height: var(--header-height); padding: 8px 12px; backdrop-filter: blur(6px); background: linear-gradient(180deg, rgba(15,23,42,0.95), rgba(15,23,42,0.88)); }
        .header h2 { font-weight: 800; letter-spacing: -0.5px; background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; }
        .back-btn { text-decoration: none; font-size: 1.5rem; color: var(--text); }
        .card { background: var(--card); padding: 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px; }
        .input-group { display: flex; flex-direction: column; gap: 10px; }
        input, button { padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); font-size: 1rem; background: rgba(255,255,255,0.05); color: white; }
        
        button.primary { background: var(--primary-grad); color: white; border: none; font-weight: bold; cursor: pointer; }
        button.update { background: var(--success); color: white; border: none; font-weight: bold; cursor: pointer; display: none; }
        .cancel-link { text-align: center; font-size: 0.8rem; color: #ef4444; cursor: pointer; display: none; margin-top: 5px; text-decoration: underline; }

        /* Search Modal Styles */
        .modal { position: fixed; top: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 500px; height: 100%; background: var(--bg); z-index: 1000; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .modal-sub { z-index: 1100; }
        .form-group { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        .form-group label { font-size: 0.75rem; font-weight: 800; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em; }
        .form-group input, .form-group select { padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: var(--card); color: white; font-size: 1rem; outline: none; }
        .image-preview-box { width: 100%; height: 200px; background: #fff; border: 2px dashed rgba(0,0,0,0.08); border-radius: 16px; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; }
        .save-btn { background: var(--primary-grad); color: white; border: none; padding: 16px; border-radius: 16px; font-weight: 800; font-size: 1.1rem; cursor: pointer; margin-top: 10px; box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2); }
        .category-section { background: var(--card); border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); overflow: hidden; margin-bottom: 12px; }
        .category-summary { padding: 16px 20px; cursor: pointer; list-style: none; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; font-weight: 800; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.1em; }
        .category-summary::-webkit-details-marker { display: none; }
        .category-summary .chevron { transition: transform 0.2s; color: var(--text-dim); }
        .category-section[open] .category-summary .chevron { transform: rotate(180deg); }
        .exercise-grid { display: grid; gap: 12px; padding: 0 12px 16px 12px; }
        .exercise-grid .ex-thumb { width: 72px; height: 48px; border-radius: 10px; object-fit: contain; object-position: center; background: #fff; }
        .exercise-card { background: var(--card); border-radius: 16px; padding: 12px; display: flex; align-items: center; gap: 16px; border: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: transform 0.2s; }
        .exercise-card:active { transform: scale(0.98); }
        .exercise-card { position: relative; }
        .exercise-card.selected { outline: 3px solid rgba(59,130,246,0.9); background: rgba(59,130,246,0.08); }
        .select-mode .exercise-card { cursor: pointer; }

        /* Select bar styles */
        #selectBar.hidden { display: none; }
        #selectBar { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:12px; background: rgba(255,255,255,0.02); padding: 8px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.04); }
        #selectCount { color: var(--text); font-weight: 800; }
        #addSelectedBtn { background: var(--success); color: white; border: none; padding: 10px 14px; border-radius: 10px; font-weight: 800; cursor: pointer; min-width: 120px; }
        #addSelectedBtn:disabled { opacity: 0.6; cursor: not-allowed; }
        #cancelSelectBtn { background: transparent; border: 1px solid rgba(255,255,255,0.06); color: var(--text-dim); padding: 10px 14px; border-radius: 10px; font-weight: 700; cursor: pointer; }

        /* Badge inside selected cards */
        .select-badge { display: none; position: absolute; top: 50%; right: -14px; transform: translateY(-50%); width: 28px; height: 28px; border-radius: 8px; background: var(--primary); color: #fff; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 800; box-shadow: 0 6px 18px rgba(0,0,0,0.25); z-index: 1000; }
        .exercise-card { overflow: visible; }
        .exercise-card .actions { position: relative; z-index: 2; }
        .exercise-card.selected .select-badge { display: flex; }
        .exercise-info { flex-grow: 1; }
        .exercise-name { font-weight: 700; font-size: 1rem; margin: 0; }
        .exercise-name-pt { font-size: 0.85rem; color: var(--text-dim); margin-top: 2px; }
        .copy-btn { background: none; border: none; color: var(--text-dim); cursor: pointer; padding: 8px; display: flex; align-items: center; justify-content: center; transition: color 0.2s; }
        .copy-btn:hover { color: var(--primary); }

        .custom-badge {
            font-size: 0.6rem;
            background: rgba(59, 130, 246, 0.15);
            color: var(--primary);
            padding: 2px 6px;
            border-radius: 6px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border: 1px solid rgba(59, 130, 246, 0.3);
            display: inline-block;
            margin-top: 4px;
        }

        .selected-ex-list { margin: 15px 0; display: flex; flex-direction: column; gap: 10px; }
        .selected-ex-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; }
        .selected-ex-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .selected-ex-title { font-weight: 700; font-size: 0.95rem; }

        .set-row-input { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; }
        .set-row-input input { width: 70px; padding: 8px; font-size: 0.8rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: #000; }
        .add-set-btn { background: rgba(255,255,255,0.05); border: 1px dashed rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; cursor: pointer; color: var(--text-dim); margin-bottom: 10px; }
        .remove-set-btn { background: none; border: none; color: #ef4444; cursor: pointer; font-size: 1rem; padding: 0 5px; }
        .ex-thumb { width: 64px; height: 44px; border-radius: 8px; object-fit: contain; object-position: center; background: #fff; flex-shrink: 0; }
        /* Keep preview images on white background when they have transparency */
        .image-preview-box img { background: #fff; }

        .hidden { display: none !important; }
        .workout-card { background: transparent; padding: 10px 0; border-radius: 16px; margin-bottom: 15px; border: none; }
        .workout-header { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 10px; }
        .workout-name { font-weight: 800; font-size: 1.2rem; color: var(--primary); }
        /* Stack image, title and sets vertically inside the main area; drag handle sits at the right */
        .exercise-tag { display: flex; align-items: stretch; gap: 12px; background: rgba(255,255,255,0.02); padding: 14px; border-radius: 12px; font-size: 0.95rem; margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.04); box-shadow: none; transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease; }
        .exercise-tag:hover { transform: translateY(-3px); }
        .exercise-tag .main { flex: 1 1 auto; display:flex; flex-direction:column; gap:8px; }
        .exercise-tag .ex-thumb { width: 100%; height: 110px; border-radius: 10px; object-fit: contain; object-position: center; background: #fff; }
        .exercise-tag .exercise-title { font-weight:700; font-size: 1rem; color: var(--text); margin: 0; }
        /* New card layout: preview square + meta column + sets table */
        .ex-preview-square { width:72px; height:72px; border-radius:8px; object-fit:cover; object-position:center; background:#fff; flex-shrink:0; }
        .exercise-row { display:flex; gap:12px; align-items:center; }
        .exercise-meta { display:flex; flex-direction:column; gap:4px; }
        .exercise-type { font-size:0.8rem; color:var(--text-dim); font-weight:700; text-transform:capitalize; }
        .sets-table { width:100%; border-collapse:collapse; margin-top:8px; }
        .sets-table th, .sets-table td { text-align:left; padding:6px 8px; font-size:0.85rem; color:var(--text-dim); border-bottom:1px solid rgba(255,255,255,0.03); }
        .sets-table th { color:var(--text-dim); font-weight:800; font-size:0.7rem; text-transform:uppercase; letter-spacing:0.04em; }
        .set-pills { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 5px; justify-content: flex-start; }
        .set-pill { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 8px; font-size: 0.75rem; color: var(--text-dim); font-weight: 700; }
        /* Drag handle hidden by default; shown when the list is in sorting mode */
        .exercise-tag .drag-handle { display: none; pointer-events: none; font-size: 1.1rem; color: rgba(148,163,184,0.9); padding: 8px; border-radius: 8px; cursor: grab; user-select: none; touch-action: none; background: rgba(255,255,255,0.02); align-self: center; }
        #exerciseList.sorting .exercise-tag .drag-handle { display: inline-flex; pointer-events: auto; }
        .exercise-tag .drag-handle:active { cursor: grabbing; }

        .sort-btn { color: var(--text-dim); background: rgba(255,255,255,0.02); border: none; cursor: pointer; display: flex; align-items: center; padding: 8px; border-radius: 10px; transition: background 0.12s; }
        .sort-btn.active { background: var(--primary); color: #fff; box-shadow: 0 6px 18px rgba(59,130,246,0.12); }
        .draggable.dragging { opacity: 0.85; transform: scale(0.98); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .draggable { user-select: none; }
        .drop-placeholder { border: 2px dashed rgba(148,163,184,0.25); margin: 6px 0; border-radius: 12px; background: rgba(255,255,255,0.01); }
        .drag-ghost { position: fixed; z-index: 9999; pointer-events: none; transform: translate(-50%,-50%) scale(0.98); opacity: 0.95; transition: transform 0.08s ease; width: auto; max-width: 90%; box-shadow: 0 12px 30px rgba(0,0,0,0.5); border-radius: 12px; }
        /* Drop indicator */
        .exercise-tag.drop-target { border-top: 3px solid rgba(59,130,246,0.9); box-shadow: none; }
        .exercise-list-drop-bottom { box-shadow: inset 0 -3px 0 rgba(59,130,246,0.9); border-radius: 12px; }


        .set-pills { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; justify-content: flex-start; }
        .set-pill { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 3px 8px; border-radius: 6px; font-size: 0.7rem; color: var(--text-dim); font-weight: 600; }
        
        .actions { display: flex; gap: 12px; }
        .edit-btn { color: var(--primary); background: rgba(255,255,255,0.05); border: none; cursor: pointer; display: flex; align-items: center; padding: 10px; border-radius: 10px; transition: background 0.2s; }
        .del-btn { color: var(--danger); background: rgba(255,255,255,0.05); border: none; cursor: pointer; display: flex; align-items: center; padding: 10px; border-radius: 10px; transition: background 0.2s; }

        .section-title { margin-top: 40px; margin-bottom: 20px; font-weight: 800; font-size: 1.5rem; letter-spacing: -0.5px; padding-left: 5px; background: var(--secondary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; width: fit-content; }
        /* Tabs - mobile segmented control style */
        #tabsWrapper { position: sticky; top: var(--header-height); z-index: 1150; }
        #routines-tabs { display:flex; gap:6px; flex-wrap:nowrap; justify-content:flex-start; align-items:center; padding:8px 12px; background: rgba(255,255,255,0.02); border-radius: 14px; margin: 0 0; overflow-x:auto; -webkit-overflow-scrolling:touch; }
        .tab-btn { padding: 10px 14px; border-radius: 10px; background: transparent; border: none; color: var(--text-dim); cursor: pointer; font-weight:800; min-width:72px; text-align:center; font-size:0.95rem; }
        .tab-btn:focus { outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0.08); border-radius:10px; }
        .tab-btn.active { background: var(--primary); color: #fff; box-shadow: 0 6px 18px rgba(59,130,246,0.12); }
        .tab-card { background: transparent; padding: 12px; border-radius: 12px; border: none; }
        /* Make routines content the scrollable area so header and tabs stay fixed */
        #routines-content { height: calc(100vh - var(--header-height) - var(--tabs-height)); overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 6px 12px 24px; box-sizing: border-box; }
    </style>
</head>
<body>
    <div class="header" style="justify-content:space-between; align-items:center;">
        <div style="display:flex; align-items:center; gap:15px;">
            <a href="index.html" class="back-btn">←</a>
            <h2 data-i18n="page_routines">Rotinas</h2>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
            <button id="newRoutineBtn" class="primary" style="padding:10px 14px; font-size:0.9rem;" onclick="window.location.href='routinecrud.html'">+ Nova Rotina</button>
        </div>
    </div>

    <div id="tabsWrapper" style="background:transparent; border:none; padding:0; margin-bottom:20px; border-radius:0; box-shadow:none;">
        <div id="routines-tabs" style="display:flex; gap:8px; overflow:auto; padding-bottom:8px;"></div>
        <div id="routines-content" style="margin-top:6px;"></div>
    </div> 
    <script>

        let allExercises = [];
        let images = {};
        let currentImageData = null;

        function getDisplayedName(ex) {
            try {
                const lang = (GN_I18N && GN_I18N.safeGetLang) ? GN_I18N.safeGetLang() : (navigator.language || 'en');
                const chosen = (lang && lang.toLowerCase().startsWith('pt') && ex.namePT) ? ex.namePT : ex.name;
                return chosen;
            } catch (e) { return ex.name; }
        }

        // Select-mode / long-press support
        let selectMode = false;
        let selectedExercises = new Set();
        let pressTimer = null;
        let longPressTriggered = false;
        const PRESS_DURATION = 500; // ms
        const INT_MAX = 2147483647; // default when sort is not defined

        function startPressTimer(el, exId, isCustom, e) {
            pressTimer = setTimeout(() => {
                longPressTriggered = true;
                enterSelectMode();
                toggleSelect(exId, isCustom, el);
            }, PRESS_DURATION);
        }

        function cancelPressTimer() {
            if (pressTimer) {
                clearTimeout(pressTimer);
                pressTimer = null;
            }
            // clear longPressTriggered after a short delay to allow click handler to consume it
            setTimeout(() => { longPressTriggered = false; }, 50);
        }

        function handleCardClick(exId, isCustom, el, e) {
            if (longPressTriggered) {
                longPressTriggered = false;
                return;
            }
            if (selectMode) {
                toggleSelect(exId, isCustom, el);
            } else {
                addExerciseToRoutine(exId, [], isCustom);
                closeSearchModal();
            }
        }

        function enterSelectMode() {
            selectMode = true;
            selectedExercises = new Set();
            document.getElementById('selectBar').classList.remove('hidden');
            updateSelectBar();
            document.getElementById('modalResults').classList.add('select-mode');
        }

        function exitSelectMode() {
            selectMode = false;
            selectedExercises.clear();
            document.getElementById('selectBar').classList.add('hidden');
            document.getElementById('modalResults').classList.remove('select-mode');
            document.querySelectorAll('.exercise-card.selected').forEach(c => c.classList.remove('selected'));
            updateSelectBar();
        }

        function toggleSelect(exId, isCustom, el) {
            const key = `${isCustom ? 'c' : 's'}:${exId}`;
            if (selectedExercises.has(key)) {
                selectedExercises.delete(key);
                el.classList.remove('selected');
            } else {
                selectedExercises.add(key);
                el.classList.add('selected');
            }
            updateSelectBar();
        }

        function updateSelectBar() {
            const count = selectedExercises.size;
            document.getElementById('selectCount').innerText = `${count} selecionados`;
            document.getElementById('addSelectedBtn').disabled = count === 0;
        }

        function addSelectedExercises() {
            // Add each selected exercise to the routine
            for (const key of Array.from(selectedExercises)) {
                const [prefix, idStr] = key.split(':');
                const isCustom = prefix === 'c';
                const id = parseInt(idStr);
                addExerciseToRoutine(id, [], isCustom);
            }
            exitSelectMode();
            closeSearchModal();
        }

        async function init() {
            try {
                await ensureDbOpen();
                const [catalogEx, catalogImgs, customEx, customImgs] = await Promise.all([
                    db.catalog_exercises.toArray(),
                    db.catalog_images.toArray(),
                    db.custom_exercises.toArray(),
                    db.custom_images.toArray()
                ]);

                // Merge images from both catalog and custom collections
                images = {};
                catalogImgs.forEach(img => images[img.id] = img.data);
                customImgs.forEach(img => images[img.id] = img.data);

                // Combine exercises into a single list for the search modal
                allExercises = [
                    ...catalogEx.map(ex => ({ ...ex, isCustom: false })),
                    ...customEx.map(ex => ({ ...ex, isCustom: true }))
                ];

                renderTabs();
                updateModalResults();
            } catch (err) {
                console.error("Failed to load exercises:", err);
            }
        }

        function openSearchModal() {
            document.getElementById('searchModal').classList.remove('hidden');
            updateModalResults();
        }

        function closeSearchModal() {
            document.getElementById('searchModal').classList.add('hidden');
        }

        function updateModalResults() {
            const inputEl = document.getElementById('modalSearchInput');
            const query = (inputEl && inputEl.value) ? inputEl.value.toLowerCase() : '';
            const resultsDiv = document.getElementById('modalResults');
            if (!resultsDiv) return; // nothing to render into (modal markup may be absent)
            const forceOpen = query.length > 0;
            const lang = (GN_I18N && GN_I18N.safeGetLang) ? GN_I18N.safeGetLang() : (navigator.language || 'en');

            const filtered = allExercises.filter(ex => 
                ex.name.toLowerCase().includes(query) ||
                (ex.namePT && ex.namePT.toLowerCase().includes(query))
            );

            if (filtered.length === 0) {
                const noneMsg = (window.GN_I18N && GN_I18N.t) ? GN_I18N.t('no_exercise_found') : 'No exercise found';
                resultsDiv.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-dim)">' + noneMsg + '</div>';
                return;
            }

            const groups = filtered.reduce((acc, ex) => {
                if (!acc[ex.type]) acc[ex.type] = [];
                acc[ex.type].push(ex);
                return acc;
            }, {});

            // Build grouped HTML with a simple loop to avoid nested template complexities
            const types = Object.keys(groups).sort();
            let html = '';
            for (let i = 0; i < types.length; i++) {
                const type = types[i];
                const displayType = (window.GN_I18N && GN_I18N.localizeExerciseType) ? GN_I18N.localizeExerciseType(type) : type;
                html += '<details class="category-section" ' + (forceOpen ? 'open' : '') + '>' +
                        '<summary class="category-summary">' +
                            '<span>' + displayType + '</span>' +
                            '<svg class="chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>' +
                        '</summary>' +
                        '<div class="exercise-grid">';

                const group = groups[type] || [];
                for (let j = 0; j < group.length; j++) {
                    const ex = group[j];
                    const ptLine = ((lang && lang.toLowerCase().startsWith('pt')) && ex.namePT) ? ('<div class="exercise-name-pt">' + ex.namePT + '</div>') : '';
                    const customBadge = ex.isCustom ? '<span class="custom-badge">Personalizado</span>' : '';
                    html += '<div class="exercise-card" onmousedown="startPressTimer(this, ' + ex.id + ', ' + (ex.isCustom ? 'true' : 'false') + ', event)" onmouseup="cancelPressTimer()" onmouseleave="cancelPressTimer()" ontouchstart="startPressTimer(this, ' + ex.id + ', ' + (ex.isCustom ? 'true' : 'false') + ', event)" ontouchmove="cancelPressTimer()" ontouchcancel="cancelPressTimer()" ontouchend="cancelPressTimer()" onclick="handleCardClick(' + ex.id + ', ' + (ex.isCustom ? 'true' : 'false') + ', this, event)">' +
                                '<img src="' + (images[ex.imageId] || defaultImage) + '" class="ex-thumb">' +
                                '<div class="exercise-info">' +
                                    '<div class="exercise-name">' + getDisplayedName(ex) + '</div>' +
                                    customBadge +
                                    ptLine +
                                '</div>' +
                                '<div class="actions" onclick="event.stopPropagation()" style="display: flex; gap: 4px;"></div>' +
                                '<div class="select-badge">✓</div>' +
                            '</div>';
                }

                html += '</div></details>';
            }
            resultsDiv.innerHTML = html;
        }

        function addExerciseToRoutine(exId, sets = [], isCustom = false) {
            const ex = allExercises.find(e => e.id === exId && !!e.isCustom === !!isCustom);
            if (!ex) return;

            const container = document.getElementById('selectedList');
            const card = document.createElement('div');
            card.className = 'selected-ex-card';
            card.dataset.id = exId;
            card.dataset.isCustom = isCustom;
            
            card.innerHTML = `
                <div class="selected-ex-header">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <img src="${images[ex.imageId] || defaultImage}" class="ex-thumb">
                        <span class="selected-ex-title">${getDisplayedName(ex)}</span>
                    </div>
                    <button type="button" class="remove-set-btn" onclick="this.closest('.selected-ex-card').remove()">×</button>
                </div>
                <div class="sets-container"></div>
                <button type="button" class="add-set-btn" onclick="addSetRowToCard(this)">+ Adicionar Série</button>
            `;
            container.appendChild(card);

            const setsContainer = card.querySelector('.sets-container');
            if (sets.length > 0) {
                sets.forEach((s, i) => addSetRowToContainer(setsContainer, i + 1, s.reps, s.weight));
            } else {
                addSetRowToContainer(setsContainer, 1);
            }
        }

        function addSetRowToCard(btn) {
            const container = btn.previousElementSibling;
            const nextNum = container.children.length + 1;
            addSetRowToContainer(container, nextNum);
        }

        function addSetRowToContainer(container, num, reps = "", weight = "") {
            if (reps === "" && weight === "" && container.lastElementChild) {
                reps = container.lastElementChild.querySelector('.set-reps').value;
                weight = container.lastElementChild.querySelector('.set-weight').value;
            }

            const div = document.createElement('div');
            div.className = 'set-row-input';
            div.innerHTML = `
                <span style="font-size:0.7rem; color:#64748b; width:20px">S${num}</span>
                <input type="number" placeholder="Repetições" class="set-reps" value="${reps}">
                <input type="number" step="0.5" placeholder="Kg" class="set-weight" value="${weight}">
                <button type="button" class="remove-set-btn" onclick="removeSetRow(this)">×</button>
            `;
            container.appendChild(div);
        }

        function removeSetRow(btn) {
            const container = btn.parentElement.parentElement;
            btn.parentElement.remove();
            Array.from(container.children).forEach((row, i) => {
                row.querySelector('span').innerText = `S${i + 1}`;
            });
        }

        function getSelectedExercisesData() {
            return Array.from(document.querySelectorAll('.selected-ex-card')).map((card, index) => {
                const id = parseInt(card.dataset.id);
                const isCustom = card.dataset.isCustom === 'true';
                const sets = Array.from(card.querySelectorAll('.set-row-input')).map(row => ({
                    reps: parseInt(row.querySelector('.set-reps').value) || 0,
                    weight: parseFloat(row.querySelector('.set-weight').value) || 0
                }));
                // Attach a position index so the saved routine preserves the selected order
                return { id, sets, isCustom, position: index };
            });
        }

        async function saveWorkout() {
            const name = document.getElementById('workoutName').value;
            const exerciseIds = getSelectedExercisesData();
            if (!name || exerciseIds.length === 0) return alert((typeof GN_I18N !== 'undefined') ? GN_I18N.t('missing_routine_name') : "Falta nome ou exercícios na rotina");
            await db.routines.add({ name, exerciseIds });
            localStorage.setItem('has_local_changes', 'true');
            resetForm();
            renderTabs();
        }

        async function prepareEdit(id) {
            const workout = await db.routines.get(id);
            if (!workout) return;

            document.getElementById('workoutName').value = workout.name;
            document.getElementById('editId').value = id;
            
            const container = document.getElementById('selectedList');
            container.innerHTML = "";

            for (const item of workout.exerciseIds) {
                const exId = typeof item === 'object' ? item.id : item;
                const isCustom = typeof item === 'object' ? !!item.isCustom : false;
                let sets = [];
                if (typeof item === 'object') {
                    if (Array.isArray(item.sets)) {
                        sets = item.sets;
                    } else {
                        for(let i=0; i<(item.sets||3); i++) sets.push({reps: item.reps, weight: item.weight});
                    }
                }
                addExerciseToRoutine(exId, sets, isCustom);
            }

            // UI Changes
            document.getElementById('addBtn').style.display = 'none';
            document.getElementById('updateBtn').style.display = 'block';
            document.getElementById('cancelEdit').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function updateWorkout() {
            const id = parseInt(document.getElementById('editId').value);
            const name = document.getElementById('workoutName').value;
            const exerciseIds = getSelectedExercisesData();

            if (!name || exerciseIds.length === 0) return alert((typeof GN_I18N !== 'undefined') ? GN_I18N.t('missing_routine_name') : "Falta nome ou exercícios na rotina");

            await db.routines.update(id, { name, exerciseIds });
            localStorage.setItem('has_local_changes', 'true');
            resetForm();
            renderTabs();
        }

        function resetForm() {
            document.getElementById('workoutName').value = "";
            document.getElementById('editId').value = "";
            document.getElementById('selectedList').innerHTML = "";
            document.getElementById('addBtn').style.display = 'block';
            document.getElementById('updateBtn').style.display = 'none';
            document.getElementById('cancelEdit').style.display = 'none';
        }

        async function renderWorkouts() {
            // legacy entry point - delegate to the tabbed renderer
            await renderTabs();
        }
        // New tab-based UI: render tabs and selected routine content
        async function renderTabs() {
            const workouts = await db.routines.toArray();
            const tabsContainer = document.getElementById('routines-tabs');
            const content = document.getElementById('routines-content');
            tabsContainer.innerHTML = '';
            if (!workouts || workouts.length === 0) {
                const msg = (window.GN_I18N && GN_I18N.t) ? GN_I18N.t('no_routines_placeholder') : 'Ainda não há rotinas. Clique em <strong>Nova Rotina</strong> para criar uma.';
                content.innerHTML = '<div style="color:var(--text-dim); padding:20px; text-align:center;">'
                    + '<svg width="180" height="96" viewBox="0 0 180 96" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">'
                    + '<g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" opacity="0.95">'
                    + '<rect x="6" y="26" width="24" height="44" rx="4"></rect>'
                    + '<rect x="150" y="26" width="24" height="44" rx="4"></rect>'
                    + '<rect x="36" y="36" width="108" height="24" rx="6" fill="currentColor" opacity="0.06"></rect>'
                    + '<line x1="30" y1="48" x2="36" y2="48"></line>'
                    + '<line x1="144" y1="48" x2="150" y2="48"></line>'
                    + '</g></svg>'
                    + '<div style="margin-top:12px;">' + msg + '</div></div>';
                return;
            }
            workouts.forEach((w, i) => {
                const btn = document.createElement('button');
                btn.className = 'tab-btn';
                btn.innerText = w.name || 'Rotina ' + (i + 1);
                btn.dataset.id = w.id;
                btn.onclick = function() {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    // ensure the active tab is fully visible when the tab row is scrollable
                    try { this.scrollIntoView({ behavior: 'smooth', inline: 'nearest', block: 'nearest' }); } catch (e) {}
                    renderRoutineContent(parseInt(this.dataset.id));
                };
                tabsContainer.appendChild(btn);
            });
            // Activate a tab: prefer id from querystring if present, otherwise first tab
            const params = new URLSearchParams(window.location.search);
            const selectedId = params.get('id');
            const first = tabsContainer.querySelector('.tab-btn');
            if (selectedId) {
                const btn = tabsContainer.querySelector(`[data-id="${selectedId}"]`);
                if (btn) btn.click(); else if (first) first.click();
            } else if (first) first.click();
        }

        async function renderRoutineContent(id) {
            const workout = await db.routines.get(id);
            const content = document.getElementById('routines-content');
            if (!workout) {
                const msg = (window.GN_I18N && GN_I18N.t) ? GN_I18N.t('routine_not_found') : 'Rotina não encontrada.';
                content.innerHTML = '<div style="color:var(--text-dim); padding:20px;">' + msg + '</div>';
                return;
            }

            // Normalize exercise items and set default position to 0 when missing (support legacy 'sort')
            const items = (workout.exerciseIds || []).map((item, idx) => {
                if (typeof item === 'object') {
                    const position = (typeof item.position !== 'undefined') ? item.position : ((typeof item.sort !== 'undefined') ? item.sort : 0);
                    return { ...item, id: item.id, isCustom: !!item.isCustom, position, __origIndex: idx };
                }
                return { id: item, isCustom: false, position: 0, __origIndex: idx };
            }).sort((a,b) => (a.position - b.position) || (a.__origIndex - b.__origIndex));

            const labelSets = (window.GN_I18N && GN_I18N.t) ? GN_I18N.t('sets') : 'Sets';
            const labelReps = (window.GN_I18N && GN_I18N.t) ? GN_I18N.t('reps') : 'Reps';
            const labelWeight = (window.GN_I18N && GN_I18N.t) ? GN_I18N.t('weight') : 'Weight';

            const tags = items.map(it => {
                const id = it.id;
                const isCustom = !!it.isCustom;
                const ex = allExercises.find(e => e.id === id && !!e.isCustom === isCustom);
                if (!ex) return "";
                let setsHtml = '';
                if (Array.isArray(it.sets) && it.sets.length > 0) {
                    // Group identical rep-weight combinations and show counts
                    const groups = it.sets.reduce((acc, s) => {
                        const key = `${s.reps}|${s.weight}`;
                        if (!acc[key]) acc[key] = { reps: s.reps, weight: s.weight, count: 0 };
                        acc[key].count++;
                        return acc;
                    }, {});
                    setsHtml = `<table class="sets-table"><thead><tr><th>${labelSets}</th><th>${labelReps}</th><th>${labelWeight}</th></tr></thead><tbody>` +
                        Object.values(groups).map(g => `<tr><td>${g.count}</td><td>${g.reps}</td><td>${g.weight}kg</td></tr>`).join('') +
                        `</tbody></table>`;
                } else if (typeof it.sets !== 'undefined') {
                    // Legacy format where `it.sets` is a count and `it.reps`/`it.weight` hold values
                    const count = it.sets || 1;
                    setsHtml = `<table class="sets-table"><thead><tr><th>${labelSets}</th><th>${labelReps}</th><th>${labelWeight}</th></tr></thead><tbody>` +
                        `<tr><td>${count}</td><td>${it.reps}</td><td>${it.weight}kg</td></tr>` +
                        `</tbody></table>`;
                }
                const localizedType = (window.GN_I18N && GN_I18N.localizeExerciseType) ? GN_I18N.localizeExerciseType(ex.type) : ex.type || '';
                return `<div class="exercise-tag draggable" draggable="true" data-id="${it.id}" data-is-custom="${!!it.isCustom}" data-orig-index="${it.__origIndex}">
                    <div class="main">
                        <div class="exercise-row">
                            <img src="${images[ex.imageId] || defaultImage}" class="ex-preview-square">
                            <div class="exercise-meta">
                                <strong class="exercise-title">${getDisplayedName(ex)}</strong>
                                <div class="exercise-type">${localizedType}</div>
                            </div>
                        </div>
                        ${setsHtml}
                    </div>
                    <span class="drag-handle" title="Arrastar para reordenar">☰</span>
                </div>`;
            }).join('');

            const labelDeleteRoutine = (window.GN_I18N && GN_I18N.t) ? GN_I18N.t('delete_routine') : 'Delete routine';

            content.innerHTML = `
                <div class="workout-card">
                    <div class="workout-header">
                        <div class="actions">
                            <button class="sort-btn" onclick="toggleSortMode(${workout.id}, this)" title="Ordenar">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="7" x2="20" y2="7"></line><line x1="4" y1="12" x2="14" y2="12"></line><line x1="4" y1="17" x2="10" y2="17"></line></svg>
                            </button>
                            <button class="edit-btn" onclick="window.location.href='routinecrud.html?id=${workout.id}'" title="Editar">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                            </button>
                            <button class="del-btn" onclick="showDeleteConfirm(${workout.id})" title="${labelDeleteRoutine}">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div id="exerciseList">${tags}</div>
                </div>
            `;

            // Enable drag sorting (persist order on drop)
            enableDragSorting(document.getElementById('exerciseList'), workout.id);
        }
        // Drag & drop helpers for reordering exercises
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function clearDropIndicators(container) {
            container.querySelectorAll('.drop-target').forEach(el => el.classList.remove('drop-target'));
            container.classList.remove('exercise-list-drop-bottom');
            // remove any leftover placeholders
            container.querySelectorAll('.drop-placeholder').forEach(p => p.parentElement && p.parentElement.removeChild(p));
        }

        function enableDragSorting(container, workoutId) {
            if (!container) return;
            let draggingEl = null;
            let isPointerDragging = false;
            let placeholder = null;
            function updateGhostPosition(ghost, x, y) {
                if (!ghost) return;
                const offset = 18;
                ghost.style.left = (x + offset) + 'px';
                ghost.style.top = (y + offset) + 'px';
            }

            container.querySelectorAll('.draggable').forEach(item => {
                // HTML5 drag (desktop)
                item.addEventListener('dragstart', e => {
                    // Only allow HTML5 drag when sorting mode is active
                    if (!container.classList.contains('sorting')) { e.preventDefault(); return; }
                    draggingEl = item;
                    item.classList.add('dragging');
                    // create placeholder to show empty space
                    placeholder = document.createElement('div');
                    placeholder.className = 'drop-placeholder';
                    placeholder.style.height = item.getBoundingClientRect().height + 'px';
                    item.parentElement.insertBefore(placeholder, item);
                    // create floating ghost for better visibility
                    const ghost = item.cloneNode(true);
                    ghost.classList.add('drag-ghost');
                    ghost.style.width = item.getBoundingClientRect().width + 'px';
                    document.body.appendChild(ghost);
                    updateGhostPosition(ghost, e.clientX, e.clientY);
                    // keep layout but hide original visually
                    item.style.visibility = 'hidden';
                    // suppress default drag image
                    try { e.dataTransfer.setDragImage(new Image(), 0, 0); } catch (err) {}
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', '');
                    draggingEl._ghost = ghost;
                });
                item.addEventListener('dragend', e => {
                    if (draggingEl) {
                        draggingEl.classList.remove('dragging');
                        draggingEl.style.visibility = '';
                        if (draggingEl._ghost && draggingEl._ghost.parentElement) draggingEl._ghost.parentElement.removeChild(draggingEl._ghost);
                        draggingEl._ghost = null;
                    }
                    if (placeholder && placeholder.parentElement) {
                        placeholder.parentElement.insertBefore(draggingEl, placeholder);
                        placeholder.parentElement.removeChild(placeholder);
                    }
                    draggingEl = null;
                    placeholder = null;
                    clearDropIndicators(container);
                    persistOrder(workoutId);
                });
                item.addEventListener('dragover', e => {
                    e.preventDefault();
                    if (!placeholder) return;
                    const after = getDragAfterElement(container, e.clientY);
                    clearDropIndicators(container);
                    if (after == null) {
                        container.appendChild(placeholder);
                        container.classList.add('exercise-list-drop-bottom');
                    } else {
                        container.insertBefore(placeholder, after);
                        after.classList.add('drop-target');
                    }
                    if (draggingEl && draggingEl._ghost) updateGhostPosition(draggingEl._ghost, e.clientX, e.clientY);
                });

                // Pointer-based drag (touch / stylus / pointer)
                const handle = item.querySelector('.drag-handle');
                if (handle) {
                    handle.addEventListener('pointerdown', e => {
                        // Only start pointer drag on primary button
                        if (e.button && e.button !== 0) return;
                        e.preventDefault();
                        // create placeholder
                        placeholder = document.createElement('div');
                        placeholder.className = 'drop-placeholder';
                        placeholder.style.height = item.getBoundingClientRect().height + 'px';
                        item.parentElement.insertBefore(placeholder, item);

                        draggingEl = item;
                        isPointerDragging = true;
                        item.classList.add('dragging');
                        // create floating ghost
                        const ghost = item.cloneNode(true);
                        ghost.classList.add('drag-ghost');
                        ghost.style.width = item.getBoundingClientRect().width + 'px';
                        document.body.appendChild(ghost);
                        updateGhostPosition(ghost, e.clientX, e.clientY);
                        item.style.visibility = 'hidden';
                        try { item.setPointerCapture(e.pointerId); } catch (err) { /* ignore */ }
                        draggingEl._ghost = ghost;
                    });
                }
            });

            // Global pointer move/up handlers to track pointer drags
            function onPointerMove(e) {
                if (!isPointerDragging || !draggingEl || !placeholder) return;
                const after = getDragAfterElement(container, e.clientY);
                clearDropIndicators(container);
                if (after == null) {
                    container.appendChild(placeholder);
                    container.classList.add('exercise-list-drop-bottom');
                } else {
                    container.insertBefore(placeholder, after);
                    after.classList.add('drop-target');
                }
                if (draggingEl && draggingEl._ghost) updateGhostPosition(draggingEl._ghost, e.clientX, e.clientY);
            }
            function onPointerUp(e) {
                if (!isPointerDragging) return;
                if (draggingEl) {
                    draggingEl.classList.remove('dragging');
                    draggingEl.style.visibility = '';
                }
                if (draggingEl && draggingEl._ghost && draggingEl._ghost.parentElement) draggingEl._ghost.parentElement.removeChild(draggingEl._ghost);
                if (placeholder && placeholder.parentElement) {
                    placeholder.parentElement.insertBefore(draggingEl, placeholder);
                    placeholder.parentElement.removeChild(placeholder);
                }
                isPointerDragging = false;
                draggingEl = null;
                placeholder = null;
                clearDropIndicators(container);
                persistOrder(workoutId);
            }

            document.addEventListener('pointermove', onPointerMove);
            document.addEventListener('pointerup', onPointerUp);
        }

        async function persistOrder(workoutId) {
            const list = document.getElementById('exerciseList');
            if (!list) return;
            const children = [...list.querySelectorAll('.draggable')];
            const workout = await db.routines.get(workoutId);
            if (!workout) return;
            const original = workout.exerciseIds || [];


            const used = new Array(original.length).fill(false);
            const newOrder = children.map((el, idx) => {
                const id = parseInt(el.dataset.id);
                const isCustom = el.dataset.isCustom === 'true';
                let matchIndex = -1;
                for (let i=0;i<original.length;i++){
                    const item = original[i];
                    const itemId = typeof item === 'object' ? item.id : item;
                    const itemIsCustom = typeof item === 'object' ? !!item.isCustom : false;
                    if (!used[i] && itemId === id && itemIsCustom === isCustom) {
                        matchIndex = i; break;
                    }
                }
                let newItem;
                if (matchIndex >=0) {
                    used[matchIndex] = true;
                    const origItem = original[matchIndex];
                    if (typeof origItem === 'object') {
                        newItem = { ...origItem, position: idx };
                    } else {
                        newItem = { id: origItem, position: idx };
                    }
                } else {
                    newItem = { id, isCustom, position: idx };
                }
                return newItem;
            });
            await db.routines.update(workoutId, { exerciseIds: newOrder });
            localStorage.setItem('has_local_changes', 'true');


        }

        function toggleSortMode(workoutId, btn) {
            const list = document.getElementById('exerciseList');
            if (!list) return;
            const isActive = list.classList.toggle('sorting');
            if (btn) {
                if (isActive) btn.classList.add('active'); else btn.classList.remove('active');
            }
            if (!isActive) {
                // when turning off, persist any changed order
                persistOrder(workoutId);
            }
        }

        // Use native confirm dialog for deletion (localized)
        async function showDeleteConfirm(id) {
            const msg = (window.GN_I18N && GN_I18N.t) ? GN_I18N.t('confirm_delete_routine') : 'Delete routine?';
            if (confirm(msg)) {
                await db.routines.delete(id);
                localStorage.setItem('has_local_changes', 'true');
                renderTabs();
            }
        }

        // Apply translations for this page (titles, static buttons)
        try {
            if (window.GN_I18N) {
                GN_I18N.applyTranslations(document);
                // Localize the New Routine button text (includes a leading plus)
                const newBtn = document.getElementById('newRoutineBtn');
                if (newBtn && GN_I18N.t) newBtn.innerHTML = GN_I18N.t('new_routine_btn');
            }
        } catch(e){}

        init();
    </script>
</body>
</html>
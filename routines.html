<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GymNerd | Rotinas</title>
    <link rel="icon" type="image/svg+xml" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <script src="auth.js"></script>
    <script src="gn-i18n.js"></script>
    <script src="drive-storage.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="db.js"></script>
    <style>
        :root { --primary: #3b82f6; --primary-grad: linear-gradient(135deg, #60a5fa 0%, #2563eb 100%); --secondary-grad: linear-gradient(135deg, #D1D5DB 0%, #9CA3AF 100%); --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --text-dim: #94a3b8; --success: #10b981; --danger: #ef4444; --header-height: 56px; --tabs-height: 64px; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); max-width: 500px; margin: 0 auto; padding: 20px; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .header { display: flex; align-items: center; gap: 15px; margin-bottom: 6px; position: sticky; top: 0; z-index: 1200; height: var(--header-height); padding: 8px 12px; backdrop-filter: blur(6px); background: linear-gradient(180deg, rgba(15,23,42,0.95), rgba(15,23,42,0.88)); }
        .header h2 { font-weight: 800; letter-spacing: -0.5px; background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; }
        .back-btn { text-decoration: none; font-size: 1.5rem; color: var(--text); }
        .card { background: var(--card); padding: 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px; }
        .input-group { display: flex; flex-direction: column; gap: 10px; }
        input, button { padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); font-size: 1rem; background: rgba(255,255,255,0.05); color: white; }
        
        button.primary { background: var(--primary-grad); color: white; border: none; font-weight: bold; cursor: pointer; }
        button.update { background: var(--success); color: white; border: none; font-weight: bold; cursor: pointer; display: none; }
        .cancel-link { text-align: center; font-size: 0.8rem; color: #ef4444; cursor: pointer; display: none; margin-top: 5px; text-decoration: underline; }

        /* Search Modal Styles */
        .modal { position: fixed; top: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 500px; height: 100%; background: var(--bg); z-index: 1000; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .modal-sub { z-index: 1100; }
        .form-group { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        .form-group label { font-size: 0.75rem; font-weight: 800; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em; }
        .form-group input, .form-group select { padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: var(--card); color: white; font-size: 1rem; outline: none; }
        .image-preview-box { width: 100%; height: 200px; background: #fff; border: 2px dashed rgba(0,0,0,0.08); border-radius: 16px; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; }
        .save-btn { background: var(--primary-grad); color: white; border: none; padding: 16px; border-radius: 16px; font-weight: 800; font-size: 1.1rem; cursor: pointer; margin-top: 10px; box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2); }
        .category-section { background: var(--card); border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); overflow: hidden; margin-bottom: 12px; }
        .category-summary { padding: 16px 20px; cursor: pointer; list-style: none; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; font-weight: 800; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.1em; }
        .category-summary::-webkit-details-marker { display: none; }
        .category-summary .chevron { transition: transform 0.2s; color: var(--text-dim); }
        .category-section[open] .category-summary .chevron { transform: rotate(180deg); }
        .exercise-grid { display: grid; gap: 12px; padding: 0 12px 16px 12px; }
        .exercise-grid .ex-thumb { width: 72px; height: 48px; border-radius: 10px; object-fit: contain; object-position: center; background: #fff; }
        .exercise-card { background: var(--card); border-radius: 16px; padding: 12px; display: flex; align-items: center; gap: 16px; border: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: transform 0.2s; }
        .exercise-card:active { transform: scale(0.98); }
        .exercise-card { position: relative; }
        .exercise-card.selected { outline: 3px solid rgba(59,130,246,0.9); background: rgba(59,130,246,0.08); }
        .select-mode .exercise-card { cursor: pointer; }

        /* Select bar styles */
        #selectBar.hidden { display: none; }
        #selectBar { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:12px; background: rgba(255,255,255,0.02); padding: 8px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.04); }
        #selectCount { color: var(--text); font-weight: 800; }
        #addSelectedBtn { background: var(--success); color: white; border: none; padding: 10px 14px; border-radius: 10px; font-weight: 800; cursor: pointer; min-width: 120px; }
        #addSelectedBtn:disabled { opacity: 0.6; cursor: not-allowed; }
        #cancelSelectBtn { background: transparent; border: 1px solid rgba(255,255,255,0.06); color: var(--text-dim); padding: 10px 14px; border-radius: 10px; font-weight: 700; cursor: pointer; }

        /* Badge inside selected cards */
        .select-badge { display: none; position: absolute; top: 50%; right: -14px; transform: translateY(-50%); width: 28px; height: 28px; border-radius: 8px; background: var(--primary); color: #fff; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 800; box-shadow: 0 6px 18px rgba(0,0,0,0.25); z-index: 1000; }
        .exercise-card { overflow: visible; }
        .exercise-card .actions { position: relative; z-index: 2; }
        .exercise-card.selected .select-badge { display: flex; }
        .exercise-info { flex-grow: 1; }
        .exercise-name { font-weight: 700; font-size: 1rem; margin: 0; }
        .exercise-name-pt { font-size: 0.85rem; color: var(--text-dim); margin-top: 2px; }
        .copy-btn { background: none; border: none; color: var(--text-dim); cursor: pointer; padding: 8px; display: flex; align-items: center; justify-content: center; transition: color 0.2s; }
        .copy-btn:hover { color: var(--primary); }

        .custom-badge {
            font-size: 0.6rem;
            background: rgba(59, 130, 246, 0.15);
            color: var(--primary);
            padding: 2px 6px;
            border-radius: 6px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border: 1px solid rgba(59, 130, 246, 0.3);
            display: inline-block;
            white-space: nowrap;
            width: auto;
            max-width: none;
            margin-top: 4px;
        }

        .selected-ex-list { margin: 15px 0; display: flex; flex-direction: column; gap: 10px; }
        .selected-ex-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; }
        .selected-ex-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .selected-ex-title { font-weight: 700; font-size: 0.95rem; }

        .set-row-input { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; }
        .set-row-input input { width: 70px; padding: 8px; font-size: 0.8rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: #000; }
        .add-set-btn { background: rgba(255,255,255,0.05); border: 1px dashed rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; cursor: pointer; color: var(--text-dim); margin-bottom: 10px; }
        .remove-set-btn { background: none; border: none; color: #ef4444; cursor: pointer; font-size: 1rem; padding: 0 5px; }
        .ex-thumb { width: 64px; height: 44px; border-radius: 8px; object-fit: contain; object-position: center; background: #fff; flex-shrink: 0; }
        /* Keep preview images on white background when they have transparency */
        .image-preview-box img { background: #fff; }

        .hidden { display: none !important; }
        /* Image preview modal */
        .image-modal { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.7); z-index: 2200; }
        .image-modal .modal-inner { position: relative; max-width: 92vw; max-height: 92vh; padding: 12px; box-sizing: border-box; background: #fff; border-radius: 12px; }
        .image-modal img { max-width: 100%; max-height: 84vh; border-radius: 8px; display: block; background: #fff; }
        .image-modal .close-btn { position: absolute; top: 8px; right: 8px; width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; background: var(--primary); border: none; color: #fff; border-radius: 50%; cursor: pointer; font-weight: 800; box-shadow: 0 6px 18px rgba(37,99,235,0.22); }
        .image-modal .close-btn:hover { filter: brightness(0.95); }
        .image-modal .close-btn:focus { outline: 3px solid rgba(59,130,246,0.18); }
        .workout-card { background: transparent; padding: 10px 0; border-radius: 16px; margin-bottom: 15px; border: none; }
        .workout-header { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 10px; }
        .workout-name { font-weight: 800; font-size: 1.2rem; color: var(--primary); }
        /* Stack image, title and sets vertically inside the main area; drag handle sits at the right */
        .exercise-tag { display: flex; align-items: stretch; gap: 12px; background: rgba(255,255,255,0.02); padding: 14px; border-radius: 12px; font-size: 0.95rem; margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.04); box-shadow: none; transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease; }
        .exercise-tag:hover { transform: translateY(-3px); }
        .exercise-tag .main { flex: 1 1 auto; display:flex; flex-direction:column; gap:8px; }
        .exercise-tag .ex-thumb { width: 100%; height: 110px; border-radius: 10px; object-fit: contain; object-position: center; background: #fff; }
        .exercise-tag .exercise-title { font-weight:700; font-size: 1rem; color: var(--text); margin: 0; }
        /* New card layout: preview square + meta column + sets table */
        .ex-preview-square { width:72px; height:72px; border-radius:8px; object-fit:cover; object-position:center; background:#fff; flex-shrink:0; align-self:flex-start; }
        .exercise-row { display:flex; gap:12px; align-items:flex-start; }
        .exercise-meta { display:flex; flex-direction:column; gap:4px; align-items: flex-start; }
        .exercise-type { font-size:0.8rem; color:var(--text-dim); font-weight:700; text-transform:capitalize; }
        .sets-table { width:100%; border-collapse:collapse; margin-top:8px; }
        .sets-table th, .sets-table td { text-align:left; padding:6px 8px; font-size:0.85rem; color:var(--text-dim); border-bottom:1px solid rgba(255,255,255,0.03); }
        .sets-table th { color:var(--text-dim); font-weight:800; font-size:0.7rem; text-transform:uppercase; letter-spacing:0.04em; }
        .set-pills { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 5px; justify-content: flex-start; }
        .set-pill { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 8px; font-size: 0.75rem; color: var(--text-dim); font-weight: 700; }
        .sets-compact { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
        .reorder-btn { display: inline-flex; align-items: center; gap:8px; border: none; background: rgba(255,255,255,0.02); color: var(--text-dim); padding: 8px 10px; border-radius: 10px; cursor: pointer; font-weight: 800; transition: background 0.12s, box-shadow 0.12s, color 0.12s, transform 0.08s; }
        .reorder-btn svg { stroke: currentColor; transition: stroke 0.12s, transform 0.12s; }
        .reorder-btn:active { transform: scale(0.98); }
        .reorder-btn.active { background: var(--primary); color: #fff; box-shadow: 0 6px 18px rgba(59,130,246,0.12); }
        .exercise-list.reorder-mode .drag-handle { display: inline-flex; }
        .exercise-list.reorder-mode .sets-compact,
        .exercise-list.reorder-mode .set-pill,
        .exercise-list.reorder-mode .sets-table { display: none !important; }
        .exercise-tag .drag-handle { display: none; border: none; background: transparent; color: var(--text-dim); font-size: 1.1rem; padding: 6px 8px; border-radius: 8px; cursor: grab; margin-left: auto; align-self: center; }
        .exercise-tag .drag-handle:active { cursor: grabbing; }
        .sort-btn { color: var(--text-dim); background: rgba(255,255,255,0.02); border: none; cursor: pointer; display: flex; align-items: center; padding: 8px; border-radius: 10px; transition: background 0.12s; }
        .sort-btn.active { background: var(--primary); color: #fff; box-shadow: 0 6px 18px rgba(59,130,246,0.12); }


        .set-pills { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; justify-content: flex-start; }
        .set-pill { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 3px 8px; border-radius: 6px; font-size: 0.7rem; color: var(--text-dim); font-weight: 600; }
        
        .actions { display: flex; gap: 12px; }
        .edit-btn { color: var(--primary); background: rgba(255,255,255,0.05); border: none; cursor: pointer; display: flex; align-items: center; padding: 10px; border-radius: 10px; transition: background 0.2s; }
        .del-btn { color: var(--danger); background: rgba(255,255,255,0.05); border: none; cursor: pointer; display: flex; align-items: center; padding: 10px; border-radius: 10px; transition: background 0.2s; }

        .section-title { margin-top: 40px; margin-bottom: 20px; font-weight: 800; font-size: 1.5rem; letter-spacing: -0.5px; padding-left: 5px; background: var(--secondary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; width: fit-content; }
        /* Tabs - mobile segmented control style */
        #tabsWrapper { position: sticky; top: var(--header-height); z-index: 1150; }
        #routines-tabs { display:flex; gap:6px; flex-wrap:nowrap; justify-content:flex-start; align-items:center; padding:8px 12px; background: rgba(255,255,255,0.02); border-radius: 14px; margin: 0 0; overflow-x:auto; -webkit-overflow-scrolling:touch; }
        .tab-btn { padding: 10px 14px; border-radius: 10px; background: transparent; border: none; color: var(--text-dim); cursor: pointer; font-weight:800; text-align:center; font-size:0.95rem; white-space:nowrap; word-break:keep-all; flex:0 0 auto; }
        .tab-btn:focus { outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0.08); border-radius:10px; }
        .tab-btn.active { background: var(--primary); color: #fff; box-shadow: 0 6px 18px rgba(59,130,246,0.12); }
        .tab-card { background: transparent; padding: 12px; border-radius: 12px; border: none; }
        /* Make routines content the scrollable area so header and tabs stay fixed */
        #routines-content { height: calc(100vh - var(--header-height) - var(--tabs-height)); overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 6px 12px 24px; box-sizing: border-box; }
    </style>
</head>
<body>
    <div class="header" style="justify-content:space-between; align-items:center;">
        <div style="display:flex; align-items:center; gap:15px;">
            <a href="index.html" class="back-btn">←</a>
            <h2 data-i18n="page_routines">Rotinas</h2>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
            <button id="newRoutineBtn" class="primary" style="padding:10px 14px; font-size:0.9rem;" onclick="window.location.href='routinecrud.html'">+ Nova Rotina</button>
        </div>
    </div>

    <div id="tabsWrapper" style="background:transparent; border:none; padding:0; margin-bottom:20px; border-radius:0; box-shadow:none;">
        <div id="routines-tabs" style="display:flex; gap:8px; overflow:auto; padding-bottom:8px;"></div>
        <div id="routines-content" style="margin-top:6px;"></div>
    </div> 
    <script>

    // Include SortableJS for touch-friendly drag & drop
    </script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>

        let allExercises = [];
        let images = {};
        let currentImageData = null;

        function getDisplayedName(ex) {
            try {
                const lang = (GN_I18N && GN_I18N.safeGetLang) ? GN_I18N.safeGetLang() : (navigator.language || 'en');
                const chosen = (lang && lang.toLowerCase().startsWith('pt') && ex.namePT) ? ex.namePT : ex.name;
                return chosen;
            } catch (e) { return ex.name; }
        }

        // Select-mode / long-press support
        let selectMode = false;
        let selectedExercises = new Set();
        let pressTimer = null;
        let longPressTriggered = false;
        const PRESS_DURATION = 500; // ms
        const INT_MAX = 2147483647; // default when sort is not defined

        function startPressTimer(el, exId, isCustom, e) {
            pressTimer = setTimeout(() => {
                longPressTriggered = true;
                enterSelectMode();
                toggleSelect(exId, isCustom, el);
            }, PRESS_DURATION);
        }

        function cancelPressTimer() {
            if (pressTimer) {
                clearTimeout(pressTimer);
                pressTimer = null;
            }
            // clear longPressTriggered after a short delay to allow click handler to consume it
            setTimeout(() => { longPressTriggered = false; }, 50);
        }

        function handleCardClick(exId, isCustom, el, e) {
            if (longPressTriggered) {
                longPressTriggered = false;
                return;
            }
            if (selectMode) {
                toggleSelect(exId, isCustom, el);
            } else {
                addExerciseToRoutine(exId, [], isCustom);
                closeSearchModal();
            }
        }

        function enterSelectMode() {
            selectMode = true;
            selectedExercises = new Set();
            document.getElementById('selectBar').classList.remove('hidden');
            updateSelectBar();
            document.getElementById('modalResults').classList.add('select-mode');
        }

        function exitSelectMode() {
            selectMode = false;
            selectedExercises.clear();
            document.getElementById('selectBar').classList.add('hidden');
            document.getElementById('modalResults').classList.remove('select-mode');
            document.querySelectorAll('.exercise-card.selected').forEach(c => c.classList.remove('selected'));
            updateSelectBar();
        }

        function toggleSelect(exId, isCustom, el) {
            const key = `${isCustom ? 'c' : 's'}:${exId}`;
            if (selectedExercises.has(key)) {
                selectedExercises.delete(key);
                el.classList.remove('selected');
            } else {
                selectedExercises.add(key);
                el.classList.add('selected');
            }
            updateSelectBar();
        }

        function updateSelectBar() {
            const count = selectedExercises.size;
            document.getElementById('selectCount').innerText = `${count} selecionados`;
            document.getElementById('addSelectedBtn').disabled = count === 0;
        }

        function addSelectedExercises() {
            // Add each selected exercise to the routine
            for (const key of Array.from(selectedExercises)) {
                const [prefix, idStr] = key.split(':');
                const isCustom = prefix === 'c';
                const id = parseInt(idStr);
                addExerciseToRoutine(id, [], isCustom);
            }
            exitSelectMode();
            closeSearchModal();
        }

        async function init() {
            try {
                await ensureDbOpen();
                const [catalogEx, catalogImgs, customEx, customImgs] = await Promise.all([
                    db.catalog_exercises.toArray(),
                    db.catalog_images.toArray(),
                    db.custom_exercises.toArray(),
                    db.custom_images.toArray()
                ]);

                // Merge images from both catalog and custom collections
                images = {};
                catalogImgs.forEach(img => images[img.id] = img.data);
                customImgs.forEach(img => images[img.id] = img.data);

                // Combine exercises into a single list for the search modal
                allExercises = [
                    ...catalogEx.map(ex => ({ ...ex, isCustom: false })),
                    ...customEx.map(ex => ({ ...ex, isCustom: true }))
                ];

                renderTabs();
                updateModalResults();
            } catch (err) {
                console.error("Failed to load exercises:", err);
            }
        }

        function openSearchModal() {
            document.getElementById('searchModal').classList.remove('hidden');
            updateModalResults();
        }

        function closeSearchModal() {
            document.getElementById('searchModal').classList.add('hidden');
        }

        function updateModalResults() {
            const inputEl = document.getElementById('modalSearchInput');
            const query = (inputEl && inputEl.value) ? inputEl.value.toLowerCase() : '';
            const resultsDiv = document.getElementById('modalResults');
            if (!resultsDiv) return; // nothing to render into (modal markup may be absent)
            const forceOpen = query.length > 0;
            const lang = (GN_I18N && GN_I18N.safeGetLang) ? GN_I18N.safeGetLang() : (navigator.language || 'en');

            const filtered = allExercises.filter(ex => 
                ex.name.toLowerCase().includes(query) ||
                (ex.namePT && ex.namePT.toLowerCase().includes(query))
            );

            if (filtered.length === 0) {
                const noneMsg = (window.GN_I18N && GN_I18N.t) ? GN_I18N.t('no_exercise_found') : 'No exercise found';
                resultsDiv.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-dim)">' + noneMsg + '</div>';
                return;
            }

            const groups = filtered.reduce((acc, ex) => {
                if (!acc[ex.type]) acc[ex.type] = [];
                acc[ex.type].push(ex);
                return acc;
            }, {});

            // Build grouped HTML with a simple loop to avoid nested template complexities
            const types = Object.keys(groups).sort();
            let html = '';
            for (let i = 0; i < types.length; i++) {
                const type = types[i];
                const displayType = (window.GN_I18N && GN_I18N.localizeExerciseType) ? GN_I18N.localizeExerciseType(type) : type;
                html += '<details class="category-section" ' + (forceOpen ? 'open' : '') + '>' +
                        '<summary class="category-summary">' +
                            '<span>' + displayType + '</span>' +
                            '<svg class="chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>' +
                        '</summary>' +
                        '<div class="exercise-grid">';

                const group = groups[type] || [];
                for (let j = 0; j < group.length; j++) {
                    const ex = group[j];
                    const ptLine = ((lang && lang.toLowerCase().startsWith('pt')) && ex.namePT) ? ('<div class="exercise-name-pt">' + ex.namePT + '</div>') : '';
                    const customBadge = ex.isCustom ? ('<span class="custom-badge">' + ((window.GN_I18N && GN_I18N.t) ? GN_I18N.t('custom_exercise_title') : 'Personalizado') + '</span>') : '';
                    html += '<div class="exercise-card" onmousedown="startPressTimer(this, ' + ex.id + ', ' + (ex.isCustom ? 'true' : 'false') + ', event)" onmouseup="cancelPressTimer()" onmouseleave="cancelPressTimer()" ontouchstart="startPressTimer(this, ' + ex.id + ', ' + (ex.isCustom ? 'true' : 'false') + ', event)" ontouchmove="cancelPressTimer()" ontouchcancel="cancelPressTimer()" ontouchend="cancelPressTimer()" onclick="handleCardClick(' + ex.id + ', ' + (ex.isCustom ? 'true' : 'false') + ', this, event)">' +
                                '<img src="' + (images[ex.imageId] || defaultImage) + '" class="ex-thumb">' +
                                '<div class="exercise-info">' +
                                    '<div class="exercise-name">' + getDisplayedName(ex) + '</div>' +
                                    customBadge +
                                    ptLine +
                                '</div>' +
                                '<div class="actions" onclick="event.stopPropagation()" style="display: flex; gap: 4px;"></div>' +
                                '<div class="select-badge">✓</div>' +
                            '</div>';
                }

                html += '</div></details>';
            }
            resultsDiv.innerHTML = html;
        }

        function addExerciseToRoutine(exId, sets = [], isCustom = false) {
            const ex = allExercises.find(e => e.id === exId && !!e.isCustom === !!isCustom);
            if (!ex) return;

            const container = document.getElementById('selectedList');
            const card = document.createElement('div');
            card.className = 'selected-ex-card';
            card.dataset.id = exId;
            card.dataset.isCustom = isCustom;
            
            card.innerHTML = `
                <div class="selected-ex-header">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <img src="${images[ex.imageId] || defaultImage}" class="ex-thumb">
                        <span class="selected-ex-title">${getDisplayedName(ex)}</span>
                    </div>
                    <button type="button" class="remove-set-btn" onclick="this.closest('.selected-ex-card').remove()">×</button>
                </div>
                <div class="sets-container"></div>
                <button type="button" class="add-set-btn" onclick="addSetRowToCard(this)">+ Adicionar Série</button>
            `;
            container.appendChild(card);

            const setsContainer = card.querySelector('.sets-container');
            if (sets.length > 0) {
                sets.forEach((s, i) => addSetRowToContainer(setsContainer, i + 1, s.reps, s.weight));
            } else {
                addSetRowToContainer(setsContainer, 1);
            }
        }

        function addSetRowToCard(btn) {
            const container = btn.previousElementSibling;
            const nextNum = container.children.length + 1;
            addSetRowToContainer(container, nextNum);
        }

        function addSetRowToContainer(container, num, reps = "", weight = "") {
            if (reps === "" && weight === "" && container.lastElementChild) {
                reps = container.lastElementChild.querySelector('.set-reps').value;
                weight = container.lastElementChild.querySelector('.set-weight').value;
            }

            const div = document.createElement('div');
            div.className = 'set-row-input';
            div.innerHTML = `
                <span style="font-size:0.7rem; color:#64748b; width:20px">S${num}</span>
                <input type="number" placeholder="Repetições" class="set-reps" value="${reps}">
                <input type="number" step="0.5" placeholder="Kg" class="set-weight" value="${weight}">
                <button type="button" class="remove-set-btn" onclick="removeSetRow(this)">×</button>
            `;
            container.appendChild(div);
        }

        function removeSetRow(btn) {
            const container = btn.parentElement.parentElement;
            btn.parentElement.remove();
            Array.from(container.children).forEach((row, i) => {
                row.querySelector('span').innerText = `S${i + 1}`;
            });
        }

        function getSelectedExercisesData() {
            return Array.from(document.querySelectorAll('.selected-ex-card')).map((card, index) => {
                const id = parseInt(card.dataset.id);
                const isCustom = card.dataset.isCustom === 'true';
                const sets = Array.from(card.querySelectorAll('.set-row-input')).map(row => ({
                    reps: parseInt(row.querySelector('.set-reps').value) || 0,
                    weight: parseFloat(row.querySelector('.set-weight').value) || 0
                }));
                // Attach a position index so the saved routine preserves the selected order
                return { id, sets, isCustom, position: index };
            });
        }

        async function saveWorkout() {
            const name = document.getElementById('workoutName').value;
            const exerciseIds = getSelectedExercisesData();
            if (!name || exerciseIds.length === 0) return alert((typeof GN_I18N !== 'undefined') ? GN_I18N.t('missing_routine_name') : "Falta nome ou exercícios na rotina");
            await db.routines.add({ name, exerciseIds });
            localStorage.setItem('has_local_changes', 'true');
            resetForm();
            renderTabs();
        }

        async function prepareEdit(id) {
            const workout = await db.routines.get(id);
            if (!workout) return;

            document.getElementById('workoutName').value = workout.name;
            document.getElementById('editId').value = id;
            
            const container = document.getElementById('selectedList');
            container.innerHTML = "";

            for (const item of workout.exerciseIds) {
                const exId = typeof item === 'object' ? item.id : item;
                const isCustom = typeof item === 'object' ? !!item.isCustom : false;
                let sets = [];
                if (typeof item === 'object') {
                    if (Array.isArray(item.sets)) {
                        sets = item.sets;
                    } else {
                        for(let i=0; i<(item.sets||3); i++) sets.push({reps: item.reps, weight: item.weight});
                    }
                }
                addExerciseToRoutine(exId, sets, isCustom);
            }

            // UI Changes
            document.getElementById('addBtn').style.display = 'none';
            document.getElementById('updateBtn').style.display = 'block';
            document.getElementById('cancelEdit').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function updateWorkout() {
            const id = parseInt(document.getElementById('editId').value);
            const name = document.getElementById('workoutName').value;
            const exerciseIds = getSelectedExercisesData();

            if (!name || exerciseIds.length === 0) return alert((typeof GN_I18N !== 'undefined') ? GN_I18N.t('missing_routine_name') : "Falta nome ou exercícios na rotina");

            await db.routines.update(id, { name, exerciseIds });
            localStorage.setItem('has_local_changes', 'true');
            resetForm();
            renderTabs();
        }

        function resetForm() {
            document.getElementById('workoutName').value = "";
            document.getElementById('editId').value = "";
            document.getElementById('selectedList').innerHTML = "";
            document.getElementById('addBtn').style.display = 'block';
            document.getElementById('updateBtn').style.display = 'none';
            document.getElementById('cancelEdit').style.display = 'none';
        }

        async function renderWorkouts() {
            // legacy entry point - delegate to the tabbed renderer
            await renderTabs();
        }
        // New tab-based UI: render tabs and selected routine content
        async function renderTabs() {
            const workouts = await db.routines.toArray();
            const tabsContainer = document.getElementById('routines-tabs');
            const content = document.getElementById('routines-content');
            tabsContainer.innerHTML = '';
            if (!workouts || workouts.length === 0) {
                const msg = (window.GN_I18N && GN_I18N.t) ? GN_I18N.t('no_routines_placeholder') : 'Ainda não há rotinas. Clique em <strong>Nova Rotina</strong> para criar uma.';
                content.innerHTML = '<div style="color:var(--text-dim); padding:20px; text-align:center;">'
                    + '<svg width="180" height="96" viewBox="0 0 180 96" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">'
                    + '<g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" opacity="0.95">'
                    + '<rect x="6" y="26" width="24" height="44" rx="4"></rect>'
                    + '<rect x="150" y="26" width="24" height="44" rx="4"></rect>'
                    + '<rect x="36" y="36" width="108" height="24" rx="6" fill="currentColor" opacity="0.06"></rect>'
                    + '<line x1="30" y1="48" x2="36" y2="48"></line>'
                    + '<line x1="144" y1="48" x2="150" y2="48"></line>'
                    + '</g></svg>'
                    + '<div style="margin-top:12px;">' + msg + '</div></div>';
                return;
            }
            workouts.forEach((w, i) => {
                const btn = document.createElement('button');
                btn.className = 'tab-btn';
                btn.innerText = w.name || 'Rotina ' + (i + 1);
                btn.dataset.id = w.id;
                btn.onclick = function() {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    // ensure the active tab is fully visible when the tab row is scrollable
                    try { this.scrollIntoView({ behavior: 'smooth', inline: 'nearest', block: 'nearest' }); } catch (e) {}
                    renderRoutineContent(parseInt(this.dataset.id));
                };
                tabsContainer.appendChild(btn);
            });
            // Activate a tab: prefer id from querystring if present, otherwise first tab
            const params = new URLSearchParams(window.location.search);
            const selectedId = params.get('id');
            const first = tabsContainer.querySelector('.tab-btn');
            if (selectedId) {
                const btn = tabsContainer.querySelector(`[data-id="${selectedId}"]`);
                if (btn) btn.click(); else if (first) first.click();
            } else if (first) first.click();
        }

        async function renderRoutineContent(id) {
            const workout = await db.routines.get(id);
            const content = document.getElementById('routines-content');
            if (!workout) {
                const msg = (window.GN_I18N && GN_I18N.t) ? GN_I18N.t('routine_not_found') : 'Rotina não encontrada.';
                content.innerHTML = '<div style="color:var(--text-dim); padding:20px;">' + msg + '</div>';
                return;
            }

            // Normalize exercise items and set default position to 0 when missing (support legacy 'sort')
            const items = (workout.exerciseIds || []).map((item, idx) => {
                if (typeof item === 'object') {
                    const position = (typeof item.position !== 'undefined') ? item.position : ((typeof item.sort !== 'undefined') ? item.sort : 0);
                    return { ...item, id: item.id, isCustom: !!item.isCustom, position, __origIndex: idx };
                }
                return { id: item, isCustom: false, position: 0, __origIndex: idx };
            }).sort((a,b) => (a.position - b.position) || (a.__origIndex - b.__origIndex));

            const labelSets = (window.GN_I18N && GN_I18N.t) ? GN_I18N.t('sets') : 'Sets';
            const labelReps = (window.GN_I18N && GN_I18N.t) ? GN_I18N.t('reps') : 'Reps';
            const labelWeight = (window.GN_I18N && GN_I18N.t) ? GN_I18N.t('weight') : 'Weight';

                const tags = items.map(it => {
                const id = it.id;
                const isCustom = !!it.isCustom;
                const ex = allExercises.find(e => e.id === id && !!e.isCustom === isCustom);
                if (!ex) return "";
                let setsHtml = '';
                if (Array.isArray(it.sets) && it.sets.length > 0) {
                    // Group identical rep-weight combinations and show counts
                    const groups = it.sets.reduce((acc, s) => {
                        const key = `${s.reps}|${s.weight}`;
                        if (!acc[key]) acc[key] = { reps: s.reps, weight: s.weight, count: 0 };
                        acc[key].count++;
                        return acc;
                    }, {});
                    // Filter out groups with missing/invalid reps or weight
                    const groupArr = Object.values(groups).filter(g => {
                        const repsValid = (g.reps !== undefined && g.reps !== null && g.reps !== '' && !isNaN(Number(g.reps)));
                        const weightValid = (g.weight !== undefined && g.weight !== null && g.weight !== '' && !isNaN(Number(g.weight)));
                        return repsValid && weightValid;
                    });
                    if (groupArr.length > 0) {
                        // Compact pills summary: show reps/weight for single sets, otherwise show count×reps/weight
                        const pills = groupArr.map(g => (g.count === 1) ? `<span class="set-pill">${g.reps}reps - ${g.weight}kg</span>` : `<span class="set-pill">${g.count}x ${g.reps}reps - ${g.weight}kg</span>`).join('');
                        setsHtml = `<div class="sets-compact">${pills}</div>`;
                    } else {
                        setsHtml = '';
                    }
                } else if (typeof it.sets !== 'undefined') {
                    // Legacy format where `it.sets` is a count and `it.reps`/`it.weight` hold values
                    const count = it.sets || 1;
                    const repsValid = (it.reps !== undefined && it.reps !== null && it.reps !== '' && !isNaN(Number(it.reps)));
                    const weightValid = (it.weight !== undefined && it.weight !== null && it.weight !== '' && !isNaN(Number(it.weight)));
                    if (repsValid && weightValid) {
                        const pill = (count === 1) ? `<span class="set-pill">${it.reps}reps - ${it.weight}kg</span>` : `<span class="set-pill">${count}x ${it.reps}reps - ${it.weight}kg</span>`;
                        setsHtml = `<div class="sets-compact">${pill}</div>`;
                    } else {
                        setsHtml = '';
                    }
                }
                const localizedType = (window.GN_I18N && GN_I18N.localizeExerciseType) ? GN_I18N.localizeExerciseType(ex.type) : ex.type || '';
                const isCustomEx = !!it.isCustom || !!ex.isCustom;
                const customBadgeHtml = isCustomEx ? ('<span class="custom-badge">' + ((window.GN_I18N && GN_I18N.t) ? GN_I18N.t('custom_exercise_title') : 'Personalizado') + '</span>') : '';
                return `<div class="exercise-tag" data-id="${it.id}" data-is-custom="${!!it.isCustom}" data-orig-index="${it.__origIndex}">
                    <div class="main">
                        <div class="exercise-row">
                            <img src="${images[ex.imageId] || defaultImage}" class="ex-preview-square" style="cursor:pointer" onclick='event.stopPropagation(); showImagePreview(${JSON.stringify(images[ex.imageId] || defaultImage)})'>
                            <div class="exercise-meta">
                                ${customBadgeHtml}
                                <strong class="exercise-title">${getDisplayedName(ex)}</strong>
                                <div class="exercise-type">${localizedType}</div>
                                ${setsHtml}
                            </div>
                        </div>
                    </div>
                    <button class="drag-handle" title="${(window.GN_I18N && GN_I18N.t) ? GN_I18N.t('drag_to_reorder') : 'Drag to reorder'}">☰</button>
                </div>`;
            }).join('');

            const labelDeleteRoutine = (window.GN_I18N && GN_I18N.t) ? GN_I18N.t('delete_routine') : 'Delete routine';

            content.innerHTML = `
                <div class="workout-card">
                    <div class="workout-header">
                        <div class="actions">
                            <button id="toggleSortBtn" class="reorder-btn" onclick="toggleSortMode(${workout.id})" title="${(window.GN_I18N && GN_I18N.t) ? GN_I18N.t('drag_to_reorder') : 'Sort'}">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M6 12h12M10 18h4"></path></svg>
                            </button>
                            <button class="edit-btn" onclick="window.location.href='routinecrud.html?id=${workout.id}'" title="Editar">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                            </button>
                            <button class="del-btn" onclick="showDeleteConfirm(${workout.id})" title="${labelDeleteRoutine}">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div id="exerciseList" class="exercise-list">${tags}</div>
                        </div>
                    `;
        }
        

        // Use native confirm dialog for deletion (localized)
        async function showDeleteConfirm(id) {
            const msg = (window.GN_I18N && GN_I18N.t) ? GN_I18N.t('confirm_delete_routine') : 'Delete routine?';
            if (confirm(msg)) {
                await db.routines.delete(id);
                localStorage.setItem('has_local_changes', 'true');
                renderTabs();
            }
        }

        // Apply translations for this page (titles, static buttons)
        try {
            if (window.GN_I18N) {
                GN_I18N.applyTranslations(document);
                // Localize the New Routine button text (includes a leading plus)
                const newBtn = document.getElementById('newRoutineBtn');
                if (newBtn && GN_I18N.t) newBtn.innerHTML = GN_I18N.t('new_routine_btn');
            }
        } catch(e){}

        function showImagePreview(src) {
            try {
                const modal = document.getElementById('imagePreviewModal');
                const img = document.getElementById('imagePreviewImg');
                if (!modal || !img) return;
                img.src = src || '';
                modal.classList.remove('hidden');
            } catch (e) { console.error(e); }
        }

        function hideImagePreview() {
            try {
                const modal = document.getElementById('imagePreviewModal');
                const img = document.getElementById('imagePreviewImg');
                if (!modal || !img) return;
                modal.classList.add('hidden');
                img.src = '';
            } catch (e) { console.error(e); }
        }

        // Sorting support using SortableJS
        let _routinesSortable = null;

        // Custom toggle for sort mode: uses livesession-like drag handlers
        let _currentSortWorkoutId = null;
        let _routinesDragState = null;
        let _routinesDragListeners = [];

        function toggleSortMode(workoutId) {
            const list = document.getElementById('exerciseList');
            const btn = document.getElementById('toggleSortBtn');
            if (!list || !btn) return;
            const isActive = list.classList.toggle('reorder-mode');
            btn.classList.toggle('active', isActive);
            _currentSortWorkoutId = isActive ? workoutId : null;

            if (isActive) {
                // enable custom drag handlers
                try { attachDragHandlers(); } catch (e) { console.warn('attachDragHandlers failed', e); }
            } else {
                // disable handlers and persist order
                try { detachDragHandlers(); } catch (e) { console.warn('detachDragHandlers failed', e); }
                persistRoutineOrder(workoutId);
            }
        }

        // Attach/detach handlers (adapted from livesession.html)
        function attachDragHandlers() {
            const container = document.getElementById('exerciseList');
            if (!container) return;
            container.querySelectorAll('.drag-handle').forEach(h => {
                if (h._dragAttached) return;
                h.addEventListener('touchstart', _onHandleTouchStart, { passive: false });
                h.addEventListener('pointerdown', _onHandlePointerDown);
                h._dragAttached = true;
            });
        }

        function detachDragHandlers() {
            const container = document.getElementById('exerciseList');
            if (!container) return;
            container.querySelectorAll('.drag-handle').forEach(h => {
                if (!h._dragAttached) return;
                try { h.removeEventListener('touchstart', _onHandleTouchStart); } catch (e) {}
                try { h.removeEventListener('pointerdown', _onHandlePointerDown); } catch (e) {}
                h._dragAttached = false;
            });
        }

        function _onHandleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            _onHandlePointerDown(touch);
        }

        function _onHandlePointerDown(e) {
            const handle = e.target.closest('.drag-handle');
            if (!handle) return;
            const item = handle.closest('.exercise-tag');
            if (!item) return;
            _startDrag(e, item);
        }

        function _startDrag(e, item) {
            if (_routinesDragState) return;
            const container = document.getElementById('exerciseList');
            const rect = item.getBoundingClientRect();
            const clientY = e.clientY || (e.touches && e.touches[0] && e.touches[0].clientY) || 0;
            const clientX = e.clientX || (e.touches && e.touches[0] && e.touches[0].clientX) || 0;

            const placeholder = document.createElement('div');
            placeholder.className = 'exercise-tag placeholder';
            placeholder.style.height = rect.height + 'px';
            placeholder.style.width = rect.width + 'px';
            placeholder.style.boxSizing = 'border-box';

            const ghost = item.cloneNode(true);
            const ghostRem = ghost.querySelectorAll('.del-btn, .edit-btn');
            ghostRem.forEach(el => el.remove());
            ghost.classList.add('dragging');
            ghost.style.width = rect.width + 'px';
            ghost.style.position = 'fixed';
            ghost.style.left = '0px';
            ghost.style.top = '0px';
            ghost.style.margin = '0';
            ghost.style.pointerEvents = 'none';
            // initialize transform so the ghost starts under the pointer (avoid jump)
            ghost.style.transform = `translate3d(${clientX - (clientX - rect.left)}px, ${clientY - (clientY - rect.top)}px, 0)`;
            ghost.style.willChange = 'transform';
            document.body.appendChild(ghost);

            item.style.display = 'none';
            const originalParent = item.parentNode;
            const originalNextSibling = item.nextSibling;
            originalParent.insertBefore(placeholder, originalNextSibling);

            const preventScroll = (ev) => { ev.preventDefault(); };
            document.addEventListener('touchmove', preventScroll, { passive: false });

            _routinesDragState = {
                draggingEl: item,
                container,
                placeholder,
                ghost,
                offsetY: clientY - rect.top,
                offsetX: clientX - rect.left,
                raf: null,
                lastY: clientY,
                lastX: clientX,
                preventScroll,
                originalParent,
                originalNextSibling
            };

            function moveHandler(ev) {
                const y = ev.clientY || (ev.touches && ev.touches[0] && ev.touches[0].clientY) || 0;
                const x = ev.clientX || (ev.touches && ev.touches[0] && ev.touches[0].clientX) || 0;
                _routinesDragState.lastY = y; _routinesDragState.lastX = x;
                if (!_routinesDragState.raf) {
                    _routinesDragState.raf = requestAnimationFrame(() => {
                        _routinesDragState.raf = null;
                        const g = _routinesDragState.ghost;
                        const placeholder = _routinesDragState.placeholder;
                        const container = _routinesDragState.container;
                        if (g) {
                            g.style.transform = `translate3d(${_routinesDragState.lastX - _routinesDragState.offsetX}px, ${_routinesDragState.lastY - _routinesDragState.offsetY}px, 0)`;
                        }
                        // find first child whose midpoint is below pointer and insert placeholder before it
                        const children = Array.from(container.querySelectorAll('.exercise-tag:not(.placeholder)'));
                        let inserted = false;
                        for (const ch of children) {
                            const r = ch.getBoundingClientRect();
                            const mid = r.top + r.height / 2;
                            if (_routinesDragState.lastY < mid) {
                                if (placeholder.parentNode !== ch.parentNode || placeholder.nextSibling !== ch) ch.parentNode.insertBefore(placeholder, ch);
                                inserted = true;
                                break;
                            }
                        }
                        if (!inserted) container.appendChild(placeholder);
                    });
                }
            }

            function upHandler() { _endDrag(); }

            window.addEventListener('touchmove', moveHandler, { passive: false });
            window.addEventListener('pointermove', moveHandler);
            window.addEventListener('touchend', upHandler);
            window.addEventListener('pointerup', upHandler);
            window.addEventListener('touchcancel', upHandler);

            _routinesDragListeners.push({ moveHandler, upHandler });
        }

        function _endDrag() {
            if (!_routinesDragState) return;
            const { draggingEl, placeholder, ghost, preventScroll } = _routinesDragState;
            try { if (placeholder && placeholder.parentNode) placeholder.parentNode.insertBefore(draggingEl, placeholder); } catch (e) { console.warn('insert before failed', e); }
            draggingEl.style.display = '';
            if (placeholder && placeholder.parentNode) placeholder.parentNode.removeChild(placeholder);
            if (ghost && ghost.parentNode) ghost.parentNode.removeChild(ghost);

            try { document.removeEventListener('touchmove', preventScroll, { passive: false }); } catch (e) { try { document.removeEventListener('touchmove', preventScroll); } catch(e){} }

            for (const L of _routinesDragListeners) {
                try { window.removeEventListener('touchmove', L.moveHandler); } catch (e) {}
                try { window.removeEventListener('pointermove', L.moveHandler); } catch (e) {}
                try { window.removeEventListener('touchend', L.upHandler); } catch (e) {}
                try { window.removeEventListener('pointerup', L.upHandler); } catch (e) {}
                try { window.removeEventListener('touchcancel', L.upHandler); } catch (e) {}
            }
            _routinesDragListeners = [];

            // persist order after dropping
            const wid = _currentSortWorkoutId;
            _routinesDragState = null;
            if (wid) persistRoutineOrder(wid);
        }

        function _cancelDrag() {
            if (!_routinesDragState) return;
            const { draggingEl, placeholder, ghost, preventScroll, originalParent, originalNextSibling } = _routinesDragState;
            try { if (originalParent) originalParent.insertBefore(draggingEl, originalNextSibling); } catch (e) { console.warn('revert insert failed', e); }
            draggingEl.style.display = '';
            if (placeholder && placeholder.parentNode) placeholder.parentNode.removeChild(placeholder);
            if (ghost && ghost.parentNode) ghost.parentNode.removeChild(ghost);
            try { document.removeEventListener('touchmove', preventScroll, { passive: false }); } catch (e) { try { document.removeEventListener('touchmove', preventScroll); } catch(e){} }
            for (const L of _routinesDragListeners) {
                try { window.removeEventListener('touchmove', L.moveHandler); } catch (e) {}
                try { window.removeEventListener('pointermove', L.moveHandler); } catch (e) {}
                try { window.removeEventListener('touchend', L.upHandler); } catch (e) {}
                try { window.removeEventListener('pointerup', L.upHandler); } catch (e) {}
                try { window.removeEventListener('touchcancel', L.upHandler); } catch (e) {}
            }
            _routinesDragListeners = [];
            _routinesDragState = null;
        }

        async function persistRoutineOrder(workoutId) {
            try {
                const list = document.getElementById('exerciseList');
                if (!list) return;
                const children = Array.from(list.querySelectorAll('.exercise-tag'));
                const workout = await db.routines.get(workoutId);
                if (!workout) return;

                // Build map from key -> original item (preserve sets/other fields if items were objects)
                const original = workout.exerciseIds || [];
                const map = {};
                original.forEach(it => {
                    const id = (typeof it === 'object') ? it.id : it;
                    const isCustom = (typeof it === 'object') ? !!it.isCustom : false;
                    map[`${isCustom ? 'c' : 's'}:${id}`] = it;
                });

                const newOrder = children.map(ch => {
                    const id = parseInt(ch.dataset.id);
                    const isCustom = ch.dataset.isCustom === 'true' || ch.dataset.isCustom === '1';
                    const key = `${isCustom ? 'c' : 's'}:${id}`;
                    return map[key] || (isCustom ? { id, isCustom: true } : id);
                });

                // Persist new order to DB but do NOT re-render the routine here.
                // Re-rendering was causing the UI to lose reorder-mode; keep the DOM as-is so the user
                // can continue sorting multiple items without toggling again.
                await db.routines.update(workoutId, { exerciseIds: newOrder });
                localStorage.setItem('has_local_changes', 'true');
            } catch (err) {
                console.error('Failed to persist routine order', err);
            }
        }

        init();
    </script>
        <div id="imagePreviewModal" class="image-modal hidden" onclick="hideImagePreview()">
            <div class="modal-inner" onclick="event.stopPropagation()">
                <button class="close-btn" onclick="hideImagePreview()">×</button>
                <img id="imagePreviewImg" src="" alt="Preview">
            </div>
        </div>
</body>
</html>
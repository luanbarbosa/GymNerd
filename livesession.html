<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GymFlow | Start Workout</title>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); max-width: 500px; margin: 0 auto; padding: 20px; }
        .header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .back-btn { text-decoration: none; font-size: 1.5rem; color: var(--text); }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        select, button { padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 1rem; width: 100%; box-sizing: border-box; }
        
        .exercise-list { margin-top: 20px; }
        .exercise-item { 
            background: white; 
            padding: 15px; 
            border-radius: 12px; 
            margin-bottom: 10px; 
            border: 1px solid #e2e8f0; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        .ex-thumb { width: 40px; height: 40px; border-radius: 6px; object-fit: cover; background: #f1f5f9; }
        .checkbox-wrapper { margin-left: auto; }
        input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }

        .start-btn { 
            background: var(--primary); 
            color: white; 
            border: none; 
            font-weight: bold; 
            cursor: pointer; 
            margin-top: 20px; 
            display: none;
        }

        .player-card { text-align: center; }
        .player-img { width: 100%; max-height: 250px; object-fit: contain; border-radius: 12px; margin-bottom: 15px; background: #f1f5f9; }
        .set-info { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .stat-box { background: #f1f5f9; padding: 15px; border-radius: 8px; }
        .stat-label { font-size: 0.7rem; text-transform: uppercase; color: #64748b; font-weight: bold; }
        .stat-value { font-size: 1.2rem; font-weight: 800; color: var(--primary); }

        .resume-card { background: #eff6ff; border: 2px solid var(--primary); padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        .resume-title { color: var(--primary); font-weight: bold; margin-bottom: 10px; display: block; font-size: 0.9rem; }

        .set-row { display: grid; grid-template-columns: 40px 1fr 1fr; gap: 10px; align-items: center; padding: 10px; border-radius: 8px; margin-bottom: 5px; background: #f8fafc; border: 1px solid transparent; }
        .set-row.completed { background: #dcfce7; border-color: var(--success); }
        .set-row.skipped { background: #f1f5f9; border-color: #cbd5e1; opacity: 0.8; }
        .set-row.active { background: #dbeafe; border-color: var(--primary); }
        .set-row input { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-size: 0.9rem; box-sizing: border-box; }
        .set-label { font-weight: bold; color: #64748b; font-size: 0.8rem; }

        .player-controls { display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-top: 20px; }
        .nav-btn { background: #e2e8f0; border: none; font-weight: bold; cursor: pointer; border-radius: 8px; }
        .finish-btn { background: var(--success); color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .skip-btn { background: #fee2e2; color: #ef4444; border: none; font-weight: bold; cursor: pointer; border-radius: 8px; padding: 12px; margin-top: 10px; width: 100%; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="setupView">
        <div class="header"><a href="index.html" class="back-btn">‚Üê</a><h2>Start Workout</h2></div>
        
        <div id="resumeCard" class="resume-card hidden">
            <span class="resume-title">üèÉ Unfinished session found</span>
            <div style="display:flex; gap:10px">
                <button onclick="resumeSession()" style="background:var(--primary); color:white; border:none; padding:10px; border-radius:8px; font-weight:bold; cursor:pointer; flex:2">Continue</button>
                <button onclick="discardSession()" style="background:white; color:#ef4444; border:1px solid #fee2e2; padding:10px; border-radius:8px; font-weight:bold; cursor:pointer; flex:1">Discard</button>
            </div>
        </div>

        <div class="card">
            <label style="font-size:0.8rem; font-weight:bold; display:block; margin-bottom:5px">Select a Workout</label>
            <select id="workoutSelect" onchange="loadExercises()">
                <option value="">-- Choose Workout --</option>
            </select>
        </div>

        <div id="exerciseContainer" class="exercise-list"></div>
        
        <button id="startBtn" class="start-btn" onclick="startSession()">üöÄ Start Session</button>
    </div>

    <div id="playerView" class="hidden">
        <div class="header"><button class="back-btn" style="background:none; border:none; padding:0; cursor:pointer" onclick="location.reload()">‚Üê</button><h2 id="currentExName">Exercise</h2></div>
        <div class="card player-card">
            <img id="playerImg" src="" class="player-img">
            <div id="setsContainer"></div>
            <div class="player-controls">
                <button class="nav-btn" onclick="prevSet()">Prev</button>
                <button id="nextBtn" class="start-btn" style="display:block; margin:0" onclick="nextSet()">Next Set</button>
            </div>
            <button id="skipBtn" class="skip-btn" onclick="abandonExercise()">‚è≠ Skip Exercise</button>
            <button id="finishBtn" class="finish-btn" style="display:none; width:100%; padding:12px; border-radius:8px" onclick="finishSession()">üèÅ Finish Workout</button>
        </div>
    </div>

    <script>
        const db = new Dexie("GymAppDB");
        db.version(6).stores({ 
            exercises: '++id, name, type, imageId', 
            logs: '++id, exerciseId, exerciseName, weight, reps, date, imageId', 
            workouts: '++id, name, exerciseIds', 
            images: '++id' 
        });

        let sessionSets = [];
        let currentIdx = 0;
        let currentWorkoutId = null;

        async function init() {
            const fallback = await db.images.get(0);
            if (!fallback) {
                await db.images.put({ id: 0, data: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM5NGFhYjgiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cmVjdCB4PSIzIiB5PSIzIiB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHJ4PSIyIiByeT0iMiIvPjxjaXJjbGUgY3g9IjguNSIgY3k9IjguNSIgcj0iMS41Ii8+PHBhdGggZD0iTTIxIDE1bC01LTUtNCA0LTQtNC04IDgiLz48L3N2Zz4=" });
            }
            const workouts = await db.workouts.toArray();
            const select = document.getElementById('workoutSelect');
            workouts.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w.id;
                opt.textContent = w.name;
                select.appendChild(opt);
            });
            checkActiveSession();
        }

        function checkActiveSession() {
            const saved = localStorage.getItem('gymFlow_activeSession');
            if (saved) {
                document.getElementById('resumeCard').classList.remove('hidden');
            }
        }

        function saveSessionState() {
            const state = { sessionSets, currentIdx, currentWorkoutId };
            localStorage.setItem('gymFlow_activeSession', JSON.stringify(state));
        }

        function clearSessionState() {
            localStorage.removeItem('gymFlow_activeSession');
        }

        function resumeSession() {
            const saved = localStorage.getItem('gymFlow_activeSession');
            if (!saved) return;
            const state = JSON.parse(saved);
            sessionSets = state.sessionSets;
            currentIdx = state.currentIdx;
            currentWorkoutId = state.currentWorkoutId;
            document.getElementById('setupView').classList.add('hidden');
            document.getElementById('playerView').classList.remove('hidden');
            renderSet();
        }

        function discardSession() {
            if (confirm("Discard unfinished workout?")) {
                clearSessionState();
                document.getElementById('resumeCard').classList.add('hidden');
            }
        }

        async function loadExercises() {
            const workoutId = parseInt(document.getElementById('workoutSelect').value);
            const container = document.getElementById('exerciseContainer');
            const startBtn = document.getElementById('startBtn');
            
            if (!workoutId) {
                container.innerHTML = "";
                startBtn.style.display = "none";
                return;
            }

            const workout = await db.workouts.get(workoutId);
            const allExercises = await db.exercises.toArray();
            
            container.innerHTML = "";
            for (const item of workout.exerciseIds) {
                const id = typeof item === 'object' ? item.id : item;
                const ex = allExercises.find(e => e.id === id);
                if (!ex) continue;

                const imgRecord = await db.images.get(ex.imageId || 0);
                const imgSrc = imgRecord ? imgRecord.data : "";

                const details = typeof item === 'object' 
                    ? `<br><small>${Array.isArray(item.sets) ? item.sets.length : item.sets} sets${!Array.isArray(item.sets) ? ` x ${item.reps} reps @ ${item.weight}kg` : ''}</small>` 
                    : '';

                const div = document.createElement('div');
                div.className = 'exercise-item';
                div.innerHTML = `
                    <img src="${imgSrc}" class="ex-thumb" onerror="this.style.display='none'">
                    <div><strong>${ex.name}</strong>${details}</div>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" class="ex-check" value="${id}" checked>
                    </div>
                `;
                container.appendChild(div);
            }
            startBtn.style.display = "block";
        }

        async function startSession() {
            const workoutId = parseInt(document.getElementById('workoutSelect').value);
            currentWorkoutId = workoutId;
            const workout = await db.workouts.get(workoutId);
            const allExercises = await db.exercises.toArray();
            const selectedChecks = Array.from(document.querySelectorAll('.ex-check:checked'));
            
            if (selectedChecks.length === 0) return alert("Please select at least one exercise.");

            sessionSets = [];
            for (const check of selectedChecks) {
                const exId = parseInt(check.value);
                const ex = allExercises.find(e => e.id === exId);
                const workoutEx = workout.exerciseIds.find(we => (typeof we === 'object' ? we.id : we) === exId);
                
                if (workoutEx && Array.isArray(workoutEx.sets)) {
                    workoutEx.sets.forEach((s, i) => {
                        sessionSets.push({
                            exId,
                            name: ex.name,
                            imageId: ex.imageId,
                            setNum: i + 1,
                            totalSets: workoutEx.sets.length,
                            reps: s.reps,
                            weight: s.weight,
                            completed: false,
                            skipped: false
                        });
                    });
                } else {
                    // Fallback for old structure
                    const setsCount = typeof workoutEx === 'object' ? (workoutEx.sets || 3) : 3;
                    const reps = typeof workoutEx === 'object' ? (workoutEx.reps || 0) : 0;
                    const weight = typeof workoutEx === 'object' ? (workoutEx.weight || 0) : 0;
                    for (let i = 1; i <= setsCount; i++) {
                        sessionSets.push({
                            exId,
                            name: ex.name,
                            imageId: ex.imageId,
                            setNum: i,
                            totalSets: setsCount,
                            reps,
                            weight,
                            completed: false,
                            skipped: false
                        });
                    }
                }
            }

            document.getElementById('setupView').classList.add('hidden');
            document.getElementById('playerView').classList.remove('hidden');
            renderSet();
        }

        async function renderSet() {
            saveSessionState();
            const currentSet = sessionSets[currentIdx];
            document.getElementById('currentExName').innerText = currentSet.name;
            
            const imgRecord = await db.images.get(currentSet.imageId || 0);
            document.getElementById('playerImg').src = imgRecord ? imgRecord.data : "";

            // Find contiguous sets for the same exercise occurrence
            let start = currentIdx;
            while (start > 0 && sessionSets[start - 1].exId === currentSet.exId) start--;
            let end = currentIdx;
            while (end < sessionSets.length - 1 && sessionSets[end + 1].exId === currentSet.exId) end++;

            const container = document.getElementById('setsContainer');
            container.innerHTML = "";
            
            for (let i = start; i <= end; i++) {
                const s = sessionSets[i];
                const isActive = i === currentIdx;
                const isCompleted = s.completed;
                const isSkipped = s.skipped;
                const row = document.createElement('div');
                row.className = `set-row ${isSkipped ? 'skipped' : (isCompleted ? 'completed' : '')} ${isActive ? 'active' : ''}`;
                row.innerHTML = `
                    <div class="set-label">${isSkipped ? '‚úîÔ∏è' : (isCompleted ? '‚úÖ' : 'S' + s.setNum)}</div>
                    <input type="number" value="${s.reps}" onchange="updateSetData(${i}, 'reps', this.value)" placeholder="Reps">
                    <input type="number" step="0.5" value="${s.weight}" onchange="updateSetData(${i}, 'weight', this.value)" placeholder="Kg">
                `;
                container.appendChild(row);
            }

            const isLast = currentIdx === sessionSets.length - 1;
            document.getElementById('nextBtn').innerText = isLast ? "Last Set Done" : "Next Set";
            document.getElementById('finishBtn').style.display = isLast ? "block" : "none";

            // Hide skip button if we are on the last exercise
            const currentExId = currentSet.exId;
            const hasMoreExercises = sessionSets.some((s, i) => i > currentIdx && s.exId !== currentExId);
            document.getElementById('skipBtn').style.display = hasMoreExercises ? "block" : "none";
        }

        function updateSetData(idx, field, value) {
            sessionSets[idx][field] = field === 'weight' ? parseFloat(value) || 0 : parseInt(value) || 0;
            saveSessionState();
        }

        function nextSet() {
            sessionSets[currentIdx].completed = true;
            if (currentIdx < sessionSets.length - 1) {
                currentIdx++;
            }
            renderSet();
        }

        function abandonExercise() {
            if (!confirm("Skip the rest of this exercise?")) return;
            const currentExId = sessionSets[currentIdx].exId;
            
            // Mark all remaining sets of this exercise as skipped
            sessionSets.forEach(s => {
                if (s.exId === currentExId && !s.completed) {
                    s.skipped = true;
                }
            });

            const nextExIdx = sessionSets.findIndex((s, i) => i > currentIdx && s.exId !== currentExId);
            if (nextExIdx !== -1) {
                currentIdx = nextExIdx;
            }
            renderSet();
        }

        function prevSet() {
            if (currentIdx > 0) {
                currentIdx--;
                renderSet();
            }
        }

        async function finishSession() {
            const date = new Date().toISOString().split('T')[0];

            // Update the workout template with the values used in this session
            if (currentWorkoutId) {
                const workout = await db.workouts.get(currentWorkoutId);
                if (workout) {
                    workout.exerciseIds = workout.exerciseIds.map(item => {
                        const exId = typeof item === 'object' ? item.id : item;
                        const sessionExSets = sessionSets.filter(s => s.exId === exId);
                        if (sessionExSets.length > 0) {
                            return {
                                id: exId,
                                sets: sessionExSets.map(s => ({ reps: s.reps, weight: s.weight }))
                            };
                        }
                        return item;
                    });
                    await db.workouts.put(workout);
                }
            }

            const logs = [];
            const groups = sessionSets.reduce((acc, s) => {
                if (!s.completed) return acc; // Only log completed sets
                if (!acc[s.exId]) acc[s.exId] = { ...s, count: 0 };
                acc[s.exId].count++;
                // Use the values from the sets (last completed set values will be stored)
                acc[s.exId].weight = s.weight;
                acc[s.exId].reps = s.reps;
                return acc;
            }, {});

            for (const id in groups) {
                const g = groups[id];
                logs.push({ exerciseId: g.exId, exerciseName: g.name, weight: g.weight, reps: g.reps, date, imageId: g.imageId, sets: g.count });
            }

            await db.logs.bulkAdd(logs);
            clearSessionState();
            alert("Workout saved!");
            location.href = "statistics.html";
        }

        init();
    </script>
</body>
</html>
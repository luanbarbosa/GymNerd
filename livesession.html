<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GymNerd | Start Routine</title>
    <link rel="icon" type="image/svg+xml" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <script src="auth.js"></script>
    <script src="drive-storage.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="db.js"></script>
    <style>
        :root { --primary: #3b82f6; --secondary: #94a3b8; --primary-grad: linear-gradient(135deg, #60a5fa 0%, #2563eb 100%); --secondary-grad: linear-gradient(135deg, #D1D5DB 0%, #9CA3AF 100%); --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --text-dim: #94a3b8; --success: #10b981; --danger: #ef4444; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); max-width: 500px; margin: 0 auto; padding: 0; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .header { display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; margin-bottom: 20px; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header h2 { font-weight: 800; letter-spacing: -0.5px; background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; }
        .back-btn { text-decoration: none; font-size: 1.5rem; color: var(--text); }
        .card { background: var(--card); padding: 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px; }
        .view-content { padding: 0 15px 20px 15px; }
        select, button { padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); font-size: 1rem; width: 100%; box-sizing: border-box; background: rgba(255,255,255,0.05); color: white; }
        
        .exercise-list { margin-top: 10px; }
        .exercise-item { 
            background: var(--card); 
            padding: 15px; 
            border-radius: 12px; 
            margin-bottom: 10px; 
            border: 1px solid rgba(255,255,255,0.05); 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        .ex-thumb { width: 64px; height: 44px; border-radius: 8px; object-fit: contain; object-position: center; background: #fff; flex-shrink: 0; }
        .player-img { background: #fff; }
        /* Reorder UI */
        .reorder-btn { display: none; border: none; background: rgba(255,255,255,0.03); color: var(--text); padding: 6px 8px; border-radius: 8px; cursor: pointer; font-weight: 800; }
        .reorder-btn:active { transform: scale(0.96); }
        .exercise-list.reorder-mode .reorder-btn { display: inline-flex; }

        .drag-handle { display:inline-flex; border:none; background:transparent; color:var(--text-dim); font-size:1.1rem; padding: 6px 8px; border-radius:8px; }
        .exercise-item.placeholder { border: 2px dashed rgba(255,255,255,0.06); background: rgba(255,255,255,0.02); }
        .dragging { position: fixed; z-index: 1000; pointer-events: none; transform: scale(1.02); box-shadow: 0 10px 30px rgba(0,0,0,0.4); opacity: 0.98; border-radius: 12px; }
        .checkbox-wrapper { margin-left: auto; }
        input[type="checkbox"] { width: 24px; height: 24px; cursor: pointer; accent-color: var(--primary); }

        .start-btn { 
            background: var(--primary-grad); 
            color: white; 
            border: none; 
            font-weight: bold; 
            cursor: pointer; 
            margin-top: 20px; 
            display: none;
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2);
        }

        .player-card { text-align: center; }
        .player-img { width: 100%; max-height: 250px; object-fit: contain; border-radius: 16px; margin-bottom: 15px; background: #fff; }
        .ex-nav-bar { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 25px; padding: 12px 16px; background: rgba(255,255,255,0.03); border-radius: 20px; border: 1px solid rgba(255,255,255,0.05); position: relative; overflow: hidden; }
        .ex-title-group { flex: 1; text-align: center; display: flex; flex-direction: column; gap: 2px; min-width: 0; }
        .current-ex-title { margin: 0; font-size: 1.4rem; font-weight: 900; letter-spacing: -0.5px; background: var(--secondary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .current-ex-subtitle { font-size: 0.7rem; color: var(--text-dim); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; opacity: 0.6; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .header-timer { display: flex; align-items: center; gap: 8px; background: rgba(59, 130, 246, 0.1); padding: 6px 12px; border-radius: 10px; border: 1px solid rgba(59, 130, 246, 0.2); cursor: pointer; }
        .timer-val { font-size: 1.2rem; font-weight: 800; color: white; font-variant-numeric: tabular-nums; }
        .progress-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: rgba(255,255,255,0.02); }
        .progress-bar { height: 100%; background: var(--primary-grad); width: 0%; transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .timer-reset { background: none; border: none; color: var(--text-dim); cursor: pointer; padding: 0; display: flex; align-items: center; transition: color 0.2s; width: auto !important; }
        .timer-reset:active { color: var(--primary); }

        .resume-card { background: rgba(59, 130, 246, 0.1); border: 1px solid var(--primary); padding: 15px; border-radius: 16px; margin-bottom: 20px; }
        .resume-title { color: var(--primary); font-weight: bold; margin-bottom: 10px; display: block; font-size: 0.9rem; }

        .set-row { display: grid; grid-template-columns: 40px 1fr 1fr; gap: 10px; align-items: center; padding: 12px; border-radius: 12px; margin-bottom: 8px; background: rgba(255,255,255,0.03); border: 1px solid transparent; transition: all 0.2s; }
        .set-row.completed { background: rgba(16, 185, 129, 0.1); border-color: var(--success); }
        .set-row.skipped { background: rgba(255,255,255,0.05); border-color: #475569; opacity: 0.5; }
        .set-row.active { background: rgba(59, 130, 246, 0.15); border-color: var(--primary); transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.2); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { border-color: var(--primary); } 50% { border-color: #60a5fa; } 100% { border-color: var(--primary); } }
        .set-row input { width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; text-align: center; font-size: 1rem; box-sizing: border-box; background: #000; color: white; }
        .set-label { font-weight: bold; color: var(--text-dim); font-size: 0.8rem; }

        .player-controls-icons { display: flex; justify-content: center; gap: 20px; margin-top: 25px; }
        .icon-btn { 
            width: 60px; 
            height: 60px; 
            border-radius: 50%; 
            border: none; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        .icon-btn:active { transform: scale(0.85); box-shadow: 0 2px 6px rgba(0,0,0,0.4); }
        .icon-btn.prev { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--text-dim); }
        .icon-btn.skip { background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2); }
        .icon-btn.next { background: var(--primary-grad); }

        .nav-ex-btn {
            background: none;
            border: none;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
            flex-shrink: 0;
            padding: 0;
        }
        .nav-ex-btn:disabled { opacity: 0.2; cursor: not-allowed; }
        .nav-ex-btn:active:not(:disabled) { transform: scale(0.8); color: var(--text); }

        .finish-btn { background: var(--success); color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 20px; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="setupView">
        <div class="header">
            <div class="header-left">
                <a href="index.html" class="back-btn">‚Üê</a>
                <h2>Start Routine</h2>
            </div>
        </div>
        
        <div class="view-content">
            <div id="resumeCard" class="resume-card" style="display: none;">
                <span class="resume-title">üèÉ Unfinished session found</span>
                <div style="display:flex; gap:10px">
                    <button onclick="resumeSession()" style="background:var(--primary); color:white; border:none; padding:10px; border-radius:8px; font-weight:bold; cursor:pointer; flex:2">Continue</button>
                    <button onclick="discardSession()" style="background:white; color:#ef4444; border:1px solid #fee2e2; padding:10px; border-radius:8px; font-weight:bold; cursor:pointer; flex:1">Discard</button>
                </div>
            </div>

            <div class="card">
                <label style="font-size:0.8rem; font-weight:bold; display:block; margin-bottom:5px">Select a Routine</label>
                <select id="workoutSelect" onchange="loadExercises()">
                    <option value="">-- Choose Routine --</option>
                </select>

                <div id="exerciseContainer" class="exercise-list"></div>
                <button id="startBtn" class="start-btn" onclick="startSession()">üöÄ Start Session</button>
            </div>
        </div>
    </div>

    <div id="playerView" style="display: none;">
        <div class="header">
            <div class="header-left">
                <a href="livesession.html" class="back-btn">‚Üê</a>
                <h2 id="playerWorkoutTitle">Routine</h2>
            </div>
            <div class="header-timer" onclick="startTimer()" title="Reset Timer">
                <div id="setTimer" class="timer-val">00:00</div>
                <button class="timer-reset">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                </button>
            </div>
        </div>
        <div class="view-content">
            <div class="ex-nav-bar">
                <button id="prevExBtn" class="nav-ex-btn" onclick="navExercise(-1)" title="Previous Exercise">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                </button>
                <div class="ex-title-group">
                    <h1 id="currentExName" class="current-ex-title">Exercise</h1>
                    <div id="currentExNamePT" class="current-ex-subtitle"></div>
                </div>
                <button id="nextExBtn" class="nav-ex-btn" onclick="navExercise(1)" title="Next Exercise">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </button>
                <div class="progress-container"><div id="progressBar" class="progress-bar"></div></div>
            </div>
            <div class="card player-card">
                <img id="playerImg" src="" class="player-img">
                <div id="setsContainer"></div>
                <button id="activateExBtn" class="start-btn" style="margin-top: 20px; display: block;" onclick="activateExercise()">üéØ Play this exercise</button>
                <div class="player-controls-icons">
                    <button class="icon-btn prev" onclick="prevSet()" title="Previous Set">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                    </button>
                    <button class="icon-btn skip" onclick="skipSet()" title="Skip Set">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                    <button id="nextBtn" class="icon-btn next" onclick="nextSet()" title="Complete Set">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    </button>
                </div>
                <button id="finishBtn" class="finish-btn" style="display:none; width:100%; padding:12px; border-radius:8px" onclick="finishSession()">üèÅ Finish Routine</button>
            </div>
        </div>
    </div>

    <script>

        let sessionSets = [];
        let currentIdx = 0;
        let viewingIdx = 0;
        let currentWorkoutId = null;
        let timerInterval = null;
        let seconds = 0;

        function formatTime(s) {
            const minutes = Math.floor(s / 60).toString().padStart(2, '0');
            const seconds = (s % 60).toString().padStart(2, '0');
            return `${minutes}:${seconds}`;
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function startTimer() {
            stopTimer();
            seconds = 0;
            const timerEl = document.getElementById('setTimer');
            if (timerEl) timerEl.innerText = formatTime(seconds);
            timerInterval = setInterval(() => {
                seconds++;
                if (timerEl) timerEl.innerText = formatTime(seconds);
            }, 1000);
        }

        async function init() {
            await ensureDbOpen();
            // Default images will use `defaultImage` defined in `db.js` when specific images are missing.
            const workouts = await db.routines.toArray();
            const select = document.getElementById('workoutSelect');
            workouts.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w.id;
                opt.textContent = w.name;
                select.appendChild(opt);
            });
            checkActiveSession();
        }

        function checkActiveSession() {
            const saved = localStorage.getItem('gymNerd_activeSession');
            if (saved) {
                document.getElementById('resumeCard').style.display = 'block';
            }
        }

        function saveSessionState() {
            const state = { sessionSets, currentIdx, viewingIdx, currentWorkoutId };
            localStorage.setItem('gymNerd_activeSession', JSON.stringify(state));
        }

        function clearSessionState() {
            localStorage.removeItem('gymNerd_activeSession');
        }

        async function resumeSession() {
            const saved = localStorage.getItem('gymNerd_activeSession');
            if (!saved) return;
            const state = JSON.parse(saved);
            sessionSets = state.sessionSets;
            currentIdx = state.currentIdx;
            viewingIdx = state.viewingIdx || state.currentIdx;
            currentWorkoutId = state.currentWorkoutId;

            const workout = await db.routines.get(currentWorkoutId);
            if (workout) document.getElementById('playerWorkoutTitle').innerText = workout.name;

            document.getElementById('setupView').style.display = 'none';
            document.getElementById('playerView').style.display = 'block';
            renderSet();
        }

        function discardSession() {
            if (confirm("Discard unfinished routine?")) {
                clearSessionState();
                document.getElementById('resumeCard').style.display = 'none';
            }
        }

        async function loadExercises() {
            const workoutId = parseInt(document.getElementById('workoutSelect').value);
            const container = document.getElementById('exerciseContainer');
            const startBtn = document.getElementById('startBtn');
            
            if (!workoutId) {
                container.innerHTML = "";
                startBtn.style.display = "none";
                return;
            }

            const workout = await db.routines.get(workoutId);
            const [catalogEx, customEx] = await Promise.all([
                db.catalog_exercises.toArray(),
                db.custom_exercises.toArray()
            ]);
            const allExercises = [
                ...catalogEx.map(ex => ({ ...ex, isCustom: false })),
                ...customEx.map(ex => ({ ...ex, isCustom: true }))
            ];
            
            container.innerHTML = "";
            for (const item of workout.exerciseIds) {
                const id = typeof item === 'object' ? item.id : item;
                const isCustom = typeof item === 'object' ? !!item.isCustom : false;
                const ex = allExercises.find(e => e.id === id && !!e.isCustom === isCustom);
                if (!ex) continue;

                const imgTable = isCustom ? db.custom_images : db.catalog_images;
                let imgSrc = defaultImage;
                if (ex.imageId) {
                    const imgRecord = await imgTable.get(ex.imageId);
                    if (imgRecord && imgRecord.data) imgSrc = imgRecord.data;
                }

                const details = typeof item === 'object' 
                    ? `<br><small>${Array.isArray(item.sets) ? item.sets.length : item.sets} sets${!Array.isArray(item.sets) ? ` x ${item.reps} reps @ ${item.weight}kg` : ''}</small>` 
                    : ''; 

                const div = document.createElement('div');
                div.className = 'exercise-item';
                div.innerHTML = `
                    <img src="${imgSrc}" class="ex-thumb" onerror="this.style.display='none'">
                    <div style="flex:1; min-width:0;"><strong>${ex.name}</strong>${details}</div>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <button class="drag-handle" title="Drag to reorder">‚ò∞</button>
                        <div class="checkbox-wrapper">
                            <input type="checkbox" class="ex-check" value="${id}" data-iscustom="${isCustom}" checked>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            }
            startBtn.style.display = "block";
            attachDragHandlers();
        }

        // --- Drag & drop reordering (touch-friendly) ---
        let _dragState = null;

        function attachDragHandlers() {
            const container = document.getElementById('exerciseContainer');
            if (!container) return;
            container.querySelectorAll('.drag-handle').forEach(h => {
                if (h._dragAttached) return;
                h.addEventListener('touchstart', _onHandleTouchStart, { passive: false });
                h.addEventListener('pointerdown', _onHandlePointerDown);
                h._dragAttached = true;
            });
        }

        function _onHandleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            _onHandlePointerDown(touch);
        }

        function _onHandlePointerDown(e) {
            const handle = e.target.closest('.drag-handle');
            if (!handle) return;
            const item = handle.closest('.exercise-item');
            if (!item) return;
            _startDrag(e, item);
        }

        function _startDrag(e, item) {
            _dragState = {
                draggingEl: item,
                container: document.getElementById('exerciseContainer'),
                placeholder: null,
                ghost: null,
                offsetY: 0
            };

            const rect = item.getBoundingClientRect();
            const clientY = e.clientY || (e.touches && e.touches[0].clientY);
            _dragState.offsetY = clientY - rect.top;

            const placeholder = document.createElement('div');
            placeholder.className = 'exercise-item placeholder';
            placeholder.style.height = rect.height + 'px';
            item.parentNode.insertBefore(placeholder, item.nextSibling);

            const ghost = item.cloneNode(true);
            ghost.classList.add('dragging');
            ghost.style.width = rect.width + 'px';
            ghost.style.left = rect.left + 'px';
            ghost.style.top = (clientY - _dragState.offsetY) + 'px';
            document.body.appendChild(ghost);

            item.style.display = 'none';

            _dragState.placeholder = placeholder;
            _dragState.ghost = ghost;

            window.addEventListener('touchmove', _onTouchMove, { passive: false });
            window.addEventListener('pointermove', _onPointerMove);
            window.addEventListener('touchend', _endDrag);
            window.addEventListener('pointerup', _endDrag);
        }

        function _onTouchMove(e) {
            e.preventDefault();
            const y = e.touches[0].clientY;
            _moveGhost(y);
        }

        function _onPointerMove(e) {
            const y = e.clientY;
            _moveGhost(y);
        }

        function _moveGhost(y) {
            if (!_dragState) return;
            const ghost = _dragState.ghost;
            ghost.style.top = (y - _dragState.offsetY) + 'px';

            const container = _dragState.container;
            let insertBefore = null;
            for (const child of Array.from(container.children)) {
                if (child === _dragState.draggingEl || child === _dragState.placeholder) continue;
                const r = child.getBoundingClientRect();
                const mid = r.top + r.height / 2;
                if (y < mid) { insertBefore = child; break; }
            }
            if (insertBefore) container.insertBefore(_dragState.placeholder, insertBefore);
            else container.appendChild(_dragState.placeholder);
        }

        function _endDrag() {
            if (!_dragState) return;
            const { draggingEl, placeholder, ghost } = _dragState;
            placeholder.parentNode.insertBefore(draggingEl, placeholder);
            draggingEl.style.display = '';
            placeholder.remove();
            if (ghost && ghost.parentNode) ghost.parentNode.removeChild(ghost);

            window.removeEventListener('touchmove', _onTouchMove);
            window.removeEventListener('pointermove', _onPointerMove);
            window.removeEventListener('touchend', _endDrag);
            window.removeEventListener('pointerup', _endDrag);
            _dragState = null;
        }

        async function startSession() {
            const workoutId = parseInt(document.getElementById('workoutSelect').value);
            currentWorkoutId = workoutId;
            const workout = await db.routines.get(workoutId);
            const [catalogEx, customEx] = await Promise.all([
                db.catalog_exercises.toArray(),
                db.custom_exercises.toArray()
            ]);
            const allExercises = [
                ...catalogEx.map(ex => ({ ...ex, isCustom: false })),
                ...customEx.map(ex => ({ ...ex, isCustom: true }))
            ];
            const container = document.getElementById('exerciseContainer');
            const selectedChecks = Array.from(container.querySelectorAll('.exercise-item')).map(div => div.querySelector('.ex-check')).filter(ch => ch && ch.checked);
            
            if (selectedChecks.length === 0) return alert("Please select at least one exercise.");

            sessionSets = [];
            document.getElementById('playerWorkoutTitle').innerText = workout.name;

            let occurrenceId = 0;
            for (const check of selectedChecks) {
                occurrenceId++;
                const exId = parseInt(check.value);
                const isCustom = check.dataset.iscustom === 'true';
                const ex = allExercises.find(e => e.id === exId && !!e.isCustom === isCustom);
                const workoutEx = workout.exerciseIds.find(we => {
                    const weId = typeof we === 'object' ? we.id : we;
                    const weIsCustom = typeof we === 'object' ? !!we.isCustom : false;
                    return weId === exId && weIsCustom === isCustom;
                });
                
                if (workoutEx && Array.isArray(workoutEx.sets)) {
                    workoutEx.sets.forEach((s, i) => {
                        sessionSets.push({
                            exId,
                            isCustom,
                            name: ex.name,
                            namePT: ex.namePT,
                            imageId: ex.imageId,
                            setNum: i + 1,
                            occurrenceId,
                            totalSets: workoutEx.sets.length,
                            reps: s.reps,
                            weight: s.weight,
                            completed: false,
                            skipped: false
                        });
                    });
                } else {
                    // Fallback for old structure
                    const setsCount = typeof workoutEx === 'object' ? (workoutEx.sets || 3) : 3;
                    const reps = typeof workoutEx === 'object' ? (workoutEx.reps || 0) : 0;
                    const weight = typeof workoutEx === 'object' ? (workoutEx.weight || 0) : 0;
                    for (let i = 1; i <= setsCount; i++) {
                        sessionSets.push({
                            exId,
                            isCustom,
                            name: ex.name,
                            namePT: ex.namePT,
                            imageId: ex.imageId,
                            setNum: i,
                            occurrenceId,
                            totalSets: setsCount,
                            reps,
                            weight,
                            completed: false,
                            skipped: false
                        });
                    }
                }
            }

            currentIdx = 0;
            viewingIdx = 0;
            document.getElementById('setupView').style.display = 'none';
            document.getElementById('playerView').style.display = 'block';
            renderSet();
        }

        async function renderSet() {
            saveSessionState();
            startTimer();
            
            const progressEl = document.getElementById('progressBar');
            if (progressEl) {
                const total = sessionSets.length;
                const completed = sessionSets.filter(s => s.completed || s.skipped).length;
                progressEl.style.width = `${total > 0 ? (completed / total) * 100 : 0}%`;
            }

            const viewingSet = sessionSets[viewingIdx];
            document.getElementById('currentExName').innerText = viewingSet.name;
            document.getElementById('currentExNamePT').innerText = viewingSet.namePT || "";
            
            const hasPrev = viewingSet.occurrenceId > sessionSets[0].occurrenceId;
            const hasNext = viewingSet.occurrenceId < sessionSets[sessionSets.length - 1].occurrenceId;
            document.getElementById('prevExBtn').disabled = !hasPrev;
            document.getElementById('nextExBtn').disabled = !hasNext;

            const imgTable = viewingSet.isCustom ? db.custom_images : db.catalog_images;
            let imgSrc = defaultImage;
            if (viewingSet.imageId) {
                const imgRecord = await imgTable.get(viewingSet.imageId);
                if (imgRecord && imgRecord.data) imgSrc = imgRecord.data;
            }
            document.getElementById('playerImg').src = imgSrc; 

            // Find contiguous sets for the same exercise occurrence
            let start = viewingIdx;
            while (start > 0 && sessionSets[start - 1].occurrenceId === viewingSet.occurrenceId) start--;
            let end = viewingIdx;
            while (end < sessionSets.length - 1 && sessionSets[end + 1].occurrenceId === viewingSet.occurrenceId) end++;

            const container = document.getElementById('setsContainer');
            container.innerHTML = "";
            
            for (let i = start; i <= end; i++) {
                const s = sessionSets[i];
                const isActive = i === currentIdx;
                const isCompleted = s.completed;
                const isSkipped = s.skipped;
                
                const skipIcon = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" style="color:var(--danger); vertical-align:middle"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
                const checkIcon = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" style="color:var(--success); vertical-align:middle"><polyline points="20 6 9 17 4 12"></polyline></svg>`;

                const row = document.createElement('div');
                row.className = `set-row ${isSkipped ? 'skipped' : (isCompleted ? 'completed' : '')} ${isActive ? 'active' : ''}`;
                row.innerHTML = `
                    <div class="set-label">${isSkipped ? skipIcon : (isCompleted ? checkIcon : 'S' + s.setNum)}</div>
                    <input type="number" value="${s.reps}" onchange="updateSetData(${i}, 'reps', this.value)" placeholder="Reps">
                    <input type="number" step="0.5" value="${s.weight}" onchange="updateSetData(${i}, 'weight', this.value)" placeholder="Kg">
                `;
                container.appendChild(row);
            }

            const allDone = sessionSets.every(s => s.completed || s.skipped);
            document.getElementById('finishBtn').style.display = allDone ? "block" : "none";

            const isActiveEx = currentIdx >= start && currentIdx <= end;
            const allSetsDone = sessionSets.slice(start, end + 1).every(s => s.completed || s.skipped);

            document.querySelector('.player-controls-icons').classList.toggle('hidden', !isActiveEx);
            document.getElementById('activateExBtn').classList.toggle('hidden', isActiveEx || allSetsDone);
        }

        function updateSetData(idx, field, value) {
            sessionSets[idx][field] = field === 'weight' ? parseFloat(value) || 0 : parseInt(value) || 0;
            saveSessionState();
        }

        function nextSet() {
            sessionSets[currentIdx].completed = true;
            sessionSets[currentIdx].skipped = false;
            if (currentIdx < sessionSets.length - 1) {
                const oldOcc = sessionSets[currentIdx].occurrenceId;
                currentIdx++;
                if (sessionSets[currentIdx].occurrenceId !== oldOcc) {
                    viewingIdx = currentIdx;
                }
            }
            renderSet();
        }

        function skipSet() {
            sessionSets[currentIdx].skipped = true;
            sessionSets[currentIdx].completed = false;
            if (currentIdx < sessionSets.length - 1) {
                const oldOcc = sessionSets[currentIdx].occurrenceId;
                currentIdx++;
                if (sessionSets[currentIdx].occurrenceId !== oldOcc) {
                    viewingIdx = currentIdx;
                }
            }
            renderSet();
        }

        function abandonExercise() {
            if (!confirm("Skip the rest of this exercise?")) return;
            const currentExId = sessionSets[currentIdx].exId;
            
            // Mark all remaining sets of this exercise as skipped
            sessionSets.forEach(s => {
                if (s.exId === currentExId && !s.completed) {
                    s.skipped = true;
                }
            });

            const nextExIdx = sessionSets.findIndex((s, i) => i > currentIdx && s.exId !== currentExId);
            if (nextExIdx !== -1) {
                currentIdx = nextExIdx;
            }
            renderSet();
        }

        function prevSet() {
            if (currentIdx > 0) {
                const oldOcc = sessionSets[currentIdx].occurrenceId;
                currentIdx--;
                if (sessionSets[currentIdx].occurrenceId !== oldOcc) {
                    viewingIdx = currentIdx;
                }
                renderSet();
            }
        }

        function navExercise(dir) {
            const currentOcc = sessionSets[viewingIdx].occurrenceId;
            if (dir > 0) {
                let next = viewingIdx;
                while (next < sessionSets.length && sessionSets[next].occurrenceId === currentOcc) next++;
                if (next < sessionSets.length) viewingIdx = next;
            } else {
                let prev = viewingIdx;
                while (prev > 0 && sessionSets[prev - 1].occurrenceId === currentOcc) prev--;
                if (prev > 0) {
                    prev--;
                    const prevOcc = sessionSets[prev].occurrenceId;
                    while (prev > 0 && sessionSets[prev - 1].occurrenceId === prevOcc) prev--;
                    viewingIdx = prev;
                }
            }
            renderSet();
        }

        function activateExercise() {
            const occId = sessionSets[viewingIdx].occurrenceId;
            const firstIncomplete = sessionSets.findIndex(s => s.occurrenceId === occId && !s.completed && !s.skipped);
            currentIdx = firstIncomplete !== -1 ? firstIncomplete : viewingIdx;
            renderSet();
        }

        async function finishSession() {
            try {
                // Ensure DB is open (iOS fix for stale connections)
                await ensureDbOpen();

                const now = new Date();
                const todayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

                // Calculate streak record before saving (Avoid uniqueKeys on iOS)
                const allLogs = await db.logs.toArray();
                const existingDates = [...new Set(allLogs.map(l => l.date))].sort();
                const oldRecord = calculateStreaks(existingDates).longest;
                const newRecord = calculateStreaks([...existingDates, todayStr]).longest;

                // Update the workout template with the values used in this session
                if (currentWorkoutId) {
                    const workout = await db.routines.get(currentWorkoutId);
                    if (workout) {
                        workout.exerciseIds = workout.exerciseIds.map(item => {
                            const exId = typeof item === 'object' ? item.id : item;
                            const isCustom = typeof item === 'object' ? !!item.isCustom : false;
                            const sessionExSets = sessionSets.filter(s => s.exId === exId && s.isCustom === isCustom);
                            if (sessionExSets.length > 0) {
                                return {
                                    id: exId,
                                    isCustom,
                                    sets: sessionExSets.map(s => ({ reps: s.reps, weight: s.weight }))
                                };
                            }
                            return item;
                        });
                        await db.routines.put(workout);
                    }
                }

                const logs = [];
                const groups = sessionSets.reduce((acc, s) => {
                    if (!s.completed) return acc; // Only log completed sets
                    if (!acc[s.exId]) acc[s.exId] = { ...s, count: 0 };
                    acc[s.exId].isCustom = s.isCustom;
                    acc[s.exId].count++;
                    // Use the values from the sets (last completed set values will be stored)
                    acc[s.exId].weight = s.weight;
                    acc[s.exId].reps = s.reps;
                    return acc;
                }, {});

                for (const id in groups) {
                    const g = groups[id];
                    logs.push({ exerciseId: g.exId, isCustom: g.isCustom, weight: g.weight, reps: g.reps, date: todayStr, sets: g.count });
                }

                await db.logs.bulkAdd(logs);
                clearSessionState();
                
                // Sync with Drive if available (with timeout to prevent hanging on iOS)
                if (typeof DriveStorage !== 'undefined' && DriveStorage.sync) {
                    try {
                        await Promise.race([
                            DriveStorage.sync(db, ['logs', 'routines']),
                            new Promise((_, reject) => setTimeout(() => reject(new Error("Sync timeout")), 8000))
                        ]);
                    } catch (syncErr) {
                        console.warn("Drive sync failed or timed out:", syncErr);
                    }
                }

                if (newRecord > oldRecord && newRecord > 1) {
                    alert(`üéâ NEW STREAK RECORD: ${newRecord} DAYS!`);
                }
                location.href = "statistics.html";
            } catch (err) {
                alert("DEBUG ERROR: " + err.message + "\n" + err.stack);
                console.error(err);
            }
        }

        init();
    </script>
</body>
</html>
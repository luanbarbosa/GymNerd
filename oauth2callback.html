<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>OAuth Callback</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
</head>
<body style="background:#0f172a;color:#fff;font-family:sans-serif;display:flex;align-items:center;justify-content:center;height:100vh;">
  <div style="text-align:center;max-width:420px;padding:20px;">
    <h2 id="oauth-title" style="margin-bottom:8px;">Signing you inâ€¦</h2>
    <p id="oauth-help" style="color:#94a3b8;margin-bottom:12px;">Please do not leave or refresh this page.</p>
    <!-- no visible code shown to the user -->
  </div>

  <script src="gn-i18n.js"></script>
  <script>
    (function(){
      function parseQuery(qs) {
        const params = {};
        qs.replace(/^\?/,'').split('&').forEach(pair => {
          if (!pair) return;
          const [k,v] = pair.split('=');
          params[decodeURIComponent(k)] = decodeURIComponent((v||'').replace(/\+/g,' '));
        });
        return params;
      }

      const params = parseQuery(window.location.search);
      const code = params.code;
      const error = params.error;

      function showMessage(msg) {
        // intentionally do not display the auth code; log for debugging only
        try { console.log('[oauth2callback] ' + msg); } catch(e) {}
      }

      if (code && window.opener) {
        try {
          window.opener.postMessage({ type: 'oauth2callback', code }, window.location.origin);
          showMessage((typeof GN_I18N !== 'undefined') ? GN_I18N.t('oauth_success_close') : 'Authentication successful. This window will close.');
          // Give opener a moment to receive message then close
          setTimeout(() => window.close(), 800);
        } catch (e) {
          showMessage((typeof GN_I18N !== 'undefined') ? GN_I18N.t('oauth_notify_fail') : 'Could not notify the app. Please return to the application and try again.');
        }
      } else if (code) {
        // No opener (standalone / iOS home-screen webapp). Persist the code
        // so the main app can pick it up and continue the PKCE exchange.
        try {
          sessionStorage.setItem('oauth2_code', code);
        } catch (e) {
          localStorage.setItem('oauth2_code', code);
        }

        showMessage((typeof GN_I18N !== 'undefined') ? GN_I18N.t('oauth_returning') : 'Authentication successful. Returning to app...');

        // Compute base path e.g. '/GymNerd/' from current pathname and
        // navigate back so the main page can detect the stored code.
        const base = window.location.pathname.replace(/\/[^\/]*$/, '/');
        setTimeout(() => {
          window.location.href = window.location.origin + base;
        }, 700);
      } else if (error) {
        const prefix = (typeof GN_I18N !== 'undefined' && GN_I18N.t('oauth_error_prefix')) ? GN_I18N.t('oauth_error_prefix') : 'Error: ';
        showMessage(prefix + error);
      } else {
        showMessage((typeof GN_I18N !== 'undefined') ? GN_I18N.t('oauth_no_code') : 'No code found in URL.');
      }

      // Apply localized static strings for title/help when available
      try {
        if (typeof GN_I18N !== 'undefined') {
          const t = GN_I18N.t.bind(GN_I18N);
          const titleEl = document.getElementById('oauth-title');
          const helpEl = document.getElementById('oauth-help');
          if (titleEl) titleEl.innerText = t('oauth_signing_in') || titleEl.innerText;
          if (helpEl) helpEl.innerText = t('oauth_callback_help') || helpEl.innerText;
        }
      } catch(e) {}
    })();
  </script>
</body>
</html>

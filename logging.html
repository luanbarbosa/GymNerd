<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GymNerd | Log</title>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --primary: #3b82f6; --primary-grad: linear-gradient(135deg, #60a5fa 0%, #2563eb 100%); --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --text-dim: #94a3b8; --success: #10b981; --danger: #ef4444; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); max-width: 500px; margin: 0 auto; padding: 20px; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .header h2 { font-weight: 800; letter-spacing: -0.5px; background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; }
        .back-btn { text-decoration: none; font-size: 1.5rem; color: var(--text); }
        .card { background: var(--card); padding: 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px; }
        select, input, button { padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); font-size: 1rem; width: 100%; box-sizing: border-box; background: rgba(255,255,255,0.05); color: white; }
        .exercise-row { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.05); display: grid; grid-template-columns: 50px 1fr 30px; gap: 15px; align-items: center; }
        .ex-thumb { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: #000; }
        .input-pair { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; grid-column: span 3; }
        .input-pair input { background: #000; }
        .save-session { background: var(--primary-grad); color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2); }
        .save-session.success { background: var(--success); }

        details.history-section { background: var(--card); border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); margin-top: 20px; }
        summary.section-header { font-weight: 800; cursor: pointer; padding: 15px 20px; list-style: none; display: flex; justify-content: space-between; align-items: center; color: var(--text-dim); }
        summary.section-header::after { content: '‚ñæ'; }
        details[open] summary.section-header::after { content: '‚ñ¥'; }

        details.month-group { margin-bottom: 15px; }
        summary.month-header { font-weight: 700; font-size: 0.85rem; color: var(--text-dim); cursor: pointer; padding: 8px 0; list-style: none; text-transform: uppercase; letter-spacing: 0.05em; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 10px; }
        summary.month-header::after { content: '‚ñæ'; }
        details[open] summary.month-header::after { content: '‚ñ¥'; }

        details.history-group { background: rgba(255,255,255,0.02); border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 10px; overflow: hidden; }
        summary.date-header { padding: 12px 15px; font-size: 0.85rem; font-weight: 800; cursor: pointer; list-style: none; display: flex; justify-content: space-between; }
        .log-entry { padding: 10px 15px; border-bottom: 1px solid rgba(255,255,255,0.02); display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; color: var(--text-dim); }
    </style>
</head>
<body>
    <div class="header"><a href="index.html" class="back-btn">‚Üê</a><h2>Log Session</h2></div>
    <div class="card">
        <select id="routinePicker" onchange="generateSheet()"><option value="">-- Choose Workout --</option></select>
        <input type="date" id="logDate" style="margin-top:10px">
    </div>
    <div id="workoutSheet"></div>
    <button id="saveBtn" class="save-session" style="display:none" onclick="saveSession()">üíæ Save Session</button>
    <details class="history-section">
        <summary class="section-header">Workout History</summary>
        <div id="history" style="padding: 0 15px 10px 15px;"></div>
    </details>

    <script>
        const db = new Dexie("GymAppDB");
        db.version(6).stores({ exercises: '++id, name, type, imageId', logs: '++id, exerciseId, exerciseName, weight, reps, date, imageId', workouts: '++id, name, exerciseIds', images: '++id' });
        
        document.getElementById('logDate').value = new Date().toISOString().split('T')[0];
        let allEx = [];

        async function init() {
            const fallback = await db.images.get(0);
            if (!fallback) {
                await db.images.put({ id: 0, data: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM5NGFhYjgiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cmVjdCB4PSIzIiB5PSIzIiB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHJ4PSIyIiByeT0iMiIvPjxjaXJjbGUgY3g9IjguNSIgY3k9IjguNSIgcj0iMS41Ii8+PHBhdGggZD0iTTIxIDE1bC01LTUtNCA0LTQtNC04IDgiLz48L3N2Zz4=" });
            }
            allEx = await db.exercises.toArray();
            const wks = await db.workouts.toArray();
            const p = document.getElementById('routinePicker');
            wks.forEach(w => p.innerHTML += `<option value="${w.id}">${w.name}</option>`);
            renderHistory();
        }

        async function generateSheet() {
            const id = parseInt(document.getElementById('routinePicker').value);
            const sheet = document.getElementById('workoutSheet');
            if(!id) { sheet.innerHTML=""; return; }
            const wk = await db.workouts.get(id);
            sheet.innerHTML = "";
            for (const item of wk.exerciseIds) {
                const id = typeof item === 'object' ? item.id : item;
                const ex = allEx.find(e => e.id === id);
                if (!ex) continue;
                const img = await db.images.get(ex.imageId || 0);
                
                let sets, weight, reps;
                if (typeof item === 'object') {
                    if (Array.isArray(item.sets)) {
                        sets = item.sets.length;
                        weight = item.sets[0]?.weight || '';
                        reps = item.sets[0]?.reps || '';
                    } else {
                        sets = item.sets || 3;
                        weight = item.weight || '';
                        reps = item.reps || '';
                    }
                } else {
                    sets = 3; weight = ''; reps = '';
                }

                sheet.innerHTML += `<div class="exercise-row" data-id="${ex.id}" data-name="${ex.name}" data-imgid="${ex.imageId || ''}">
                    <img src="${img ? img.data : ''}" class="ex-thumb"><strong>${ex.name}</strong><button onclick="this.parentElement.remove()">‚úï</button>
                    <div class="input-pair"><input type="number" placeholder="Sets" class="s" value="${sets}"><input type="number" step="0.5" placeholder="Kg" class="w" value="${weight}"><input type="number" placeholder="Reps" class="r" value="${reps}"></div></div>`;
            }
            document.getElementById('saveBtn').style.display = "block";
        }

        async function saveSession() {
            const date = document.getElementById('logDate').value;

            // Calculate streak record before saving
            const existingDates = await db.logs.orderBy('date').uniqueKeys();
            const calculateLongest = (dates) => {
                let max = 0, current = 0, prev = null;
                for (const dStr of dates) {
                    const [y, m, d] = dStr.split('-').map(Number);
                    const curr = new Date(y, m - 1, d);
                    if (prev) {
                        const diff = Math.round((curr - prev) / 86400000);
                        if (diff === 1) current++;
                        else { max = Math.max(max, current); current = 1; }
                    } else current = 1;
                    prev = curr;
                }
                return Math.max(max, current);
            };

            const oldRecord = calculateLongest(existingDates);
            const newDates = Array.from(new Set([...existingDates, date])).sort();
            const newRecord = calculateLongest(newDates);

            const logs = [];
            document.querySelectorAll('.exercise-row').forEach(r => {
                const sets = r.querySelector('.s').value;
                const weight = r.querySelector('.w').value;
                const reps = r.querySelector('.r').value;
                if(weight && reps) logs.push({ exerciseId: parseInt(r.dataset.id), exerciseName: r.dataset.name, imageId: parseInt(r.dataset.imgid) || null, sets: parseInt(sets) || 3, weight: parseFloat(weight), reps: parseInt(reps), date });
            });

            if (logs.length === 0) return alert("Please enter weight and reps for at least one exercise.");

            await db.logs.bulkAdd(logs);

            if (newRecord > oldRecord && newRecord > 1) {
                confetti({
                    particleCount: 150,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#3b82f6', '#10b981', '#f8fafc']
                });
                setTimeout(() => {
                    alert(`üéâ NEW STREAK RECORD: ${newRecord} DAYS!`);
                    location.href = "statistics.html";
                }, 1500);
            } else {
                alert("Workout saved!");
                location.href = "statistics.html";
            }
        }

        async function renderHistory() {
            const logs = await db.logs.orderBy('date').reverse().toArray();
            const groups = logs.reduce((acc, l) => {
                const month = l.date.substring(0, 7); // YYYY-MM
                if (!acc[month]) acc[month] = {};
                if (!acc[month][l.date]) acc[month][l.date] = [];
                acc[month][l.date].push(l);
                return acc;
            }, {});

            const container = document.getElementById('history');
            container.innerHTML = "";

            for (const month of Object.keys(groups).sort().reverse()) {
                const monthDet = document.createElement('details');
                monthDet.className = "month-group";
                const [y, m] = month.split('-');
                const monthName = new Date(y, m - 1).toLocaleString('default', { month: 'long', year: 'numeric' });
                monthDet.innerHTML = `<summary class="month-header">${monthName}</summary>`;
                
                for (const date of Object.keys(groups[month]).sort().reverse()) {
                    const dateDet = document.createElement('details');
                    dateDet.className = "history-group";
                    dateDet.innerHTML = `<summary class="date-header">${date}</summary>`;
                    for (const l of groups[month][date]) {
                        const img = await db.images.get(l.imageId || 0);
                        dateDet.innerHTML += `<div class="log-entry"><div style="display:flex;align-items:center;gap:8px"><img src="${img ? img.data : ''}" style="width:25px;height:25px;border-radius:4px;object-fit:cover"> ${l.exerciseName}</div> <span>${l.sets || 3} sets x ${l.weight}kg x ${l.reps}</span></div>`;
                    }
                    monthDet.appendChild(dateDet);
                }
                container.appendChild(monthDet);
            }
        }
        init();
    </script>
</body>
</html>
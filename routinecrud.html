<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GymNerd | Rotina</title>
    <link rel="icon" type="image/svg+xml" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <script src="auth.js"></script>
    <script src="gn-i18n.js"></script>
    <script src="drive-storage.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="db.js"></script>
    <style>
        :root { --primary: #3b82f6; --primary-grad: linear-gradient(135deg, #60a5fa 0%, #2563eb 100%); --secondary-grad: linear-gradient(135deg, #D1D5DB 0%, #9CA3AF 100%); --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --text-dim: #94a3b8; --success: #10b981; --danger: #ef4444; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); max-width: 500px; margin: 0 auto; padding: 20px; }
        .header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; justify-content:space-between }
        .header h2 { font-weight: 800; letter-spacing: -0.5px; background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; }
        .back-btn { text-decoration: none; font-size: 1.5rem; color: var(--text); }
        .card { background: var(--card); padding: 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px; }
        input, button { padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); font-size: 1rem; background: rgba(255,255,255,0.02); color: white; }
        button.primary { background: var(--primary-grad); color: white; border: none; font-weight: bold; cursor: pointer; }
        .add-set-btn { background: rgba(255,255,255,0.05); border: 1px dashed rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; cursor: pointer; color: var(--text-dim); margin-bottom: 10px; }
        .add-set-btn.prominent { background: var(--primary-grad); color: #fff; border: none; font-weight: 800; box-shadow: 0 8px 20px rgba(37,99,235,0.12); }
        .selected-ex-list { margin: 15px 0; display: flex; flex-direction: column; gap: 10px; }
        /* Empty state: larger dashed area and hint text; clickable to add exercises */
        .selected-ex-list:empty { min-height: 160px; border: 2px dashed rgba(255,255,255,0.06); border-radius: 12px; padding: 18px; align-items: center; justify-content: center; display: flex; cursor: pointer; }
        .selected-ex-list:empty::before { content: 'Nenhum exerc√≠cio ‚Äî clique em "Adicionar Exerc√≠cio" para come√ßar'; color: var(--text-dim); font-size: 0.95rem; text-align: center; }
        .selected-ex-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; }
        .set-row-input { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; }
        .set-row-input input { width: 70px; padding: 8px; font-size: 0.8rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: #000; }
        .ex-thumb { width: 64px; height: 44px; border-radius: 8px; object-fit: contain; object-position: center; background: #fff; flex-shrink: 0; }
        .hidden { display:none !important }
        .modal { position: fixed; top: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 500px; height: 100%; background: var(--bg); z-index: 1000; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        body.noselect, .noselect, .noselect * {
            user-select: none !important;
            -webkit-user-select: none !important;
            -ms-user-select: none !important;
        }
        .category-section { background: var(--card); border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); overflow: hidden; margin-bottom: 12px; }
        .category-summary { padding: 16px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; font-weight: 800; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.1em; }
        .exercise-grid { display: grid; gap: 12px; padding: 0 12px 16px 12px; }
        .exercise-grid .ex-thumb { width: 72px; height: 48px; border-radius: 10px; object-fit: contain; object-position: center; background: #fff; }
        .exercise-card { background: var(--card); border-radius: 16px; padding: 12px; display: flex; align-items: center; gap: 16px; border: 1px solid rgba(255,255,255,0.05); cursor: pointer; position: relative; }
        .exercise-card.selected .tick-icon {
            display: block;
        }
        .tick-icon {
            display: none;
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            z-index: 2;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="header" style="gap: 15px; justify-content: flex-start;">
        <a href="routines.html" class="back-btn" style="outline:none; box-shadow:none; border:none; background:none;">‚Üê</a>
        <h2 id="pageTitle" style="margin:0; text-align:left; flex:1;" data-i18n="page_routine_new">Nova Rotina</h2>
    </div>

    <div class="card">
        <div style="display:flex; flex-direction:column; gap:12px;">
            <label style="font-size:0.8rem; font-weight:800" data-i18n="routine_name_label">Nome da Rotina</label>
            <input id="routineName" data-i18n-placeholder="routine_name_placeholder" placeholder="ex.: Empurr√£o Superior" />
            <label style="font-size:0.8rem; font-weight:800; margin-top: 10px;" data-i18n="routine_exercises_label">Exerc√≠cios da Rotina</label>
            <button class="add-set-btn prominent" style="width:100%;" onclick="openSearchModal()" data-i18n="add_exercise">üîç Adicionar Exerc√≠cio</button>
            <div id="selectedList" class="selected-ex-list" onclick="if(this.children.length===0) openSearchModal()"></div>
            <div style="display:flex; gap:8px;">
                <button style="flex:1; width:100%; background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--text-dim); padding:12px; border-radius:12px;" onclick="location.href='routines.html'" data-i18n="cancel">Cancelar</button>
                <button class="primary" id="saveRoutineBtn" onclick="saveRoutine()" data-i18n="save_routine" style="flex:1; width:100%;">Salvar Rotina</button>
            </div>
        </div>
    </div>

    <!-- Search Modal (copied from routines.html) -->
    <div id="searchModal" class="modal hidden">
            <div class="header" style="gap: 15px; justify-content: flex-start;">
            <a href="javascript:void(0)" class="back-btn" onclick="closeSearchModal()" style="outline:none; box-shadow:none; border:none; background:none; font-size:1.5rem; color:var(--text); text-decoration:none;">‚Üê</a>
            <h2 style="margin:0; text-align:left; flex:1;" data-i18n="add_exercise_modal_title">Adicionar Exerc√≠cio</h2>
        </div>
        <div id="selectBar" class="hidden" aria-hidden="true">
            <div id="selectCount">0 selecionados</div>
            <div style="display:flex; gap:8px; align-items:center;">
                <button id="cancelSelectBtn" class="cancel-btn" onclick="exitSelectMode()" data-i18n="cancel">Cancelar</button>
                <button id="addSelectedBtn" class="add-btn" onclick="addSelectedExercisesFromModal()" disabled data-i18n="add_selected">Adicionar Selecionados</button>
            </div>
        </div>
        <div style="display:flex; flex-direction:column; gap:12px; margin-top:10px;">
            <button type="button" class="add-set-btn" style="border-style: solid; background: var(--card); color: var(--primary); font-weight: 800; margin-bottom: 10px;" onclick="openCreateModal()" data-i18n="custom_exercise_title">‚ûï Criar Exerc√≠cio Personalizado</button>
            <input type="text" id="modalSearchInput" placeholder="Pesquisar por nome..." data-i18n-placeholder="search_placeholder" oninput="updateModalResults()">
            <div id="modalResults" class="exercise-list" style="margin-top: 10px;"></div>
        </div>
    </div>

    <div id="customExModal" class="modal modal-sub hidden">
        <div class="header" style="gap: 15px; justify-content: flex-start;">
            <button class="back-btn" onclick="closeCustomModal()" style="outline:none; box-shadow:none; border:none; background:none;">‚Üê</button>
            <h2 id="customModalTitle" style="margin:0; text-align:left; flex:1;" data-i18n="custom_exercise_title">Exerc√≠cio Personalizado</h2>
        </div>
        <div style="display:flex; flex-direction:column; gap:12px; margin-top:10px;">
            <input type="hidden" id="exId">
            <label data-i18n="exercise_name_label">Nome</label>
            <input type="text" id="exName" placeholder="ex.: Supino Reto">
            <label data-i18n="exercise_name_pt_label">Nome (Portugu√™s)</label>
            <input type="text" id="exNamePT" placeholder="ex.: Supino Reto">
            <label data-i18n="exercise_type_label">Tipo</label>
            <select id="exType">
                <option value="chest">Peito</option>
                <option value="leg">Pernas</option>
                <option value="legs">Legs</option>
                <option value="back">Costas</option>
                <option value="shoulder">Ombros</option>
                <option value="arm">Bra√ßos</option>
                <option value="abs">Abdominais</option>
                <option value="cardio">Cardio</option>
            </select>
            <label data-i18n="exercise_image_label">Imagem</label>
            <input type="file" id="exImageInput" accept="image/*" onchange="handleImageUpload(event)" style="display:none">
            <div class="image-preview-box" onclick="document.getElementById('exImageInput').click()">
                <img id="exImagePreview" src="" class="hidden" style="width: 100%; height: 100%; object-fit: contain; object-position: center;">
                <div id="uploadPlaceholder">üì∏ Toque para enviar</div>
            </div>
            <button class="save-btn" onclick="saveCustomExercise()" data-i18n="save_exercise_btn">Salvar Exerc√≠cio</button>
        </div>
    </div>

    <script>
        let allExercises = [];
        let images = {};
        let selectMode = false;
        let selectedExercises = new Set();
        let pressTimer = null;
        let longPressTriggered = false;
        const PRESS_DURATION = 500;
        let currentImageData = null;
        let editingId = null;

        function getDisplayedName(ex) {
            try {
                const lang = (GN_I18N && GN_I18N.safeGetLang) ? GN_I18N.safeGetLang() : (navigator.language || 'en');
                const chosen = (lang && lang.toLowerCase().startsWith('pt') && ex.namePT) ? ex.namePT : ex.name;
                return chosen;
            } catch (e) { return ex.name; }
        }

        function startPressTimer(el, exId, isCustom, e) {
            pressTimer = setTimeout(() => {
                longPressTriggered = true;
                enterSelectMode();
                toggleSelect(exId, isCustom, el);
            }, PRESS_DURATION);
        }
        function cancelPressTimer() {
            if (pressTimer) { clearTimeout(pressTimer); pressTimer = null; }
            setTimeout(() => { longPressTriggered = false; }, 50);
        }
        function handleCardClick(exId, isCustom, el, e) {
            if (longPressTriggered) { longPressTriggered = false; return; }
            if (selectMode) { toggleSelect(exId, isCustom, el); }
            else { addExerciseToRoutine(exId, [], isCustom); closeSearchModal(); }
        }
        function enterSelectMode() {
            selectMode = true;
            selectedExercises = new Set();
            document.getElementById('selectBar').classList.remove('hidden');
            updateSelectBar();
            document.getElementById('modalResults').classList.add('select-mode');
            document.body.classList.add('noselect');
            window.addEventListener('contextmenu', preventContextMenu, true);
        }
        function exitSelectMode() {
            selectMode = false;
            selectedExercises.clear();
            document.getElementById('selectBar').classList.add('hidden');
            document.getElementById('modalResults').classList.remove('select-mode');
            document.querySelectorAll('.exercise-card.selected').forEach(c => c.classList.remove('selected'));
            updateSelectBar();
            document.body.classList.remove('noselect');
            window.removeEventListener('contextmenu', preventContextMenu, true);
        }
        function preventContextMenu(e) { e.preventDefault(); }
        function toggleSelect(exId, isCustom, el) { const key = `${isCustom ? 'c' : 's'}:${exId}`; if (selectedExercises.has(key)) { selectedExercises.delete(key); el.classList.remove('selected'); } else { selectedExercises.add(key); el.classList.add('selected'); } updateSelectBar(); }
        function updateSelectBar() { 
            const count = selectedExercises.size; 
            const selText = (window.GN_I18N && GN_I18N.t) ? GN_I18N.t('selected') : 'selecionados';
            const selectCountEl = document.getElementById('selectCount');
            if (selectCountEl) selectCountEl.innerText = `${count} ${selText}`;
            const addBtn = document.getElementById('addSelectedBtn');
            if (addBtn) {
                addBtn.disabled = count === 0;
                if (window.GN_I18N && GN_I18N.t) addBtn.textContent = GN_I18N.t('add_selected');
            }
        }
        function addSelectedExercisesFromModal() { for (const key of Array.from(selectedExercises)) { const [prefix, idStr] = key.split(':'); const isCustom = prefix === 'c'; const id = parseInt(idStr); addExerciseToRoutine(id, [], isCustom); } exitSelectMode(); closeSearchModal(); }

        async function init() {
            await ensureDbOpen();
            const [catalogEx, catalogImgs, customEx, customImgs] = await Promise.all([
                db.catalog_exercises.toArray(),
                db.catalog_images.toArray(),
                db.custom_exercises.toArray(),
                db.custom_images.toArray()
            ]);
            images = {};
            catalogImgs.forEach(img => images[img.id] = img.data);
            customImgs.forEach(img => images[img.id] = img.data);
            allExercises = [ ...catalogEx.map(ex => ({ ...ex, isCustom: false })), ...customEx.map(ex => ({ ...ex, isCustom: true })) ];
            updateModalResults();

            // If editing load routine
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            if (id) {
                editingId = parseInt(id);
                document.getElementById('pageTitle').innerText = 'Editar Rotina';
                const workout = await db.routines.get(editingId);
                if (workout) {
                    document.getElementById('routineName').value = workout.name;
                    for (const item of workout.exerciseIds) {
                        const exId = typeof item === 'object' ? item.id : item;
                        const isCustom = typeof item === 'object' ? !!item.isCustom : false;
                        const sets = Array.isArray(item.sets) ? item.sets : [];
                        addExerciseToRoutine(exId, sets, isCustom);
                    }
                }
            }
        }

        function openSearchModal() { document.getElementById('searchModal').classList.remove('hidden'); updateModalResults(); }
        function closeSearchModal() { document.getElementById('searchModal').classList.add('hidden'); }

        function updateModalResults() {
            const rawQuery = (document.getElementById('modalSearchInput').value || '').trim();
            const lang = (GN_I18N && GN_I18N.safeGetLang) ? GN_I18N.safeGetLang() : (navigator.language || 'en');
            const resultsDiv = document.getElementById('modalResults');

            // Normalizes strings: lowercase, remove diacritics, remove non-alphanumerics
            function normalizeForSearch(s) {
                if (!s) return '';
                try {
                        return s.toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9]/g, '');
                } catch (e) {
                    return s.toString().toLowerCase().replace(/[^a-z0-9]/g, '');
                }
            }

            // Subsequence match (characters in order, not necessarily contiguous)
            function isSubsequence(needle, haystack) {
                if (!needle) return false;
                let i = 0, j = 0;
                while (i < needle.length && j < haystack.length) {
                    if (needle[i] === haystack[j]) i++;
                    j++;
                }
                return i === needle.length;
            }

            const qNorm = normalizeForSearch(rawQuery);
            const tokens = rawQuery.split(/\s+/).filter(Boolean).map(t => normalizeForSearch(t)).filter(Boolean);

            const filtered = allExercises.filter(ex => {
                // If no query, include all
                if (!qNorm) return true;
                const name = normalizeForSearch(ex.name || '');
                const namePT = normalizeForSearch(ex.namePT || '');

                // direct contains match on normalized strings
                if (name.includes(qNorm) || namePT.includes(qNorm)) return true;

                // tokens: if any token matches as subsequence in either name, accept (loose match)
                for (const t of tokens) {
                    if (!t) continue;
                    if (isSubsequence(t, name) || isSubsequence(t, namePT)) return true;
                }

                // initials fallback: e.g., 'tmr' -> 'treadmill running'
                const initials = (ex.name || '').split(/\s+/).map(w => (w[0] || '')).join('');
                if (normalizeForSearch(initials).includes(qNorm)) return true;

                return false;
            });

            if (filtered.length === 0) { resultsDiv.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-dim)">Nenhum exerc√≠cio encontrado</div>'; return; }
            const groups = filtered.reduce((acc, ex) => { if (!acc[ex.type]) acc[ex.type] = []; acc[ex.type].push(ex); return acc; }, {});
            resultsDiv.innerHTML = Object.keys(groups).sort().map(type => {
                const displayType = (window.GN_I18N && GN_I18N.localizeExerciseType) ? GN_I18N.localizeExerciseType(type) : type;
                const itemsHtml = groups[type].map(ex => {
                    const ptLine = ((lang && lang.toLowerCase().startsWith('pt')) && ex.namePT) ? `<div style="color:var(--text-dim); font-size:0.85rem">${ex.namePT}</div>` : '';
                    const editBtn = ex.isCustom ? `<button style="background:none;border:none;color:var(--primary);" onclick="editExercise(${ex.id})">Editar</button>` : '';
                    return `<div class="exercise-card" onmousedown="startPressTimer(this, ${ex.id}, ${!!ex.isCustom}, event)" onmouseup="cancelPressTimer()" onmouseleave="cancelPressTimer()" ontouchstart="startPressTimer(this, ${ex.id}, ${!!ex.isCustom}, event)" ontouchmove="cancelPressTimer()" ontouchcancel="cancelPressTimer()" ontouchend="cancelPressTimer()" onclick="handleCardClick(${ex.id}, ${!!ex.isCustom}, this, event)" oncontextmenu="event.preventDefault()">
                                <img src="${images[ex.imageId] || ''}" class="ex-thumb">
                                <div style="flex-grow:1">
                                    <div style="font-weight:700">${getDisplayedName(ex)}</div>
                                    ${ptLine}
                                </div>
                                <div style="display:flex; gap:8px; align-items:center;">
                                    ${editBtn}
                                </div>
                                <svg class="tick-icon" viewBox="0 0 32 32" fill="none">
                                    <circle cx="16" cy="16" r="16" fill="var(--success)"/>
                                    <path d="M10 17.5l5 5 7-9" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>`;
                }).join('');

                return `
                <details class="category-section">
                    <summary class="category-summary">
                        <span>${displayType}</span>
                        <svg class="chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </summary>
                    <div class="exercise-grid">
                        ${itemsHtml}
                    </div>
                </details>
            `;
            }).join('');
        }

        function addExerciseToRoutine(exId, sets = [], isCustom = false) {
            const ex = allExercises.find(e => e.id === exId && !!e.isCustom === !!isCustom);
            if (!ex) return;
            const container = document.getElementById('selectedList');
            const card = document.createElement('div');
            card.className = 'selected-ex-card';
            card.dataset.id = exId;
            card.dataset.isCustom = isCustom;
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <img src="${images[ex.imageId] || ''}" class="ex-thumb">
                        <strong>${getDisplayedName(ex)}</strong>
                    </div>
                    <button type="button" class="remove-set-btn" onclick="this.closest('.selected-ex-card').remove()">√ó</button>
                </div>
                <div class="sets-container"></div>
                <button type="button" class="add-set-btn" onclick="addSetRowToCard(this)">+ Adicionar S√©rie</button>
            `;
            container.appendChild(card);
            const setsContainer = card.querySelector('.sets-container');
            if (sets.length > 0) sets.forEach((s, i) => addSetRowToContainer(setsContainer, i+1, s.reps, s.weight)); else addSetRowToContainer(setsContainer, 1);
        }
        function addSetRowToCard(btn) { const container = btn.previousElementSibling; const nextNum = container.children.length + 1; addSetRowToContainer(container, nextNum); }
        function addSetRowToContainer(container, num, reps = '', weight = '') { const div = document.createElement('div'); div.className = 'set-row-input'; div.innerHTML = `<span style="font-size:0.7rem; color:#64748b; width:20px">S${num}</span><input type="number" placeholder="Repeti√ß√µes" class="set-reps" value="${reps}"><input type="number" step="0.5" placeholder="Kg" class="set-weight" value="${weight}"><button type="button" class="remove-set-btn" onclick="removeSetRow(this)">√ó</button>`; container.appendChild(div); }
        function removeSetRow(btn) { const container = btn.parentElement.parentElement; btn.parentElement.remove(); Array.from(container.children).forEach((row, i) => { row.querySelector('span').innerText = `S${i + 1}`; }); }

        function getSelectedExercisesData() { return Array.from(document.querySelectorAll('.selected-ex-card')).map(card => { const id = parseInt(card.dataset.id); const isCustom = card.dataset.isCustom === 'true'; const sets = Array.from(card.querySelectorAll('.set-row-input')).map(row => ({ reps: parseInt(row.querySelector('.set-reps').value) || 0, weight: parseFloat(row.querySelector('.set-weight').value) || 0 })); return { id, sets, isCustom }; }); }

        async function saveRoutine() {
            const name = document.getElementById('routineName').value.trim();
            const exerciseIds = getSelectedExercisesData();
            if (!name || exerciseIds.length === 0) return alert((typeof GN_I18N !== 'undefined') ? GN_I18N.t('missing_routine_name') : 'Falta nome ou exerc√≠cios na rotina');
            if (editingId) {
                await db.routines.update(editingId, { name, exerciseIds });
                localStorage.setItem('has_local_changes', 'true');
                location.href = 'routines.html?id=' + editingId;
            } else {
                const id = await db.routines.add({ name, exerciseIds });
                localStorage.setItem('has_local_changes', 'true');
                location.href = 'routines.html?id=' + id;
            }
        }

        // Minimal custom-exercise handlers (reused)
        function openCreateModal() { document.getElementById('customModalTitle').innerText = 'Exerc√≠cio Personalizado'; document.getElementById('exId').value = ''; document.getElementById('exName').value = ''; document.getElementById('exNamePT').value = ''; document.getElementById('exType').selectedIndex = 0; currentImageData = null; document.getElementById('exImagePreview').classList.add('hidden'); document.getElementById('uploadPlaceholder').classList.remove('hidden'); document.getElementById('customExModal').classList.remove('hidden'); }
        function closeCustomModal() { document.getElementById('customExModal').classList.add('hidden'); }
        function handleImageUpload(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { const img = new Image(); img.onload = function() { const canvas = document.createElement('canvas'); const MAX_WIDTH = 400; const scaleSize = MAX_WIDTH / img.width; canvas.width = MAX_WIDTH; canvas.height = img.height * scaleSize; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height); currentImageData = canvas.toDataURL('image/jpeg', 0.7); document.getElementById('exImagePreview').src = currentImageData; document.getElementById('exImagePreview').classList.remove('hidden'); document.getElementById('uploadPlaceholder').classList.add('hidden'); }; img.src = e.target.result; }; reader.readAsDataURL(file); }
        async function saveCustomExercise() { const id = document.getElementById('exId').value; const name = document.getElementById('exName').value.trim(); const namePT = document.getElementById('exNamePT').value.trim(); const type = document.getElementById('exType').value; if (!name) { alert((typeof GN_I18N !== 'undefined') ? GN_I18N.t('please_enter_exercise_name') : 'Por favor, insira um nome para o exerc√≠cio.'); return; } try { await ensureDbOpen(); let imageId = 0; if (currentImageData) { imageId = Date.now(); await db.custom_images.put({ id: imageId, data: currentImageData }); } const exerciseData = { name, namePT, type, imageId }; if (id) { await db.custom_exercises.update(parseInt(id), exerciseData); alert((typeof GN_I18N !== 'undefined') ? GN_I18N.t('exercise_updated') : 'Exerc√≠cio atualizado!'); } else { await db.custom_exercises.add(exerciseData); alert((typeof GN_I18N !== 'undefined') ? GN_I18N.t('exercise_saved_local') : 'Exerc√≠cio salvo na sua cole√ß√£o local!'); } localStorage.setItem('has_local_changes', 'true'); closeCustomModal(); await init(); } catch (err) { console.error('Error saving custom exercise:', err); alert((typeof GN_I18N !== 'undefined') ? (GN_I18N.t('failed_to_save_exercise_prefix') + err.message) : ('Falha ao salvar exerc√≠cio: ' + err.message)); } }

        function copyExercise(exId, isCustom = false) { const ex = allExercises.find(e => e.id === exId && !!e.isCustom === !!isCustom); if (!ex) return; document.getElementById('exId').value = ''; document.getElementById('exName').value = ex.name; document.getElementById('exNamePT').value = ex.namePT || ''; document.getElementById('exType').value = ex.type; const imgData = images[ex.imageId]; if (imgData) { currentImageData = imgData; document.getElementById('exImagePreview').src = imgData; document.getElementById('exImagePreview').classList.remove('hidden'); document.getElementById('uploadPlaceholder').classList.add('hidden'); } else { currentImageData = null; document.getElementById('exImagePreview').src = ''; document.getElementById('exImagePreview').classList.remove('hidden'); document.getElementById('uploadPlaceholder').classList.add('hidden'); } document.getElementById('customModalTitle').innerText = 'Copiar Exerc√≠cio'; document.getElementById('customExModal').classList.remove('hidden'); }
        function editExercise(exId) { const ex = allExercises.find(e => e.id === exId && e.isCustom); if (!ex) return; document.getElementById('exId').value = ex.id; document.getElementById('exName').value = ex.name; document.getElementById('exNamePT').value = ex.namePT || ''; document.getElementById('exType').value = ex.type; const imgData = images[ex.imageId]; if (imgData) { currentImageData = imgData; document.getElementById('exImagePreview').src = imgData; document.getElementById('exImagePreview').classList.remove('hidden'); document.getElementById('uploadPlaceholder').classList.add('hidden'); } else { currentImageData = null; document.getElementById('exImagePreview').src = ''; document.getElementById('exImagePreview').classList.remove('hidden'); document.getElementById('uploadPlaceholder').classList.add('hidden'); } document.getElementById('customModalTitle').innerText = 'Editar Exerc√≠cio'; document.getElementById('customExModal').classList.remove('hidden'); }

        // Apply translations and localized title
        try {
            if (window.GN_I18N) {
                GN_I18N.applyTranslations(document);
                document.title = GN_I18N.t('title_main') + ' | ' + (new URLSearchParams(window.location.search).get('id') ? GN_I18N.t('page_routine_edit') : GN_I18N.t('page_routine_new'));
            }
        } catch(e){}

        window.addEventListener('load', init);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#ffffff">
    <title>GymNerd | Rotina</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="apple-touch-icon" href="favicon.svg">
    <link href="https://fonts.googleapis.com" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,300,0,0" rel="stylesheet">
    <script src="auth.js"></script>
    <script src="gn-i18n.js"></script>
    <script src="drive-storage.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="db.js"></script>
    <style>
        :root { --primary: #3b82f6; --primary-grad: linear-gradient(135deg, #60a5fa 0%, #2563eb 100%); --secondary-grad: linear-gradient(135deg, #D1D5DB 0%, #9CA3AF 100%); --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --text-dim: #94a3b8; --success: #10b981; --danger: #ef4444; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); max-width: 500px; margin: 0 auto; padding: 0; }
        .header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; justify-content:space-between }
        .header h2 { font-weight: 800; letter-spacing: -0.5px; background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; }
        .back-btn { text-decoration: none; font-size: 1.5rem; color: var(--bg); }
        /* Top-card (same style used on index.html / history) */
        .top-card { position: static; background: linear-gradient(180deg, #ffffff 0%, #ffffff 70%, #f3f4f6 100%); color: #0f172a; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; padding: 10px 16px 6px; box-shadow: 0 6px 16px rgba(2,6,23,0.06); padding-top: calc(10px + constant(safe-area-inset-top)); padding-top: calc(10px + env(safe-area-inset-top)); }
        body::before { content: ''; position: fixed; top: 0; left: 0; right: 0; height: constant(safe-area-inset-top); height: env(safe-area-inset-top); background: #ffffff; z-index: 1100; pointer-events: none; }
        .top-card-inner { max-width: 100%; display:flex; flex-direction:column; align-items:center; gap:8px; padding-bottom: 2px; }
        .page-content { padding: 16px; padding-top: 12px; }
        .top-card .topbar { background: transparent; padding: 6px 0; display:flex; align-items:center; justify-content:space-between; width:100%; }
        .top-card .back-btn { color: inherit; }
        /* Ensure back button icons are vertically centered inside top bars */
        .top-card .back-btn, .top-card .back-btn .material-symbols-outlined { display: inline-flex; align-items: center; justify-content: center; line-height: 1; }
        /* Slightly taller top-card for the main screen (match history) */
        body > .top-card { padding: calc(14px + env(safe-area-inset-top)) 16px 12px; padding-top: calc(14px + constant(safe-area-inset-top)); }
        .top-card-inner { padding-bottom: 6px; }
          /* Make top-cards inside modals extend to the modal edges (compensate modal padding)
              and match the taller height used on the main History top-card. */
          .modal > .top-card, .modal .top-card { margin: -20px -20px 0 -20px; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; padding: calc(14px + env(safe-area-inset-top)) 16px 12px; padding-top: calc(14px + constant(safe-area-inset-top)); }
        .card { background: var(--card); padding: 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px; }
        input, button { box-sizing: border-box; max-width: 100%; padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); font-size: 1rem; background: rgba(255,255,255,0.02); color: white; }
        /* Make the modal search input visually pop when unfocused (not selected) */
        #modalSearchInput {
            background: rgba(59,130,246,0.14); /* brighter blue tint for stronger pop */
            border: 1px solid rgba(59,130,246,0.30);
            box-shadow: 0 8px 22px rgba(59,130,246,0.08);
            transition: box-shadow 180ms ease, border-color 180ms ease, background 180ms ease;
            color: var(--text);
            outline: none;
            width: 100%;
            padding-right: 44px; /* make room for clear button */
        }
        /* Focused state (keeps stronger accent) */
        #modalSearchInput:focus {
            background: rgba(255,255,255,0.02);
            border-color: rgba(59,130,246,0.95);
            box-shadow: 0 14px 40px rgba(37,99,235,0.18);
        }
        /* Slightly adjust clear button color to match new accent */
        .clear-search-btn { color: rgba(255,255,255,0.9); }
        button.primary { background: var(--primary-grad); color: white; border: none; font-weight: bold; cursor: pointer; }
        .add-set-btn { background: rgba(255,255,255,0.05); border: 1px dashed rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; cursor: pointer; color: var(--text-dim); margin-bottom: 10px; }
        .add-set-btn.prominent { background: var(--primary-grad); color: #fff; border: none; font-weight: 800; box-shadow: 0 8px 20px rgba(37,99,235,0.12); }
        /* Make the main "Search Exercise" button taller for better tap targets */
        #openSearchBtn { min-height: 56px; padding: 14px 16px; font-size: 1.05rem; display: inline-flex; align-items: center; justify-content: center; }
        .top-action-btn { padding: 10px 14px; min-height: 44px; border-radius: 10px; font-weight: 800; display: inline-flex; align-items: center; gap:8px; }
        /* Ensure the modal "new/custom" button label is uppercase */
        #newCustomBtn { text-transform: uppercase; letter-spacing: 0.02em; }
        /* Ensure action buttons in top-cards (modal or main) are vertically centered */
        .top-card .top-card-inner > div { align-items: center !important; }
        .top-card .top-action-wrapper { display:flex; align-items:center; }
        .top-card .top-action-wrapper .top-action-btn { margin: 0; align-self: center; height: 44px; }
        .clear-search-btn { width:36px; height:36px; border-radius:8px; display:none; align-items:center; justify-content:center; background:transparent; border:none; color:var(--text-dim); cursor:pointer; }
        .clear-search-btn svg { width:16px; height:16px; }
        .selected-ex-list { margin: 15px 0; display: flex; flex-direction: column; gap: 10px; }
        /* Empty state: larger dashed area and hint text; clickable to add exercises (localized via .empty-hint) */
        .selected-ex-list.empty { min-height: 160px; border: 2px dashed rgba(255,255,255,0.06); border-radius: 12px; padding: 18px; align-items: center; justify-content: center; display: flex; cursor: pointer; }
        .selected-ex-list .empty-hint { color: var(--text-dim); font-size: 0.95rem; text-align: center; }
        .selected-ex-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; }
        .selected-ex-card.invalid { border-color: rgba(239,68,68,0.9); box-shadow: 0 8px 24px rgba(239,68,68,0.06); }
        .form-errors { background: rgba(239,68,68,0.04); border-left: 4px solid var(--danger); color: var(--danger); padding: 10px 12px; border-radius: 8px; margin-top: 8px; font-weight:700; }
        .card-error { color: var(--danger); background: rgba(239,68,68,0.03); padding: 6px 8px; border-radius: 6px; margin-top: 8px; font-size:0.85rem; }
        /* per-set inputs removed - keeping UI minimal for routine creation */
        /* Large thumbnail for modal cards (image on top) */
        .exercise-card > div > .ex-thumb { display:block; width:100%; height:auto; max-height:150px; border-radius: 12px; object-fit: contain; object-position: center; background: #fff; }
        /* Larger thumbnail for selected list cards (keeps layout horizontal) */
        .selected-ex-card { display:flex; flex-direction:column; gap:8px; align-items:flex-start; position:relative; overflow: hidden; }
        .selected-ex-card .ex-thumb { width:110px; height:72px; max-width:110px; border-radius:8px; object-fit:contain; object-position:center; background:#fff; display:block; align-self:flex-start; }
        /* place remove button top-right */
        .selected-ex-card > .remove-set-btn { position:absolute; top:8px; right:8px; z-index:2; outline:none; border:none; background:transparent; padding:4px; }
        .selected-ex-card > .remove-set-btn:focus { outline:none; box-shadow:none; }
        .selected-ex-card > div:first-child { display:flex; flex-direction:column; gap:8px; width:100%; margin-bottom:0; }
        .selected-ex-card > div:first-child > div { display:flex; flex-direction:column; gap:6px; min-width:0; }
        .selected-ex-card strong { display:block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .hidden { display:none !important }
        .exercise-card { background: var(--card); border-radius: 16px; padding: 12px; display: flex; flex-direction: column; align-items: flex-start; gap: 10px; border: 1px solid rgba(255,255,255,0.05); cursor: pointer; position: relative; }
        .exercise-card .actions { display:flex; gap:8px; align-items:center; position:absolute; right:12px; top:50%; transform:translateY(-50%); flex-direction:row; }
        .exercise-card .actions .icon-btn { padding:6px; box-shadow: 0 6px 14px rgba(2,6,23,0.12); background: rgba(255,255,255,0.02); border-radius:10px; }
        .exercise-card .meta { width:50%; }
        .exercise-card .meta .title { font-weight:700; margin-top:4px; }
        .exercise-card .meta .badge { margin:0 0 6px 0; }
        .modal { position: fixed; top: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 500px; height: 100%; background: var(--bg); z-index: 1000; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        body.noselect, .noselect, .noselect * {
            user-select: none !important;
            -webkit-user-select: none !important;
            -ms-user-select: none !important;
        }
        .category-section { background: var(--card); border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); overflow: hidden; margin-bottom: 12px; }
        .category-summary { padding: 16px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; font-weight: 800; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.1em; }
        .exercise-grid { display: grid; gap: 12px; padding: 0 12px 16px 12px; }
        .exercise-grid .ex-thumb { width: 72px; height: 48px; border-radius: 10px; object-fit: contain; object-position: center; background: #fff; }
        .exercise-card { background: var(--card); border-radius: 16px; padding: 12px; display: flex; align-items: center; gap: 16px; border: 1px solid rgba(255,255,255,0.05); cursor: pointer; position: relative; }
        /* Modal/search: stack image on top, then meta and actions below (scoped to .exercise-grid) */
        .exercise-grid .exercise-card { flex-direction: column; align-items: flex-start; gap: 10px; }
        .exercise-grid .exercise-card > div:first-child { width: 100%; }
        .exercise-grid .meta-actions-row { display:flex; width:100%; align-items:center; justify-content:space-between; gap:12px; }
        .exercise-grid .meta-actions-row .meta { display:flex; flex-direction:column; gap:4px; }
        .exercise-grid .meta-actions-row .meta .badge { margin:0 0 4px 0; }
        .exercise-grid .meta-actions-row .meta .title { font-weight:700; }
        .exercise-grid .exercise-card .actions { position: static; right: auto; top: auto; transform: none; display: flex; gap: 8px; justify-content: flex-end; width: auto; align-items: center; }
        .exercise-card.selected .tick-icon {
            display: block;
        }
        .tick-icon {
            display: none;
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            z-index: 2;
            pointer-events: none;
        }
        .icon-btn { background:none; border:none; color:var(--primary); padding:6px; border-radius:8px; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; }
        .icon-btn:hover { background: rgba(59,130,246,0.06); }
        .badge { display:inline-flex; align-items:center; justify-content:center; margin:0 0 6px 0; background:var(--primary); color:white; font-size:0.7rem; padding:4px 8px; border-radius:999px; font-weight:700; white-space:nowrap; width:auto; height:auto; align-self:flex-start; }
        .selected-ex-card .badge.small-badge { display:inline-flex; align-items:center; justify-content:center; font-size:0.6rem; padding:2px 6px; font-weight:800; white-space:nowrap; width:auto; height:auto; align-self:flex-start; }
        /* Image drop / preview styling */
        .image-preview-box { width: 100%; height: 160px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius: 12px; display:flex; align-items:center; justify-content:center; cursor:pointer; overflow:hidden; border: 2px dashed rgba(255,255,255,0.04); position:relative; }
        .image-preview-box.dragover { background: linear-gradient(180deg, rgba(59,130,246,0.06), rgba(37,99,235,0.02)); border-color: rgba(37,99,235,0.6); }
        .image-preview-box img { width:100%; height:100%; object-fit:contain; object-position:center; display:block; }
        .upload-placeholder { display:flex; flex-direction:column; align-items:center; gap:6px; color:var(--text-dim); font-weight:700 }
        .upload-sub { font-size:0.85rem; color:var(--text-dim); font-weight:500 }
        #removeImageBtn { position:absolute; right:8px; top:8px; background:rgba(0,0,0,0.4); color:white; border:none; padding:6px 8px; border-radius:8px; cursor:pointer; display:none; }
        /* Modern select styling */
        .select-wrapper { position: relative; }
        .select-wrapper select { -webkit-appearance: none; appearance: none; width: 100%; padding: 12px 44px 12px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.02); color: inherit; font-weight:700; cursor: pointer; }
        .select-wrapper:focus-within { box-shadow: 0 6px 20px rgba(59,130,246,0.12); border-radius:12px; }
        .select-wrapper .chev { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none; color: var(--text-dim); font-size: 14px; }
        /* Make options easier to scan */
        .select-wrapper select option { padding: 8px 12px; }
        /* Sets UI inside selected exercise cards */
        .sets-container { display:flex; flex-direction:column; gap:8px; width:100%; margin-top:8px; }
        /* table-like header for set fields */
        .sets-container .header-row { display:flex; gap:8px; align-items:center; padding-bottom:6px; border-bottom:1px solid rgba(255,255,255,0.03); }
        .set-row { display:flex; gap:8px; align-items:center; flex-wrap:nowrap; }
        .set-row .field { display:flex; flex-direction:column; gap:6px; width:64px; min-width:48px; align-items:flex-start; }
        .set-row .field label { font-size:0.7rem; color:var(--text-dim); font-weight:700; display:block; text-align:left; margin-left:2px; }
        .set-row.data-row .field label { display:none; }
        .set-row input[type="number"], .set-row input[type="text"] { width:100%; padding:8px; border-radius:8px; font-size:0.9rem; box-sizing:border-box; text-align:center; }
        /* hide native number input spinners for a cleaner mobile UI */
        .set-row input[type="number"]::-webkit-outer-spin-button,
        .set-row input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .set-row input[type="number"] { -moz-appearance: textfield; }
        .set-row .remove-set-btn { background:transparent; border:none; padding:6px; cursor:pointer; color:var(--text-dim); display:flex; align-items:center; justify-content:center; align-self:center; }
        .add-set-inline { margin-top:6px; padding:6px 10px; border-radius:8px; border:1px dashed rgba(255,255,255,0.06); background:transparent; color:var(--text-dim); cursor:pointer; font-weight:800; font-size:0.75rem; }
        @media (max-width: 380px) {
            .set-row { gap:6px; }
            .set-row .field { width:56px; }
        }
    </style>
</head>
<body>
    <div class="top-card">
        <div class="top-card-inner">
            <div style="display:flex;align-items:center;width:100%;gap:12px;">
                <a href="routines.html" class="back-btn" style="outline:none; box-shadow:none; border:none; background:none;" aria-label="Back"><span class="material-symbols-outlined" aria-hidden="true" style="font-variation-settings: 'wght' 300;">arrow_back</span></a>
                <div style="flex:1;min-width:0;">
                    <h2 id="pageTitle" style="margin:0; text-align:left;" data-i18n="page_routine_new">Nova Rotina</h2>
                </div>
            </div>
        </div>
    </div>

    <div class="page-content">
    <div class="card">
        <div style="display:flex; flex-direction:column; gap:12px;">
            <label style="font-size:0.8rem; font-weight:800" data-i18n="routine_name_label">Nome da Rotina</label>
            <input id="routineName" data-i18n-placeholder="routine_name_placeholder" placeholder="ex.: Empurr√£o Superior" />
            <div id="formErrors" class="form-errors hidden" aria-live="polite"></div>
            <label style="font-size:0.8rem; font-weight:800; margin-top: 10px;" data-i18n="routine_exercises_label">Exerc√≠cios da Rotina</label>
            <button id="openSearchBtn" class="add-set-btn prominent" style="width:100%;" onclick="openSearchModal()" data-i18n="add_exercise">üîç Adicionar Exerc√≠cio</button>
            <div id="selectedList" class="selected-ex-list" onclick="if(this.querySelectorAll('.selected-ex-card').length===0) openSearchModal()"></div>
            <div style="display:flex; gap:8px;">
                <button style="flex:1; width:100%; background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--text-dim); padding:12px; border-radius:12px;" onclick="location.href='routines.html'" data-i18n="cancel">Cancelar</button>
                <button class="primary" id="saveRoutineBtn" onclick="saveRoutine()" data-i18n="save_routine" style="flex:1; width:100%;">Salvar Rotina</button>
            </div>
        </div>
    </div>

    </div>
    <!-- Search Modal (copied from routines.html) -->
        <div id="searchModal" class="modal hidden">
            <div class="top-card">
                <div class="top-card-inner">
                    <div style="display:flex;align-items:center;width:100%;gap:12px;">
                        <a href="javascript:void(0)" class="back-btn" onclick="closeSearchModal()" style="outline:none; box-shadow:none; border:none; background:none; font-size:1.5rem; text-decoration:none;" aria-label="Back"><span class="material-symbols-outlined" aria-hidden="true" style="font-variation-settings: 'wght' 300;">arrow_back</span></a>
                        <div style="flex:1;min-width:0;">
                            <h2 style="margin:0; text-align:left;" data-i18n="add_exercise_modal_title">Adicionar Exerc√≠cio</h2>
                        </div>
                        <div class="top-action-wrapper" style="display:flex; gap:8px; align-items:center;">
                            <button id="newCustomBtn" type="button" class="add-set-btn prominent top-action-btn" onclick="openCreateModal()"><span data-i18n="new_custom">custom</span></button>
                        </div>
                    </div>
                </div>
            </div>
        <div id="selectBar" class="hidden" aria-hidden="true">
            <div id="selectCount">0 selecionados</div>
            <div style="display:flex; gap:8px; align-items:center;">
                <button id="cancelSelectBtn" class="cancel-btn" onclick="exitSelectMode()" data-i18n="cancel">Cancelar</button>
                <button id="addSelectedBtn" class="add-btn" onclick="addSelectedExercisesFromModal()" disabled data-i18n="add_selected">Adicionar Selecionados</button>
            </div>
        </div>
            <div style="display:flex; flex-direction:column; gap:12px; margin-top:10px;">
            <div style="position:relative;">
                <input type="text" id="modalSearchInput" placeholder="Pesquisar por nome..." data-i18n-placeholder="search_placeholder" oninput="updateModalResults()" style="width:100%; padding-right:40px;">
                <button id="clearSearchBtn" class="clear-search-btn" onclick="clearModalSearch()" aria-label="Clear search" title="Clear search" style="position:absolute; right:8px; top:50%; transform:translateY(-50%);">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div id="modalResults" class="exercise-list" style="margin-top: 10px;"></div>
        </div>
    </div>

    <div id="customExModal" class="modal modal-sub hidden">
        <div class="top-card">
            <div class="top-card-inner">
                <div style="display:flex;align-items:center;width:100%;gap:12px;">
                    <a href="javascript:void(0)" class="back-btn" onclick="closeCustomModal()" style="outline:none; box-shadow:none; border:none; background:none; font-size:1.5rem; text-decoration:none;" aria-label="Back"><span class="material-symbols-outlined" aria-hidden="true" style="font-variation-settings: 'wght' 300;">arrow_back</span></a>
                    <div style="flex:1;min-width:0;">
                        <h2 id="customModalTitle" style="margin:0; text-align:left;" data-i18n="custom_exercise_title">Exerc√≠cio Personalizado</h2>
                    </div>
                </div>
            </div>
        </div>
        <div class="card" style="margin-top:10px;">
            <div style="display:flex; flex-direction:column; gap:12px;">
            <input type="hidden" id="exId">
            <label data-i18n="exercise_name_label">Nome</label>
            <input type="text" id="exName" placeholder="ex.: Supino Reto">
            <label data-i18n="exercise_name_pt_label">Nome (Portugu√™s)</label>
            <input type="text" id="exNamePT" placeholder="ex.: Supino Reto">
            <label data-i18n="exercise_type_label">Tipo</label>
            <div class="select-wrapper">
                <select id="exType">
                </select>
                <div class="chev">‚ñæ</div>
            </div>
            <label data-i18n="exercise_image_label">Imagem</label>
            <input type="file" id="exImageInput" accept="image/*" onchange="handleImageUpload(event)" style="display:none">
            <div id="imagePreviewBox" class="image-preview-box" onclick="document.getElementById('exImageInput').click()">
                <img id="exImagePreview" src="" class="hidden">
                <div id="uploadPlaceholder" class="upload-placeholder">
                    <div style="font-size:2rem">üì∏</div>
                    <div class="upload-main" data-i18n="exercise_image_label">Imagem</div>
                    <div class="upload-sub">Drag & drop or click to upload</div>
                </div>
                <button id="removeImageBtn" type="button" onclick="removeImage()">√ó</button>
            </div>
            <div style="display:flex; gap:8px; margin-top:6px;">
                <button style="flex:1; background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--text-dim); padding:12px; border-radius:12px;" onclick="closeCustomModal()" data-i18n="cancel">Cancelar</button>
                <button class="primary" style="flex:1;" onclick="saveCustomExercise()" data-i18n="save_exercise_btn">Salvar Exerc√≠cio</button>
            </div>
            </div>
        </div>
    </div>

    <script>
        let allExercises = [];
        let images = {};
        let selectMode = false;
        let selectedExercises = new Set();
        let currentImageData = null;
        let editingId = null;

        function getDisplayedName(ex) {
            try {
                const lang = (GN_I18N && GN_I18N.safeGetLang) ? GN_I18N.safeGetLang() : (navigator.language || 'en');
                const chosen = (lang && lang.toLowerCase().startsWith('pt') && ex.namePT) ? ex.namePT : ex.name;
                return chosen;
            } catch (e) { return ex.name; }
        }

        // long-press selection removed ‚Äî selection is handled via explicit buttons/clicks
        function handleCardClick(exId, isCustom, el, e) {
            if (selectMode) { if (typeof toggleSelect === 'function') toggleSelect(exId, isCustom, el); return; }
            addExerciseToRoutine(exId, [], isCustom); closeSearchModal();
        }
        function enterSelectMode() {
            selectMode = true;
            selectedExercises = new Set();
            document.getElementById('selectBar').classList.remove('hidden');
            updateSelectBar();
            document.getElementById('modalResults').classList.add('select-mode');
            document.body.classList.add('noselect');
            window.addEventListener('contextmenu', preventContextMenu, true);
        }
        function exitSelectMode() {
            selectMode = false;
            selectedExercises.clear();
            document.getElementById('selectBar').classList.add('hidden');
            document.getElementById('modalResults').classList.remove('select-mode');
            document.querySelectorAll('.exercise-card.selected').forEach(c => c.classList.remove('selected'));
            updateSelectBar();
            document.body.classList.remove('noselect');
            window.removeEventListener('contextmenu', preventContextMenu, true);
        }
        function preventContextMenu(e) { e.preventDefault(); }
        function updateSelectBar() { 
            const count = selectedExercises.size; 
            const selText = (window.GN_I18N && GN_I18N.t) ? GN_I18N.t('selected') : 'selecionados';
            const selectCountEl = document.getElementById('selectCount');
            if (selectCountEl) selectCountEl.innerText = `${count} ${selText}`;
            const addBtn = document.getElementById('addSelectedBtn');
            if (addBtn) {
                addBtn.disabled = count === 0;
                if (window.GN_I18N && GN_I18N.t) addBtn.textContent = GN_I18N.t('add_selected');
            }
        }
        function addSelectedExercisesFromModal() { for (const key of Array.from(selectedExercises)) { const [prefix, idStr] = key.split(':'); const isCustom = prefix === 'c'; const id = parseInt(idStr); addExerciseToRoutine(id, [], isCustom); } exitSelectMode(); closeSearchModal(); }

        function populateExerciseTypeSelect(){
            try {
                const sel = document.getElementById('exType');
                if (!sel) return;
                // prefer db.availableExerciseTypes, fallback to window constant or i18n list
                const keys = (db && db.availableExerciseTypes) ? db.availableExerciseTypes : (window.AVAILABLE_EXERCISE_TYPES || []);
                sel.innerHTML = '';
                keys.forEach(k => {
                    const opt = document.createElement('option');
                    opt.value = k;
                    opt.textContent = (window.GN_I18N && GN_I18N.getLocalizedTypeLabel) ? GN_I18N.getLocalizedTypeLabel(k) : (window.GN_I18N && GN_I18N.localizeExerciseType ? GN_I18N.localizeExerciseType(k) : k);
                    sel.appendChild(opt);
                });
            } catch(e) { console.warn('populateExerciseTypeSelect failed', e); }
        }

        function updateNamePTVisibility(){
            try {
                const lang = (window.GN_I18N && GN_I18N.safeGetLang) ? GN_I18N.safeGetLang() : (navigator.language || 'en');
                const isPt = lang && lang.toLowerCase().startsWith('pt');
                const label = document.querySelector('[data-i18n="exercise_name_pt_label"]');
                const input = document.getElementById('exNamePT');
                if (label) label.style.display = isPt ? 'none' : '';
                if (input) input.style.display = isPt ? 'none' : '';
                if (isPt && input) {
                    const main = document.getElementById('exName');
                    if (main) input.value = main.value || '';
                }
            } catch(e){}
        }

        async function init() {
            await ensureDbOpen();
            const [catalogEx, catalogImgs, customEx, customImgs] = await Promise.all([
                db.catalog_exercises.toArray(),
                db.catalog_images.toArray(),
                db.custom_exercises.toArray(),
                db.custom_images.toArray()
            ]);
            images = {};
            catalogImgs.forEach(img => images[img.id] = img.data);
            customImgs.forEach(img => images[img.id] = img.data);
            allExercises = [ ...catalogEx.map(ex => ({ ...ex, isCustom: false })), ...customEx.map(ex => ({ ...ex, isCustom: true })) ];
            updateModalResults();
            try { populateExerciseTypeSelect(); } catch(e){}
            try { updateNamePTVisibility(); } catch(e){}

            

            // keep exName -> exNamePT in sync when PT locale
            try {
                const exNameEl = document.getElementById('exName');
                if (exNameEl) exNameEl.addEventListener('input', () => {
                    try {
                        const lang = (window.GN_I18N && GN_I18N.safeGetLang) ? GN_I18N.safeGetLang() : (navigator.language || 'en');
                        if (lang && lang.toLowerCase().startsWith('pt')) {
                            const pt = document.getElementById('exNamePT');
                            if (pt) pt.value = exNameEl.value;
                        }
                    } catch(e){}
                });
            } catch(e){}

            // If editing load routine
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            if (id) {
                editingId = parseInt(id);
                document.getElementById('pageTitle').innerText = 'Editar Rotina';
                const workout = await db.routines.get(editingId);
                if (workout) {
                    document.getElementById('routineName').value = workout.name;
                    for (const item of workout.exerciseIds) {
                        const exId = typeof item === 'object' ? item.id : item;
                        const isCustom = typeof item === 'object' ? !!item.isCustom : false;
                        const sets = Array.isArray(item.sets) ? item.sets : [];
                        addExerciseToRoutine(exId, sets, isCustom);
                    }
                }
            }
            // wire drag/drop on image preview
            try {
                const box = document.getElementById('imagePreviewBox');
                if (box) {
                    box.addEventListener('dragenter', (e) => { e.preventDefault(); box.classList.add('dragover'); });
                    box.addEventListener('dragover', (e) => { e.preventDefault(); box.classList.add('dragover'); });
                    box.addEventListener('dragleave', (e) => { e.preventDefault(); box.classList.remove('dragover'); });
                    box.addEventListener('drop', handleDrop);
                }
            } catch(e){}
            ensureEmptyHint();
        }

        function openSearchModal() { document.getElementById('searchModal').classList.remove('hidden'); updateModalResults(); }
        function closeSearchModal() { document.getElementById('searchModal').classList.add('hidden'); }

        function updateModalResults() {
            const rawQuery = (document.getElementById('modalSearchInput').value || '').trim();
            const lang = (GN_I18N && GN_I18N.safeGetLang) ? GN_I18N.safeGetLang() : (navigator.language || 'en');
            const resultsDiv = document.getElementById('modalResults');

            // Normalizes strings: lowercase, remove diacritics, remove non-alphanumerics
            function normalizeForSearch(s) {
                if (!s) return '';
                try {
                        return s.toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9]/g, '');
                } catch (e) {
                    return s.toString().toLowerCase().replace(/[^a-z0-9]/g, '');
                }
            }

            // Subsequence match (characters in order, not necessarily contiguous)
            function isSubsequence(needle, haystack) {
                if (!needle) return false;
                let i = 0, j = 0;
                while (i < needle.length && j < haystack.length) {
                    if (needle[i] === haystack[j]) i++;
                    j++;
                }
                return i === needle.length;
            }

            const qNorm = normalizeForSearch(rawQuery);
            const tokens = rawQuery.split(/\s+/).filter(Boolean).map(t => normalizeForSearch(t)).filter(Boolean);

            const filtered = allExercises.filter(ex => {
                // If no query, include all
                if (!qNorm) return true;
                const name = normalizeForSearch(ex.name || '');
                const namePT = normalizeForSearch(ex.namePT || '');

                // direct contains match on normalized strings
                if (name.includes(qNorm) || namePT.includes(qNorm)) return true;

                // tokens: if any token matches as subsequence in either name, accept (loose match)
                for (const t of tokens) {
                    if (!t) continue;
                    if (isSubsequence(t, name) || isSubsequence(t, namePT)) return true;
                }

                // initials fallback: e.g., 'tmr' -> 'treadmill running'
                const initials = (ex.name || '').split(/\s+/).map(w => (w[0] || '')).join('');
                if (normalizeForSearch(initials).includes(qNorm)) return true;

                return false;
            });

            if (filtered.length === 0) { const noneMsg = (window.GN_I18N && GN_I18N.t) ? GN_I18N.t('no_exercise_found') : 'No exercise found'; resultsDiv.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-dim)">' + noneMsg + '</div>'; return; }
                // show/hide clear button depending on input content
                try { const clearBtn = document.getElementById('clearSearchBtn'); if (clearBtn) { if (rawQuery && rawQuery.length > 0) clearBtn.style.display = 'flex'; else clearBtn.style.display = 'none'; } } catch(e){}
            // Group by canonical exercise types (preserve order) and use localized labels
            const canonical = (db && db.availableExerciseTypes) ? db.availableExerciseTypes : (window.AVAILABLE_EXERCISE_TYPES || []);
            const htmlParts = [];
            const seen = new Set();

            const renderItems = (items) => items.map(ex => {
                // subtitle removed - no secondary line under exercise title
                const editBtn = ex.isCustom ? `<button class="icon-btn" onclick="event.stopPropagation(); editExercise(${ex.id})" title="Edit">‚úé</button>` : '';
                const selectBtn = `<button class="icon-btn" onclick="event.stopPropagation(); addExerciseToRoutine(${ex.id}, [], ${!!ex.isCustom}); closeSearchModal();" title="${(window.GN_I18N && GN_I18N.t) ? GN_I18N.t('select') : 'Select'}">${(window.GN_I18N && GN_I18N.t) ? GN_I18N.t('select') : 'Select'}</button>`;
                const customTag = ex.isCustom ? `<span class="badge">${(window.GN_I18N && GN_I18N.t) ? GN_I18N.t('custom_exercise_title') : 'Custom'}</span>` : '';
                return `<div class="exercise-card" onclick="handleCardClick(${ex.id}, ${!!ex.isCustom}, this, event)" oncontextmenu="event.preventDefault()">
                            <div style="width:100%"><img src="${images[ex.imageId] || defaultImage}" class="ex-thumb"></div>
                            <div class="meta-actions-row">
                                <div class="meta">
                                    ${customTag ? `<div>${customTag}</div>` : ''}
                                    <div class="title">${getDisplayedName(ex)}</div>
                                </div>
                                <div class="actions">${selectBtn}${editBtn}</div>
                            </div>
                            <svg class="tick-icon" viewBox="0 0 32 32" fill="none">
                                <circle cx="16" cy="16" r="16" fill="var(--success)"/>
                                <path d="M10 17.5l5 5 7-9" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>`;
            }).join('');

            // Render canonical groups
            canonical.forEach(type => {
                let items = filtered.filter(ex => ex.type === type);
                if (!items || items.length === 0) return;
                // sort items alphabetically by displayed/localized name
                try {
                    items.sort((a, b) => (getDisplayedName(a) || '').localeCompare(getDisplayedName(b) || '', lang, { sensitivity: 'base' }));
                } catch (e) {}
                seen.add(type);
                const displayType = (window.GN_I18N && GN_I18N.getLocalizedTypeLabel) ? GN_I18N.getLocalizedTypeLabel(type) : ((window.GN_I18N && GN_I18N.localizeExerciseType) ? GN_I18N.localizeExerciseType(type) : type);
                htmlParts.push(`
                <details class="category-section">
                    <summary class="category-summary">
                        <span>${displayType}</span>
                        <svg class="chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </summary>
                    <div class="exercise-grid">
                        ${renderItems(items)}
                    </div>
                </details>
            `);
            });

            // Render any extra types present in results but not in canonical list
            const extraTypes = Array.from(new Set(filtered.map(e => e.type))).filter(t => !seen.has(t)).sort();
            extraTypes.forEach(type => {
                let items = filtered.filter(ex => ex.type === type);
                if (!items || items.length === 0) return;
                // sort items alphabetically by displayed/localized name
                try {
                    items.sort((a, b) => (getDisplayedName(a) || '').localeCompare(getDisplayedName(b) || '', lang, { sensitivity: 'base' }));
                } catch (e) {}
                const displayType = (window.GN_I18N && GN_I18N.getLocalizedTypeLabel) ? GN_I18N.getLocalizedTypeLabel(type) : ((window.GN_I18N && GN_I18N.localizeExerciseType) ? GN_I18N.localizeExerciseType(type) : type);
                htmlParts.push(`
                <details class="category-section">
                    <summary class="category-summary">
                        <span>${displayType}</span>
                        <svg class="chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </summary>
                    <div class="exercise-grid">
                        ${renderItems(items)}
                    </div>
                </details>
            `);
            });

            resultsDiv.innerHTML = htmlParts.join('');
        }

        function clearModalSearch() {
            const input = document.getElementById('modalSearchInput');
            if (!input) return;
            input.value = '';
            updateModalResults();
            input.focus();
            try { const clearBtn = document.getElementById('clearSearchBtn'); if (clearBtn) clearBtn.style.display = 'none'; } catch(e){}
        }

        function addExerciseToRoutine(exId, sets = [], isCustom = false) {
            const ex = allExercises.find(e => e.id === exId && !!e.isCustom === !!isCustom);
            if (!ex) return;
            const container = document.getElementById('selectedList');
            const card = document.createElement('div');
            card.className = 'selected-ex-card';
            card.dataset.id = exId;
            card.dataset.isCustom = isCustom;
            card.innerHTML = `
                <img src="${images[ex.imageId] || defaultImage}" class="ex-thumb">
                <button type="button" class="remove-set-btn" onclick="removeSelectedCard(this)" aria-label="Remove">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
                <div style="display:flex; flex-direction:column; gap:6px; width:100%;">
                    ${ex.isCustom ? `<span class="badge small-badge">${(window.GN_I18N && GN_I18N.t) ? GN_I18N.t('custom_exercise_title') : 'Custom'}</span>` : ''}
                    <strong>${getDisplayedName(ex)}</strong>
                </div>
                
            `;
                // sets UI (table-like)
                const setsContainer = document.createElement('div');
                setsContainer.className = 'sets-container';
                // Normalize incoming `sets` for backward compatibility:
                // Older versions stored expanded arrays like [{reps,weight}, {reps,weight}, ...]
                // Compress runs of identical reps+weight into objects with a `sets` count.
                const normalizeIncomingSets = (raw) => {
                    if (!Array.isArray(raw) || raw.length === 0) return null;
                    // detect expanded format: items have reps/weight but no `sets`
                    const looksExpanded = raw.every(it => it && (it.reps !== undefined || it.weight !== undefined) && it.sets === undefined);
                    if (!looksExpanded) return null;
                    const compressed = [];
                    let prevKey = null; let prevReps = null; let prevWeight = null; let count = 0;
                    for (const it of raw) {
                        const r = (it.reps === null || it.reps === undefined) ? '' : it.reps;
                        const w = (it.weight === null || it.weight === undefined) ? '' : it.weight;
                        const key = `${r}:::${w}`;
                        if (key === prevKey) {
                            count++;
                        } else {
                            if (prevKey !== null) {
                                compressed.push({ sets: count, reps: prevReps, weight: prevWeight });
                            }
                            prevKey = key; prevReps = r; prevWeight = w; count = 1;
                        }
                    }
                    if (prevKey !== null) compressed.push({ sets: count, reps: prevReps, weight: prevWeight });
                    return compressed;
                };

                let processedSets = sets;
                if (Array.isArray(sets) && sets.length) {
                    const norm = normalizeIncomingSets(sets);
                    if (norm) processedSets = norm;
                }

                // populate existing sets or add a default single set (all fields blank by default)
                const initialSets = Array.isArray(processedSets) && processedSets.length ? processedSets : [{ sets: '', reps: '', weight: '' }];
                initialSets.forEach(s => addSetRowToContainer(setsContainer, s));

                const addSetBtn = document.createElement('button');
                addSetBtn.type = 'button';
                addSetBtn.className = 'add-set-inline';
                addSetBtn.textContent = (window.GN_I18N && GN_I18N.t) ? GN_I18N.t('add_set') || 'Add set' : 'Add set';
                addSetBtn.onclick = (ev) => { ev.stopPropagation(); addSetRowToContainer(setsContainer, { sets: '', reps: '', weight: '' }); };

                card.appendChild(setsContainer);
                card.appendChild(addSetBtn);

                container.appendChild(card);
                ensureEmptyHint();
        }
        


        // per-set helpers removed

        function addSetRowToContainer(container, setData) {
            // create header row once
            const labelSets = (window.GN_I18N && GN_I18N.t) ? GN_I18N.t('history_sets') : 'Sets';
            const labelReps = (window.GN_I18N && GN_I18N.t) ? GN_I18N.t('history_reps') : 'Reps';
            const labelWeight = (window.GN_I18N && GN_I18N.t) ? GN_I18N.t('weight_kg') : 'Weight';

            if (!container.querySelector('.header-row')) {
                const headerRow = document.createElement('div');
                headerRow.className = 'set-row header-row';
                const makeHeaderField = (labelText) => {
                    const f = document.createElement('div'); f.className = 'field';
                    const l = document.createElement('label'); l.textContent = labelText; f.appendChild(l); return f;
                };
                headerRow.appendChild(makeHeaderField(labelSets));
                headerRow.appendChild(makeHeaderField(labelReps));
                headerRow.appendChild(makeHeaderField(labelWeight));
                // spacer for remove column
                const spacer = document.createElement('div'); spacer.style.width = '36px'; headerRow.appendChild(spacer);
                container.appendChild(headerRow);
            }

            const row = document.createElement('div');
            row.className = 'set-row data-row';

            const setsInput = document.createElement('input'); setsInput.type = 'number'; setsInput.min = '0';
            const repsInput = document.createElement('input'); repsInput.type = 'number'; repsInput.min = '0';
            const weightInput = document.createElement('input'); weightInput.type = 'text';

            const applyDefaultValue = (inputEl, val) => {
                if (val === undefined || val === null || val === '') inputEl.value = '';
                else inputEl.value = val;
            };

            applyDefaultValue(setsInput, setData && setData.sets);
            applyDefaultValue(repsInput, setData && setData.reps);
            applyDefaultValue(weightInput, setData && setData.weight);

            const makeField = (inputEl) => {
                const f = document.createElement('div'); f.className = 'field';
                f.appendChild(inputEl);
                return f;
            };

            const removeBtn = document.createElement('button'); removeBtn.type = 'button'; removeBtn.className = 'remove-set-btn'; removeBtn.setAttribute('aria-label','Remove set');
            removeBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
            removeBtn.onclick = (e) => { e.stopPropagation(); row.remove(); };

            row.appendChild(makeField(setsInput));
            row.appendChild(makeField(repsInput));
            row.appendChild(makeField(weightInput));
            row.appendChild(removeBtn);
            container.appendChild(row);
        }

        function removeSelectedCard(btn) { const card = btn.closest('.selected-ex-card'); if (card) card.remove(); ensureEmptyHint(); }

        function ensureEmptyHint() {
            const container = document.getElementById('selectedList');
            if (!container) return;
            const cards = container.querySelectorAll('.selected-ex-card');
            const hint = container.querySelector('.empty-hint');
            if (cards.length === 0) {
                if (!hint) {
                    const d = document.createElement('div');
                    d.className = 'empty-hint';
                    d.setAttribute('data-i18n', 'no_exercises_placeholder');
                    // set a localized fallback text when GN_I18N is available, otherwise leave blank
                    d.innerText = (window.GN_I18N && GN_I18N.t) ? GN_I18N.t('no_exercises_placeholder') : '';
                    container.appendChild(d);
                }
                container.classList.add('empty');
            } else {
                if (hint) hint.remove();
                container.classList.remove('empty');
            }
            try { if (window.GN_I18N) GN_I18N.applyTranslations(container); } catch(e){}
        }

        function getSelectedExercisesData() {
            return Array.from(document.querySelectorAll('.selected-ex-card')).map(card => {
                const id = parseInt(card.dataset.id);
                const isCustom = card.dataset.isCustom === 'true';
                const sets = [];
                // only iterate data rows (skip header-row)
                const rows = card.querySelectorAll('.set-row.data-row');
                rows.forEach(r => {
                    const inputs = r.querySelectorAll('input');
                    if (!inputs || inputs.length < 3) return;
                    const sRaw = inputs[0].value.trim();
                    const rRaw = inputs[1].value.trim();
                    const wRaw = inputs[2].value.trim();

                    // skip completely empty rows
                    if (sRaw === '' && rRaw === '' && wRaw === '') return;

                    // determine how many repetitions this row represents
                    const count = (sRaw === '' ? 1 : (isNaN(Number(sRaw)) ? 1 : parseInt(sRaw, 10)));

                    const repsVal = (rRaw === '' ? null : parseInt(rRaw, 10));
                    const weightVal = (wRaw === '' ? null : (isNaN(Number(wRaw)) ? wRaw : Number(wRaw)));

                    for (let i = 0; i < count; i++) {
                        sets.push({ reps: repsVal, weight: weightVal });
                    }
                });
                return { id, isCustom, sets };
            });
        }

        async function saveRoutine() {
            const name = document.getElementById('routineName').value.trim();
            const exerciseIds = getSelectedExercisesData();

            // clear previous invalid markers and messages
            document.querySelectorAll('.selected-ex-card.invalid').forEach(c => c.classList.remove('invalid'));
            document.querySelectorAll('.selected-ex-card .card-error').forEach(e => e.remove());
            const formErrorsEl = document.getElementById('formErrors');
            if (formErrorsEl) { formErrorsEl.classList.add('hidden'); formErrorsEl.innerHTML = ''; }

            if (!name || exerciseIds.length === 0) {
                const msg = (typeof GN_I18N !== 'undefined' && GN_I18N.t) ? GN_I18N.t('missing_routine_name') : 'Falta nome ou exerc√≠cios na rotina';
                if (formErrorsEl) { formErrorsEl.innerText = msg; formErrorsEl.classList.remove('hidden'); formErrorsEl.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
                return;
            }

            // Validate that every exercise has at least one set with both reps and weight
            const invalidExerciseIds = [];
            exerciseIds.forEach(ex => {
                const sets = Array.isArray(ex.sets) ? ex.sets : [];
                const hasValid = sets.some(s => s && s.reps !== null && s.reps !== undefined && s.weight !== null && s.weight !== undefined);
                if (!hasValid) invalidExerciseIds.push(ex.id);
            });

            if (invalidExerciseIds.length > 0) {
                // mark the cards visually and show per-card messages
                const cards = document.querySelectorAll('.selected-ex-card');
                cards.forEach(card => {
                    const id = parseInt(card.dataset.id);
                    if (invalidExerciseIds.includes(id)) {
                        card.classList.add('invalid');
                        // avoid duplicate message
                        if (!card.querySelector('.card-error')) {
                            const ce = document.createElement('div');
                            ce.className = 'card-error';
                            ce.innerText = (window.GN_I18N && GN_I18N.t) ? (GN_I18N.t('exercise_missing_set') || 'Requires at least one set with reps and weight') : 'Requires at least one set with reps and weight';
                            card.appendChild(ce);
                        }
                    }
                });
                // Only show per-card inline messages for missing sets; do not duplicate at the top
                const first = document.querySelector('.selected-ex-card.invalid');
                if (first) first.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }

            if (editingId) {
                await db.routines.update(editingId, { name, exerciseIds });
                localStorage.setItem('has_local_changes', 'true');
                location.href = 'routines.html?id=' + editingId;
            } else {
                const id = await db.routines.add({ name, exerciseIds });
                localStorage.setItem('has_local_changes', 'true');
                location.href = 'routines.html?id=' + id;
            }
        }

        // Minimal custom-exercise handlers (reused)
        function openCreateModal() { 
            try { document.getElementById('customModalTitle').innerText = (window.GN_I18N && GN_I18N.t) ? GN_I18N.t('custom_exercise_title') : 'Custom Exercise'; } catch(e){}
            document.getElementById('exId').value = ''; document.getElementById('exName').value = ''; document.getElementById('exNamePT').value = ''; document.getElementById('exType').selectedIndex = 0; currentImageData = null; document.getElementById('exImagePreview').classList.add('hidden'); document.getElementById('uploadPlaceholder').classList.remove('hidden'); document.getElementById('customExModal').classList.remove('hidden'); 
            try { updateNamePTVisibility(); } catch(e){}
        }
        function closeCustomModal() { document.getElementById('customExModal').classList.add('hidden'); }
        function handleImageUpload(event) {
            const file = event.target && event.target.files ? event.target.files[0] : null;
            if (!file) return;
            handleFile(file);
        }

        function handleFile(file) {
            try {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800;
                        const scaleSize = Math.min(1, MAX_WIDTH / img.width);
                        canvas.width = img.width * scaleSize;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        try { currentImageData = canvas.toDataURL('image/jpeg', 0.8); } catch(e){ currentImageData = e.target.result; }
                        const preview = document.getElementById('exImagePreview');
                        if (preview) {
                            preview.src = currentImageData;
                            preview.classList.remove('hidden');
                        }
                        const placeholder = document.getElementById('uploadPlaceholder'); if (placeholder) placeholder.classList.add('hidden');
                        const removeBtn = document.getElementById('removeImageBtn'); if (removeBtn) removeBtn.style.display = 'block';
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            } catch (e) { console.error('handleFile error', e); }
        }

        function handleDrop(e) {
            try {
                e.preventDefault();
                e.stopPropagation();
                const dt = e.dataTransfer;
                if (dt && dt.files && dt.files.length > 0) {
                    handleFile(dt.files[0]);
                }
                const box = document.getElementById('imagePreviewBox'); if (box) box.classList.remove('dragover');
            } catch(e){}
        }

        function removeImage() {
            try {
                currentImageData = null;
                const preview = document.getElementById('exImagePreview'); if (preview) { preview.src = ''; preview.classList.add('hidden'); }
                const placeholder = document.getElementById('uploadPlaceholder'); if (placeholder) placeholder.classList.remove('hidden');
                const removeBtn = document.getElementById('removeImageBtn'); if (removeBtn) removeBtn.style.display = 'none';
                const input = document.getElementById('exImageInput'); if (input) input.value = '';
            } catch(e){}
        }
        async function saveCustomExercise() { const id = document.getElementById('exId').value; const name = document.getElementById('exName').value.trim(); const namePT = document.getElementById('exNamePT').value.trim(); const type = document.getElementById('exType').value; if (!name) { alert((typeof GN_I18N !== 'undefined') ? GN_I18N.t('please_enter_exercise_name') : 'Por favor, insira um nome para o exerc√≠cio.'); return; } try { await ensureDbOpen(); let imageId = 0; if (currentImageData) { imageId = Date.now(); await db.custom_images.put({ id: imageId, data: currentImageData }); } const exerciseData = { name, namePT, type, imageId }; if (id) { await db.custom_exercises.update(parseInt(id), exerciseData); alert((typeof GN_I18N !== 'undefined') ? GN_I18N.t('exercise_updated') : 'Exerc√≠cio atualizado!'); } else { await db.custom_exercises.add(exerciseData); alert((typeof GN_I18N !== 'undefined') ? GN_I18N.t('exercise_saved_local') : 'Exerc√≠cio salvo na sua cole√ß√£o local!'); } localStorage.setItem('has_local_changes', 'true'); closeCustomModal(); await init(); } catch (err) { console.error('Error saving custom exercise:', err); alert((typeof GN_I18N !== 'undefined') ? (GN_I18N.t('failed_to_save_exercise_prefix') + err.message) : ('Falha ao salvar exerc√≠cio: ' + err.message)); } }

        function copyExercise(exId, isCustom = false) { 
            const ex = allExercises.find(e => e.id === exId && !!e.isCustom === !!isCustom); if (!ex) return; 
            document.getElementById('exId').value = ''; document.getElementById('exName').value = ex.name; document.getElementById('exNamePT').value = ex.namePT || ''; document.getElementById('exType').value = ex.type; 
            const imgData = images[ex.imageId]; if (imgData) { currentImageData = imgData; document.getElementById('exImagePreview').src = imgData; document.getElementById('exImagePreview').classList.remove('hidden'); document.getElementById('uploadPlaceholder').classList.add('hidden'); } else { currentImageData = null; document.getElementById('exImagePreview').src = ''; document.getElementById('exImagePreview').classList.remove('hidden'); document.getElementById('uploadPlaceholder').classList.add('hidden'); } 
            try { 
                const newLabel = (window.GN_I18N && GN_I18N.t) ? (GN_I18N.t('new') + ' ' + GN_I18N.t('custom_exercise_title')) : 'Copy Custom Exercise'; 
                document.getElementById('customModalTitle').innerText = newLabel; 
            } catch(e){}
            document.getElementById('customExModal').classList.remove('hidden'); 
        }
        function editExercise(exId) { 
            const ex = allExercises.find(e => e.id === exId && e.isCustom); if (!ex) return; 
            document.getElementById('exId').value = ex.id; document.getElementById('exName').value = ex.name; document.getElementById('exNamePT').value = ex.namePT || ''; document.getElementById('exType').value = ex.type; 
            const imgData = images[ex.imageId]; if (imgData) { currentImageData = imgData; document.getElementById('exImagePreview').src = imgData; document.getElementById('exImagePreview').classList.remove('hidden'); document.getElementById('uploadPlaceholder').classList.add('hidden'); } else { currentImageData = null; document.getElementById('exImagePreview').src = ''; document.getElementById('exImagePreview').classList.remove('hidden'); document.getElementById('uploadPlaceholder').classList.add('hidden'); } 
            try { document.getElementById('customModalTitle').innerText = (window.GN_I18N && GN_I18N.t) ? GN_I18N.t('custom_exercise_title') : 'Custom Exercise'; } catch(e){}
            document.getElementById('customExModal').classList.remove('hidden'); 
        }

        // Apply translations and localized title
        try {
            if (window.GN_I18N) {
                GN_I18N.applyTranslations(document);
                document.title = GN_I18N.t('title_main') + ' | ' + (new URLSearchParams(window.location.search).get('id') ? GN_I18N.t('page_routine_edit') : GN_I18N.t('page_routine_new'));
            }
        } catch(e){}

        window.addEventListener('load', init);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GymNerd | Workouts</title>
    <link rel="icon" type="image/svg+xml" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <script src="auth.js"></script>
    <script src="drive-storage.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="db.js"></script>
    <style>
        :root { --primary: #3b82f6; --primary-grad: linear-gradient(135deg, #60a5fa 0%, #2563eb 100%); --secondary-grad: linear-gradient(135deg, #D1D5DB 0%, #9CA3AF 100%); --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --text-dim: #94a3b8; --success: #10b981; --danger: #ef4444; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); max-width: 500px; margin: 0 auto; padding: 20px; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .header h2 { font-weight: 800; letter-spacing: -0.5px; background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; }
        .back-btn { text-decoration: none; font-size: 1.5rem; color: var(--text); }
        .card { background: var(--card); padding: 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px; }
        .input-group { display: flex; flex-direction: column; gap: 10px; }
        input, button { padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); font-size: 1rem; background: rgba(255,255,255,0.05); color: white; }
        
        button.primary { background: var(--primary-grad); color: white; border: none; font-weight: bold; cursor: pointer; }
        button.update { background: var(--success); color: white; border: none; font-weight: bold; cursor: pointer; display: none; }
        .cancel-link { text-align: center; font-size: 0.8rem; color: #ef4444; cursor: pointer; display: none; margin-top: 5px; text-decoration: underline; }

        .ex-picker { max-height: 300px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 10px; margin: 10px 0; background: rgba(0,0,0,0.2); }
        details.picker-group { margin-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        summary.picker-header { font-size: 0.85rem; font-weight: bold; padding: 12px; cursor: pointer; text-transform: capitalize; list-style: none; display: flex; justify-content: space-between; align-items: center; color: var(--text-dim); }
        .picker-item { display: flex; align-items: center; gap: 10px; padding: 6px 15px; flex-wrap: wrap; }
        .ex-inputs { display: none; gap: 5px; align-items: center; margin-left: 30px; width: 100%; margin-top: 5px; }
        .ex-checkbox:checked ~ .ex-inputs { display: flex; flex-direction: column; align-items: flex-start; }
        summary.picker-header .chevron { transition: transform 0.2s; color: var(--text-dim); }
        details[open] summary.picker-header .chevron { transform: rotate(180deg); }

        .set-row-input { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; }
        .set-row-input input { width: 70px; padding: 8px; font-size: 0.8rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: #000; }
        .add-set-btn { background: rgba(255,255,255,0.05); border: 1px dashed rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; cursor: pointer; color: var(--text-dim); margin-bottom: 10px; }
        .remove-set-btn { background: none; border: none; color: #ef4444; cursor: pointer; font-size: 1rem; padding: 0 5px; }

        .picker-item input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary); }

        .workout-card { background: var(--card); padding: 20px; border-radius: 16px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05); }
        .workout-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .workout-name { font-weight: 800; font-size: 1.2rem; color: var(--primary); }
        .exercise-tag { display: block; background: rgba(255,255,255,0.03); padding: 12px; border-radius: 12px; font-size: 0.85rem; margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.05); }
        
        .set-pills { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
        .set-pill { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 3px 8px; border-radius: 6px; font-size: 0.7rem; color: var(--text-dim); font-weight: 600; }
        
        .actions { display: flex; gap: 12px; }
        .edit-btn { color: var(--primary); background: rgba(255,255,255,0.05); border: none; cursor: pointer; display: flex; align-items: center; padding: 10px; border-radius: 10px; transition: background 0.2s; }
        .del-btn { color: var(--danger); background: rgba(255,255,255,0.05); border: none; cursor: pointer; display: flex; align-items: center; padding: 10px; border-radius: 10px; transition: background 0.2s; }

        .section-title { margin-top: 40px; margin-bottom: 20px; font-weight: 800; font-size: 1.5rem; letter-spacing: -0.5px; padding-left: 5px; background: var(--secondary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; width: fit-content; }
    </style>
</head>
<body>
    <div class="header"><a href="index.html" class="back-btn">←</a><h2>My Workouts</h2></div>

    <div class="card">
        <div class="input-group">
            <label style="font-size:0.8rem; font-weight:bold">Workout Name</label>
            <input type="text" id="workoutName" placeholder="e.g. Leg Day">
            <input type="hidden" id="editId">
            
            <label style="font-size:0.8rem; font-weight:bold">Select Exercises</label>
            <div id="exercisePicker" class="ex-picker"></div>
            
            <button id="addBtn" class="primary" onclick="saveWorkout()">Create Workout</button>
            <button id="updateBtn" class="update" onclick="updateWorkout()">Update Workout</button>
            <div id="cancelEdit" class="cancel-link" onclick="resetForm()">Cancel Editing</div>
        </div>
    </div>

    <h3 class="section-title">Workouts</h3>
    <div id="workout-list"></div>

    <script>

        let allExercises = [];

        async function init() {
            await ensureDbOpen();
            const fallback = await db.images.get(0);
            if (!fallback) {
                await db.images.put({ id: 0, data: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM5NGFhYjgiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cmVjdCB4PSIzIiB5PSIzIiB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHJ4PSIyIiByeT0iMiIvPjxjaXJjbGUgY3g9IjguNSIgY3k9IjguNSIgcj0iMS41Ii8+PHBhdGggZD0iTTIxIDE1bC01LTUtNCA0LTQtNC04IDgiLz48L3N2Zz4=" });
            }
            allExercises = await db.exercises.toArray();
            renderPicker();
            renderWorkouts();
        }

        function renderPicker() {
            const container = document.getElementById('exercisePicker');
            const groups = allExercises.reduce((acc, ex) => {
                if (!acc[ex.type]) acc[ex.type] = [];
                acc[ex.type].push(ex);
                return acc;
            }, {});

            container.innerHTML = Object.keys(groups).sort().map(type => `
                <details class="picker-group">
                    <summary class="picker-header"><span>${type}</span><svg class="chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></summary>
                    <div style="padding-bottom:10px">
                        ${groups[type].map(ex => `
                            <div class="picker-item">
                                <input type="checkbox" value="${ex.id}" class="ex-checkbox" id="chk-${ex.id}" onchange="handleCheckboxChange(${ex.id}, this.checked)">
                                <label for="chk-${ex.id}" style="font-size:0.85rem; cursor:pointer">${ex.name}</label>
                                <div class="ex-inputs">
                                    <div class="sets-container" id="sets-container-${ex.id}"></div>
                                    <button type="button" class="add-set-btn" onclick="addSetRow(${ex.id})">+ Add Set</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </details>
            `).join('');
        }

        function handleCheckboxChange(exId, isChecked) {
            if (isChecked) {
                const container = document.getElementById(`sets-container-${exId}`);
                if (container && container.children.length === 0) {
                    addSetRow(exId);
                }
            }
        }

        function addSetRow(exId, reps = "", weight = "") {
            const container = document.getElementById(`sets-container-${exId}`);
            
            // Use previously set value if available and not provided
            if (reps === "" && weight === "" && container.lastElementChild) {
                reps = container.lastElementChild.querySelector('.set-reps').value;
                weight = container.lastElementChild.querySelector('.set-weight').value;
            }

            const div = document.createElement('div');
            div.className = 'set-row-input';
            div.innerHTML = `
                <span style="font-size:0.7rem; color:#64748b; width:20px">S${container.children.length + 1}</span>
                <input type="number" placeholder="Reps" class="set-reps" value="${reps}">
                <input type="number" step="0.5" placeholder="Kg" class="set-weight" value="${weight}">
                <button type="button" class="remove-set-btn" onclick="this.parentElement.remove(); updateSetLabels(${exId})">×</button>
            `;
            container.appendChild(div);
        }

        function updateSetLabels(exId) {
            const container = document.getElementById(`sets-container-${exId}`);
            Array.from(container.children).forEach((row, i) => {
                row.querySelector('span').innerText = `S${i + 1}`;
            });
        }

        async function saveWorkout() {
            const name = document.getElementById('workoutName').value;
            const exerciseIds = Array.from(document.querySelectorAll('.picker-item'))
                .filter(item => item.querySelector('.ex-checkbox').checked)
                .map(item => {
                    const cb = item.querySelector('.ex-checkbox');
                    const sets = Array.from(item.querySelectorAll('.set-row-input')).map(row => ({
                        reps: parseInt(row.querySelector('.set-reps').value) || 0,
                        weight: parseFloat(row.querySelector('.set-weight').value) || 0
                    }));
                    return {
                        id: parseInt(cb.value),
                        sets: sets
                    };
                });
            if (!name || exerciseIds.length === 0) return alert("Missing name or exercises");
            await db.workouts.add({ name, exerciseIds });
            localStorage.setItem('has_local_changes', 'true');
            resetForm();
            renderWorkouts();
        }

        async function prepareEdit(id) {
            const workout = await db.workouts.get(id);
            if (!workout) return;

            document.getElementById('workoutName').value = workout.name;
            document.getElementById('editId').value = id;
            
            // Ensure all exercise groups are expanded when editing
            document.querySelectorAll('.picker-group').forEach(det => det.open = true);

            document.querySelectorAll('.ex-checkbox').forEach(cb => {
                const item = workout.exerciseIds.find(i => (typeof i === 'object' ? i.id : i) === parseInt(cb.value));
                cb.checked = !!item;
                const container = document.getElementById(`sets-container-${cb.value}`);
                if (container) container.innerHTML = "";
                
                if (item && typeof item === 'object') {
                    if (Array.isArray(item.sets)) {
                        item.sets.forEach(s => addSetRow(item.id, s.reps, s.weight));
                    } else {
                        // Migration/Fallback for old structure
                        for(let i=0; i<(item.sets||3); i++) addSetRow(item.id, item.reps, item.weight);
                    }
                }
            });

            // UI Changes
            document.getElementById('addBtn').style.display = 'none';
            document.getElementById('updateBtn').style.display = 'block';
            document.getElementById('cancelEdit').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function updateWorkout() {
            const id = parseInt(document.getElementById('editId').value);
            const name = document.getElementById('workoutName').value;
            const exerciseIds = Array.from(document.querySelectorAll('.picker-item'))
                .filter(item => item.querySelector('.ex-checkbox').checked)
                .map(item => {
                    const cb = item.querySelector('.ex-checkbox');
                    const sets = Array.from(item.querySelectorAll('.set-row-input')).map(row => ({
                        reps: parseInt(row.querySelector('.set-reps').value) || 0,
                        weight: parseFloat(row.querySelector('.set-weight').value) || 0
                    }));
                    return {
                        id: parseInt(cb.value),
                        sets: sets
                    };
                });

            if (!name || exerciseIds.length === 0) return alert("Missing name or exercises");

            await db.workouts.update(id, { name, exerciseIds });
            localStorage.setItem('has_local_changes', 'true');
            resetForm();
            renderWorkouts();
        }

        function resetForm() {
            document.getElementById('workoutName').value = "";
            document.getElementById('editId').value = "";
            document.querySelectorAll('.ex-checkbox').forEach(cb => {
                cb.checked = false;
                const container = document.getElementById(`sets-container-${cb.value}`);
                if (container) container.innerHTML = "";
            });
            // Collapse all exercise groups for the "new workout" state
            document.querySelectorAll('.picker-group').forEach(det => det.open = false);
            document.getElementById('addBtn').style.display = 'block';
            document.getElementById('updateBtn').style.display = 'none';
            document.getElementById('cancelEdit').style.display = 'none';
        }

        async function renderWorkouts() {
            const workouts = await db.workouts.toArray();
            const container = document.getElementById('workout-list');
            container.innerHTML = workouts.map(w => {
                const tags = w.exerciseIds.map(item => {
                    const id = typeof item === 'object' ? item.id : item;
                    const ex = allExercises.find(e => e.id === id);
                    if (!ex) return "";

                    let setsHtml = '';
                    if (typeof item === 'object' && Array.isArray(item.sets)) {
                        setsHtml = `<div class="set-pills">` + 
                            item.sets.map(s => `<span class="set-pill">${s.reps} × ${s.weight}kg</span>`).join('') + 
                            `</div>`;
                    } else if (typeof item === 'object') {
                        // Fallback for old structure
                        setsHtml = `<div class="set-pills"><span class="set-pill">${item.sets} sets × ${item.reps} × ${item.weight}kg</span></div>`;
                    }

                    return `<div class="exercise-tag"><strong>${ex.name}</strong>${setsHtml}</div>`;
                }).join('');

                return `
                    <div class="workout-card">
                        <div class="workout-header">
                            <span class="workout-name">${w.name}</span>
                            <div class="actions">
                                <button class="edit-btn" onclick="prepareEdit(${w.id})" title="Edit">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                                </button>
                                <button class="del-btn" onclick="deleteWorkout(${w.id})" title="Delete">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                </button>
                            </div>
                        </div>
                        <div>${tags}</div>
                    </div>
                `;
            }).join('');
        }

        async function deleteWorkout(id) {
            if(confirm("Delete workout?")) { await db.workouts.delete(id); localStorage.setItem('has_local_changes', 'true'); renderWorkouts(); }
        }

        init();
    </script>
</body>
</html>
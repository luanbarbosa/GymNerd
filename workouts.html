<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GymFlow | Workouts</title>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); max-width: 500px; margin: 0 auto; padding: 20px; }
        .header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .back-btn { text-decoration: none; font-size: 1.5rem; color: var(--text); }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .input-group { display: flex; flex-direction: column; gap: 10px; }
        input, button { padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 1rem; }
        
        button.primary { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        button.update { background: var(--success); color: white; border: none; font-weight: bold; cursor: pointer; display: none; }
        .cancel-link { text-align: center; font-size: 0.8rem; color: #ef4444; cursor: pointer; display: none; margin-top: 5px; text-decoration: underline; }

        .ex-picker { max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; margin: 10px 0; background: #fff; }
        details.picker-group { margin-bottom: 5px; border-bottom: 1px solid #f1f5f9; }
        summary.picker-header { font-size: 0.85rem; font-weight: bold; padding: 8px; cursor: pointer; text-transform: capitalize; list-style: none; display: flex; justify-content: space-between; }
        .picker-item { display: flex; align-items: center; gap: 10px; padding: 6px 15px; flex-wrap: wrap; }
        .ex-inputs { display: none; gap: 5px; align-items: center; margin-left: 30px; width: 100%; margin-top: 5px; }
        .ex-checkbox:checked ~ .ex-inputs { display: flex; flex-direction: column; align-items: flex-start; }
        summary.picker-header::after { content: '▾'; color: #94a3b8; }
        details[open] summary.picker-header::after { content: '▴'; }

        .set-row-input { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; }
        .set-row-input input { width: 60px; padding: 5px; font-size: 0.8rem; border-radius: 4px; border: 1px solid #cbd5e1; }
        .add-set-btn { background: #f1f5f9; border: 1px dashed #cbd5e1; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; color: #64748b; margin-bottom: 10px; }
        .remove-set-btn { background: none; border: none; color: #ef4444; cursor: pointer; font-size: 1rem; padding: 0 5px; }

        .picker-item { display: flex; align-items: center; gap: 10px; padding: 6px 15px; }
        .picker-item input[type="checkbox"] { width: auto; cursor: pointer; }

        .workout-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #e2e8f0; }
        .workout-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .workout-name { font-weight: 800; font-size: 1.1rem; color: var(--primary); }
        .exercise-tag { display: block; background: #f1f5f9; padding: 8px; border-radius: 6px; font-size: 0.8rem; margin-bottom: 5px; border: 1px solid #e2e8f0; }
        
        .actions { display: flex; gap: 15px; }
        .edit-link { color: var(--primary); background: none; border: none; cursor: pointer; font-size: 0.85rem; font-weight: bold; }
        .del-link { color: #ef4444; background: none; border: none; cursor: pointer; font-size: 0.85rem; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header"><a href="index.html" class="back-btn">←</a><h2>My Workouts</h2></div>

    <div class="card">
        <div class="input-group">
            <label style="font-size:0.8rem; font-weight:bold">Workout Name</label>
            <input type="text" id="workoutName" placeholder="e.g. Leg Day">
            <input type="hidden" id="editId">
            
            <label style="font-size:0.8rem; font-weight:bold">Select Exercises</label>
            <div id="exercisePicker" class="ex-picker"></div>
            
            <button id="addBtn" class="primary" onclick="saveWorkout()">Create Workout</button>
            <button id="updateBtn" class="update" onclick="updateWorkout()">Update Workout</button>
            <div id="cancelEdit" class="cancel-link" onclick="resetForm()">Cancel Editing</div>
        </div>
    </div>

    <div id="workout-list"></div>

    <script>
        const db = new Dexie("GymAppDB");
        db.version(6).stores({ 
            exercises: '++id, name, type, imageId',
            logs: '++id, exerciseId, exerciseName, weight, reps, date, imageId',
            workouts: '++id, name, exerciseIds',
            images: '++id' 
        });

        let allExercises = [];

        async function init() {
            const fallback = await db.images.get(0);
            if (!fallback) {
                await db.images.put({ id: 0, data: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM5NGFhYjgiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cmVjdCB4PSIzIiB5PSIzIiB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHJ4PSIyIiByeT0iMiIvPjxjaXJjbGUgY3g9IjguNSIgY3k9IjguNSIgcj0iMS41Ii8+PHBhdGggZD0iTTIxIDE1bC01LTUtNCA0LTQtNC04IDgiLz48L3N2Zz4=" });
            }
            allExercises = await db.exercises.toArray();
            renderPicker();
            renderWorkouts();
        }

        function renderPicker() {
            const container = document.getElementById('exercisePicker');
            const groups = allExercises.reduce((acc, ex) => {
                if (!acc[ex.type]) acc[ex.type] = [];
                acc[ex.type].push(ex);
                return acc;
            }, {});

            container.innerHTML = Object.keys(groups).sort().map(type => `
                <details class="picker-group">
                    <summary class="picker-header">${type}</summary>
                    <div style="padding-bottom:10px">
                        ${groups[type].map(ex => `
                            <div class="picker-item">
                                <input type="checkbox" value="${ex.id}" class="ex-checkbox" id="chk-${ex.id}" onchange="handleCheckboxChange(${ex.id}, this.checked)">
                                <label for="chk-${ex.id}" style="font-size:0.85rem; cursor:pointer">${ex.name}</label>
                                <div class="ex-inputs">
                                    <div class="sets-container" id="sets-container-${ex.id}"></div>
                                    <button type="button" class="add-set-btn" onclick="addSetRow(${ex.id})">+ Add Set</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </details>
            `).join('');
        }

        function handleCheckboxChange(exId, isChecked) {
            if (isChecked) {
                const container = document.getElementById(`sets-container-${exId}`);
                if (container && container.children.length === 0) {
                    addSetRow(exId);
                }
            }
        }

        function addSetRow(exId, reps = "", weight = "") {
            const container = document.getElementById(`sets-container-${exId}`);
            
            // Use previously set value if available and not provided
            if (reps === "" && weight === "" && container.lastElementChild) {
                reps = container.lastElementChild.querySelector('.set-reps').value;
                weight = container.lastElementChild.querySelector('.set-weight').value;
            }

            const div = document.createElement('div');
            div.className = 'set-row-input';
            div.innerHTML = `
                <span style="font-size:0.7rem; color:#64748b; width:20px">S${container.children.length + 1}</span>
                <input type="number" placeholder="Reps" class="set-reps" value="${reps}">
                <input type="number" step="0.5" placeholder="Kg" class="set-weight" value="${weight}">
                <button type="button" class="remove-set-btn" onclick="this.parentElement.remove(); updateSetLabels(${exId})">×</button>
            `;
            container.appendChild(div);
        }

        function updateSetLabels(exId) {
            const container = document.getElementById(`sets-container-${exId}`);
            Array.from(container.children).forEach((row, i) => {
                row.querySelector('span').innerText = `S${i + 1}`;
            });
        }

        async function saveWorkout() {
            const name = document.getElementById('workoutName').value;
            const exerciseIds = Array.from(document.querySelectorAll('.picker-item'))
                .filter(item => item.querySelector('.ex-checkbox').checked)
                .map(item => {
                    const cb = item.querySelector('.ex-checkbox');
                    const sets = Array.from(item.querySelectorAll('.set-row-input')).map(row => ({
                        reps: parseInt(row.querySelector('.set-reps').value) || 0,
                        weight: parseFloat(row.querySelector('.set-weight').value) || 0
                    }));
                    return {
                        id: parseInt(cb.value),
                        sets: sets
                    };
                });
            if (!name || exerciseIds.length === 0) return alert("Missing name or exercises");
            await db.workouts.add({ name, exerciseIds });
            resetForm();
            renderWorkouts();
        }

        async function prepareEdit(id) {
            const workout = await db.workouts.get(id);
            if (!workout) return;

            document.getElementById('workoutName').value = workout.name;
            document.getElementById('editId').value = id;
            
            document.querySelectorAll('.ex-checkbox').forEach(cb => {
                const item = workout.exerciseIds.find(i => (typeof i === 'object' ? i.id : i) === parseInt(cb.value));
                cb.checked = !!item;
                const container = document.getElementById(`sets-container-${cb.value}`);
                if (container) container.innerHTML = "";
                
                if (item && typeof item === 'object') {
                    if (Array.isArray(item.sets)) {
                        item.sets.forEach(s => addSetRow(item.id, s.reps, s.weight));
                    } else {
                        // Migration/Fallback for old structure
                        for(let i=0; i<(item.sets||3); i++) addSetRow(item.id, item.reps, item.weight);
                    }
                }
            });

            // UI Changes
            document.getElementById('addBtn').style.display = 'none';
            document.getElementById('updateBtn').style.display = 'block';
            document.getElementById('cancelEdit').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function updateWorkout() {
            const id = parseInt(document.getElementById('editId').value);
            const name = document.getElementById('workoutName').value;
            const exerciseIds = Array.from(document.querySelectorAll('.picker-item'))
                .filter(item => item.querySelector('.ex-checkbox').checked)
                .map(item => {
                    const cb = item.querySelector('.ex-checkbox');
                    const sets = Array.from(item.querySelectorAll('.set-row-input')).map(row => ({
                        reps: parseInt(row.querySelector('.set-reps').value) || 0,
                        weight: parseFloat(row.querySelector('.set-weight').value) || 0
                    }));
                    return {
                        id: parseInt(cb.value),
                        sets: sets
                    };
                });

            if (!name || exerciseIds.length === 0) return alert("Missing name or exercises");

            await db.workouts.update(id, { name, exerciseIds });
            resetForm();
            renderWorkouts();
        }

        function resetForm() {
            document.getElementById('workoutName').value = "";
            document.getElementById('editId').value = "";
            document.querySelectorAll('.ex-checkbox').forEach(cb => {
                cb.checked = false;
                const container = document.getElementById(`sets-container-${cb.value}`);
                if (container) container.innerHTML = "";
            });
            document.getElementById('addBtn').style.display = 'block';
            document.getElementById('updateBtn').style.display = 'none';
            document.getElementById('cancelEdit').style.display = 'none';
        }

        async function renderWorkouts() {
            const workouts = await db.workouts.toArray();
            const container = document.getElementById('workout-list');
            container.innerHTML = workouts.map(w => {
                const tags = w.exerciseIds.map(item => {
                    const id = typeof item === 'object' ? item.id : item;
                    const ex = allExercises.find(e => e.id === id);
                    if (!ex) return "";
                    if (typeof item === 'object') {
                        const setsInfo = Array.isArray(item.sets) 
                            ? `${item.sets.length} sets` 
                            : `${item.sets} sets x ${item.reps} reps @ ${item.weight}kg`;
                        return `<div class="exercise-tag"><strong>${ex.name}</strong>: ${setsInfo}</div>`;
                    }
                    return `<span class="exercise-tag">${ex.name}</span>`;
                }).join('');

                return `
                    <div class="workout-card">
                        <div class="workout-header">
                            <span class="workout-name">${w.name}</span>
                            <div class="actions">
                                <button class="edit-link" onclick="prepareEdit(${w.id})">Edit</button>
                                <button class="del-link" onclick="deleteWorkout(${w.id})">Delete</button>
                            </div>
                        </div>
                        <div>${tags}</div>
                    </div>
                `;
            }).join('');
        }

        async function deleteWorkout(id) {
            if(confirm("Delete workout?")) { await db.workouts.delete(id); renderWorkouts(); }
        }

        init();
    </script>
</body>
</html>
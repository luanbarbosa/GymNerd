<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#0f172a" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <link rel="manifest" href="./manifest.json" />
    <title>GymNerd</title>
    <link rel="icon" href="favicon.svg" />
    <script src="gn-i18n.js"></script>
    <style>
        body {
            margin: 0;
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            /* Hide by default to avoid flashing the login UI while auth.js refreshes tokens */
            visibility: hidden;
            background: #0f172a;
            padding-top: constant(safe-area-inset-top);
            padding-top: env(safe-area-inset-top);
            color: #0f172a;
        }

        .wrap {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            background: #0f172a;
            width: 100%;
            box-sizing: border-box;
            padding: 36px 16px;
        }

        .hero {
            display:flex;
            flex-direction:column;
            align-items:center;
            gap:8px;
            flex: 1 1 auto;
            justify-content: center;
            width:100%;
        }

        .brand {
            width: 84px;
            height: 84px;
            object-fit: contain;
            border-radius: 18px;
            background: transparent;
        }

        .app-title {
            margin: 8px 0 0 0;
            font-size: 2.2rem;
            font-weight: 900;
            color: #fff;
            letter-spacing: -0.02em;
        }

        .tagline {
            color: #9aa4b6;
            margin-top: 6px;
            font-weight: 600;
        }

        .auth-card {
            width: 100%;
            max-width: 420px;
            background: #ffffff;
            border-radius: 18px;
            padding: 26px;
            box-sizing: border-box;
            box-shadow: 0 12px 30px rgba(2,6,23,0.45);
            margin-bottom: calc(constant(safe-area-inset-bottom) + 16px);
            margin-bottom: calc(env(safe-area-inset-bottom) + 16px);
            text-align: center;
        }

        .auth-card h2 {
            margin: 6px 0 14px 0;
            font-size: 1.6rem;
            color: #0b1220;
            font-weight: 900;
        }

        .google-btn {
            display:flex;
            align-items:center;
            gap:12px;
            justify-content:center;
            width:100%;
            padding:12px 14px;
            border-radius:12px;
            border:1px solid rgba(0,0,0,0.06);
            background: #fff;
            box-shadow: 0 8px 18px rgba(3,7,18,0.06);
            cursor:pointer;
            font-weight:700;
            color:#0b1220;
            font-size:1rem;
        }

        .google-logo { width:20px; height:20px; display:inline-block; }

        .auth-subtext {
            color:#94a3b8;
            font-size:0.92rem;
            margin-top:12px;
            margin-bottom:12px;
        }

        .divider {
            display:flex;align-items:center;gap:12px;margin:18px 0;color:#0f172a;font-size:0.9rem;
        }

        .divider .line { flex:1;height:1px;background:#e5e7eb;opacity:0.8 }

        .demo-btn {
            width:100%;
            padding:14px;
            border-radius:12px;
            border:0;
            cursor:pointer;
            font-weight:700;
            font-size:1rem;
            background: linear-gradient(180deg,#5b95ff,#3b82f6);
            color:white;
            box-shadow: 0 12px 30px rgba(59,130,246,0.18);
        }

        .small-muted { color:#94a3b8; margin-top:12px; font-size:0.9rem }

        a.lang-link { color:#94a3b8 }
    </style>

</head>

<body>
    <script>
        (function(){
            try {
                const token = localStorage.getItem('google_token');
                const expires = localStorage.getItem('google_token_expires_at');
                const refresh = localStorage.getItem('google_refresh_token');
                const isExpired = expires ? (Date.now() > parseInt(expires)) : true;

                // If we have a valid (non-expired) token, go straight to the app.
                if (token && !isExpired) {
                    try {
                        const basePath = window.location.pathname.replace(/\/[^\/]*$/, '/');
                        const target = basePath + 'index.html?start=home';
                        try { window.location.replace(target); return; } catch(e) { window.location.replace('index.html?start=home'); return; }
                    } catch(e) { try { window.location.replace('index.html?start=home'); return; } catch(_){} }
                }

                // If token is expired but we have a refresh token, show a
                // full-screen "Refreshing session" overlay and do NOT reveal
                // the login UI. auth.js will attempt refresh and navigate.
                if (token && isExpired && refresh) {
                    try {
                        // Create a simple loader element that auth.js's hideLoading
                        // will later hide if it runs. Use the same id so hideLoading
                        // can target it.
                        if (!document.getElementById('gn-global-loader')) {
                            const el = document.createElement('div');
                            el.id = 'gn-global-loader';
                            el.style.cssText = 'position:fixed;left:0;top:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;background:#0f172a;color:white;z-index:2147483647;padding:20px;box-sizing:border-box;';
                            el.innerHTML = `
                                <div style="max-width:520px;width:100%;text-align:center">
                                    <div id="gn-global-loader-message" style="font-weight:800;font-size:1.1rem;margin-bottom:16px">Refreshing session...</div>
                </div>
                                    <div style="display:flex;align-items:center;justify-content:center">
                                        <div style="width:56px;height:56px;border-radius:50%;border:6px solid rgba(255,255,255,0.12);border-top-color:#3b82f6;animation:gn-spin 1s linear infinite"></div>
                                    </div>
                                </div>
                            `;
                            const style = document.createElement('style');
                            style.id = 'gn-global-loader-style';
                            style.textContent = `@keyframes gn-spin { to { transform: rotate(360deg); } }`;
                            document.head.appendChild(style);
                            // hide page content underneath
                            try {
                                const children = Array.from(document.body.children);
                                for (const c of children) {
                                    if (c.id === 'gn-global-loader') continue;
                                    c.dataset.gnPrevDisplay = c.style.display || '';
                                    c.style.display = 'none';
                                }
                                document.body.dataset.gnHidden = '1';
                            } catch (e) {}
                            document.body.appendChild(el);
                        }
                        return; // don't reveal login UI
                    } catch (e) {
                        // fallback to showing login UI if overlay creation fails
                    }
                }
            } catch(e) {}

            // No valid session and no refresh possible — reveal the login UI
            // unless an interactive sign-in is in progress (set by auth.js).
            try {
                if (window.__gn_signing_in) {
                    // keep page hidden; auth.js will complete the exchange and
                    // navigate or reveal when appropriate.
                } else {
                    document.body.style.visibility = 'visible';
                }
            } catch(e) { document.documentElement.style.visibility = 'visible'; }
        })();
    </script>
    <!-- language selector removed -->
    <div class="wrap">
        <div class="hero">
            <img src="favicon.svg" alt="App icon" class="brand" />
            <div class="app-title" data-i18n="title_main"></div>
            <div class="tagline" data-i18n="tagline"></div>
        </div>

        <div class="auth-card">
            
            <button id="signin-google" class="google-btn" aria-label="Continue with Google">
                <span class="google-logo">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 533.5 544.3" width="20" height="20" aria-hidden="true">
                        <path fill="#4285F4" d="M533.5 278.4c0-17.4-1.4-34-4.1-50.2H272v95h147.1c-6.3 34-25 62.9-53.4 82v68h86.2c50.4-46.4 80.6-115 80.6-194.8z"/>
                        <path fill="#34A853" d="M272 544.3c72.7 0 133.7-24.1 178.3-65.4l-86.2-68c-24 16.1-55 25.4-92.1 25.4-70.8 0-130.8-47.7-152.2-111.6H32.8v69.9C77.2 482 167 544.3 272 544.3z"/>
                        <path fill="#FBBC05" d="M119.8 328.7c-10.9-32.9-10.9-68.8 0-101.7V157.1H32.8c-39.5 78.9-39.5 171.1 0 250l87-78.4z"/>
                        <path fill="#EA4335" d="M272 107.7c39.6-.6 77.7 14.3 106.7 40.6l80-80C403.4 24.5 344.6 0 272 0 167 0 77.2 62.3 32.8 157.1l87 69.9c21.4-63.9 81.4-111.6 152.2-111.6z"/>
                    </svg>
                </span>
                <span data-i18n="sign_in_with_google"></span>
            </button>

            <div id="auth-status-container" class="auth-subtext" data-i18n="signin_subtext"></div>

            <div class="divider"><div class="line"></div><div data-i18n="or"></div><div class="line"></div></div>

            <button id="demo-mode" class="demo-btn"><span data-i18n="demo_mode"></span></button>

            <div class="small-muted" data-i18n="demo_mode_warning"></div>
        </div>
    </div>

    <script>
        try { if (typeof GN_I18N !== 'undefined' && typeof GN_I18N.applyTranslations === 'function') GN_I18N.applyTranslations(document); } catch(e){}
    </script>

    <script src="auth.js"></script>
    <script>
        <!-- language selector initialization removed -->

        document.getElementById('signin-google').addEventListener('click', function () {
            if (typeof handleAuth === 'function') return handleAuth();
            try {
                const basePath = window.location.pathname.replace(/\/[^\/]*$/, '/');
                const target = basePath + 'index.html?start=home';
                try { window.location.replace(target); } catch(e) { window.location.href = 'index.html?start=home'; }
            } catch(e) { try { window.location.replace('index.html?start=home'); } catch(_) { window.location.href = 'index.html?start=home'; } }
        });
        const demoBtn = document.getElementById('demo-mode');
        if (demoBtn) {
            try { if (typeof GN_I18N !== 'undefined') demoBtn.textContent = GN_I18N.t('demo_mode'); } catch(e){}
            demoBtn.addEventListener('click', function(e){
                    try { e.preventDefault(); } catch(e){}
                    const msg = (typeof GN_I18N !== 'undefined') ? GN_I18N.t('demo_mode_warning') : 'The data will be stored locally and might be cleared by the system.';
                    try { alert(msg); } catch(e) { console.warn('alert failed', e); }
                    try { window.location.replace('index.html?start=home'); } catch(e) { window.location.href = 'index.html?start=home'; }
                });
        }
    </script>
    <script>
        (function initAuthUI(){
            function safeText(s){ return (s || '').toString(); }

            function render(state){
                const status = document.getElementById('auth-status-container');
                const signinBtn = document.getElementById('signin-google');
                if (!status) return;
                // If running on the login page and we have a valid session, navigate to home
                try {
                        if (state && state.token && !state.isExpired && (window.location.pathname === '/' || window.location.pathname.endsWith('index.html'))) {
                        try {
                            const basePath = window.location.pathname.replace(/\/[^\/]*$/, '/');
                            const target = basePath + 'index.html?start=home';
                            try { window.location.replace(target); return; } catch(e) { try { window.location.href = 'index.html?start=home'; } catch(e2){} }
                        } catch(e) { try { window.location.replace('index.html?start=home'); return; } catch(e2){} }
                    }
                } catch(e) {}
                try {
                    if (state && state.token && !state.isExpired) {
                        if (signinBtn) signinBtn.style.display = 'none';
                        const user = state.user || {};
                        const origin = (window && window.location && window.location.origin && window.location.origin !== 'null' && !String(window.location.origin).startsWith('file:')) ? window.location.origin : '';
                        const basePath = window.location.pathname.replace(/\/[^\/] *$/, '/');
                        const fallbackAvatar = origin ? (origin + basePath + 'icons/icon-512.svg') : 'icons/icon-512.svg';
                        const pic = (window && window.DEMO_MODE) ? fallbackAvatar : (safeText(user.picture) || fallbackAvatar);
                        const name = safeText(user.name) || '';
                        const connected = state.isBypass ? '' : '<div style="font-size:0.8rem;color:#94a3b8;margin-top:6px;"><span style="color:#10b981">●</span> Connected to Drive</div>';
                        status.innerHTML = `
                            <div style="display:flex;align-items:center;gap:12px">
                                <img src="${pic}" alt="avatar" style="width:48px;height:48px;border-radius:8px;object-fit:cover;border:1px solid rgba(255,255,255,0.04);" onerror="this.onerror=null;this.src='${fallbackAvatar}'"/>
                                <div style="text-align:left">
                                    <div style="font-weight:800;color:#e2e8f0">${name}</div>
                                    ${connected}
                                    <div style="margin-top:8px">
                                        <a href="settings.html" style="color:#94a3b8;margin-right:10px;text-decoration:none;font-weight:700">Settings</a>
                                        <button id="logout-btn" style="background:#111827;color:#fff;border-radius:8px;padding:6px 10px;border:none;cursor:pointer;font-weight:700">Logout</button>
                                    </div>
                                </div>
                            </div>
                        `;
                        const logoutBtn = document.getElementById('logout-btn');
                        if (logoutBtn) logoutBtn.addEventListener('click', () => { try { if (typeof window.logout === 'function') window.logout(); } catch(e){} });
                    } else {
                        if (signinBtn) signinBtn.style.display = '';
                        try {
                            const sub = (typeof GN_I18N !== 'undefined' && typeof GN_I18N.t === 'function') ? GN_I18N.t('signin_subtext') : 'Sign in with Google to sync your data.';
                            status.textContent = sub;
                        } catch (e) { status.textContent = 'Sign in with Google to sync your data.'; }
                    }
                } catch (e) { console.warn('auth UI render failed', e); }
            }

            function showRefreshModal(detail){
                try {
                    const existing = document.getElementById('auth-refresh-modal');
                    if (existing) return;
                    const modal = document.createElement('div');
                    modal.id = 'auth-refresh-modal';
                    modal.style = 'position:fixed;inset:0;background:rgba(15,17,26,0.98);display:flex;align-items:center;justify-content:center;z-index:1000000;padding:20px;';
                    modal.innerHTML = `
                        <div style="max-width:420px;width:100%;color:white;font-family:system-ui, -apple-system,\"Segoe UI\", Roboto,\"Helvetica Neue\", Arial;">
                            <h2 style="margin:0 0 8px 0; font-size:1.6rem">${safeText(detail.title)}</h2>
                            <p style="color:#94a3b8;margin:0 0 18px 0">${safeText(detail.message)}</p>
                            <div style="display:flex;gap:10px">
                                <button id="auth-retry-btn" style="flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:#1e293b;color:white;font-weight:700">${safeText(detail.retryText || 'Retry')}</button>
                                <button id="auth-signin-btn" style="flex:1;padding:12px;border-radius:10px;border:none;background:#3b82f6;color:white;font-weight:700">${safeText(detail.signInText || 'Sign in with Google')}</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    const retry = document.getElementById('auth-retry-btn');
                    const signin = document.getElementById('auth-signin-btn');
                    if (retry) retry.addEventListener('click', async () => {
                        try {
                            if (typeof window.ensureGoogleAccessToken === 'function') {
                                const ok = await window.ensureGoogleAccessToken();
                                if (ok) location.reload(); else alert(detail.message || 'Refresh failed. Please sign in.');
                            } else {
                                alert(detail.message || 'Refresh failed. Please sign in.');
                            }
                        } catch (e) { alert(detail.message || 'Refresh failed. Please sign in.'); }
                    });
                    if (signin) signin.addEventListener('click', () => { try { if (typeof window.handleAuth === 'function') window.handleAuth(); } catch(e){} });
                } catch (e) { console.warn('failed to show refresh modal', e); }
            }

            document.addEventListener('DOMContentLoaded', async () => {
                try {
                    if (typeof renderAuthStatus === 'function') {
                        const state = await renderAuthStatus();
                        render(state);
                    }
                } catch (e) { console.warn('initAuthUI failed', e); }
            });

            window.addEventListener('auth-refresh-error', (ev) => { try { showRefreshModal(ev.detail || {}); } catch(e){} });
            window.addEventListener('userchange', (ev) => { try { if (typeof renderAuthStatus === 'function') renderAuthStatus().then(render); } catch(e){} });
        })();
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').then(() => console.log('Service worker registered from index')).catch(err => console.warn('SW registration failed', err));
        }
    </script>
</body>

</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#ffffff">
    <title>GymNerd | Log Entry</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="apple-touch-icon" href="favicon.svg">
    <link href="https://fonts.googleapis.com" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,300,0,0" rel="stylesheet">
    <script src="auth.js"></script>
    <script src="gn-i18n.js"></script>
    <script src="drive-storage.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="db.js"></script>
    <link rel="stylesheet" href="styles/app-titles.css">
    <style>
        :root { --primary: #3b82f6; --primary-grad: linear-gradient(135deg, #60a5fa 0%, #2563eb 100%); --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --text-dim: #94a3b8; --success: #10b981; --danger: #ef4444; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); max-width: 500px; margin: 0 auto; padding: 0; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .top-card { position: static; background: linear-gradient(180deg, #ffffff 0%, #ffffff 70%, #f3f4f6 100%); color: #0f172a; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; padding: 10px 16px 6px; box-shadow: 0 6px 16px rgba(2,6,23,0.06); padding-top: calc(10px + constant(safe-area-inset-top)); padding-top: calc(10px + env(safe-area-inset-top)); }
        body::before { content: ''; position: fixed; top: 0; left: 0; right: 0; height: constant(safe-area-inset-top); height: env(safe-area-inset-top); background: #ffffff; z-index: 1100; pointer-events: none; }
        .top-card-inner { max-width: 100%; display:flex; flex-direction:column; align-items:center; gap:8px; padding-bottom: 2px; }
        .page-content { padding: 16px; padding-top: 12px; }
        .top-card .topbar { background: transparent; padding: 6px 0; display:flex; align-items:center; justify-content:space-between; width:100%; }
        #topbar-title { flex: 1; min-width: 0; display:flex; align-items:center; }
        /* Use same compact app title style as home.html */

        .back-btn { text-decoration: none; font-size: 1.5rem; color: var(--bg); }
        .top-card .back-btn, .top-card .back-btn .material-symbols-outlined { display: inline-flex; align-items: center; justify-content: center; line-height: 1; }
        .card { background: var(--card); padding: 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px; }
        .card h2 { margin-top: 0; margin-bottom: 15px; font-size: 1.2rem; }
        /* Exercise row preview styling */
        .exercise-row { display:flex; flex-direction:column; gap:6px; margin-bottom:12px; padding:12px; background: rgba(255,255,255,0.02); border-radius:12px; border:1px solid rgba(255,255,255,0.03); box-shadow: 0 6px 12px rgba(2,6,23,0.04); }
        .exercise-header { display:flex; align-items:center; justify-content:space-between; gap:12px; padding-bottom:4px; border-bottom: none; }
        .exercise-left { display:flex; align-items:flex-start; gap:12px; flex:1; min-width:0; }
        .exercise-left strong { margin:0; font-size:1rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .ex-thumb { width:56px; height:56px; object-fit:cover; border-radius:8px; flex-shrink:0; background: #ffffff; }
        /* Space between routine selector and first exercise */
        #workoutSheet { margin-top:24px; }
        /* Add top spacing for cancel/save button rows */
        .form-actions { margin-top:18px; display:flex; gap:8px; }
        select, input, button { padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); font-size: 1rem; width: 100%; box-sizing: border-box; background: rgba(255,255,255,0.05); color: white; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1) brightness(2); cursor: pointer; }
        .input-pair { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; grid-column: span 3; }
        /* Sets table (matching routinecrud style) */
        .sets-container { display:flex; flex-direction:column; gap:6px; width:100%; margin-top:6px; padding-top:2px; }
        .sets-container .header-row { display:grid; grid-template-columns: 1fr 1fr 1fr 36px; gap:8px; align-items:center; padding-bottom:6px; border-bottom:1px solid rgba(255,255,255,0.03); }
        .set-row { display:grid; grid-template-columns: 1fr 1fr 1fr 36px; gap:8px; align-items:center; }
        .set-row .field { display:block; }
        .set-row .field label { font-size:0.7rem; color:var(--text-dim); font-weight:700; display:block; text-align:left; margin-left:2px; }
        .set-row.data-row .field label { display:none; }
        .set-row input[type="number"], .set-row input[type="text"] {
            width:100%; padding:14px; border-radius:12px; font-size:1rem; box-sizing:border-box; text-align:center;
            border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: white;
        }
        .set-row input[type="number"]::-webkit-outer-spin-button,
        .set-row input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none; margin: 0;
        }
        .set-row input[type="number"] { -moz-appearance: textfield; }
        .set-row .remove-set-btn { background:transparent; border:none; padding:6px; cursor:pointer; color:var(--text-dim); display:flex; align-items:center; justify-content:center; }
        .add-set-inline { margin-top:6px; padding:6px 10px; border-radius:8px; border:1px dashed rgba(255,255,255,0.06); background:transparent; color:var(--text-dim); cursor:pointer; font-weight:800; font-size:0.75rem; }
        @media (max-width: 380px) { .sets-container .header-row, .set-row { grid-template-columns: 1fr 1fr 1fr 36px; gap:6px; } .set-row input[type="number"], .set-row input[type="text"] { padding:10px; font-size:0.9rem; } }
        .save-session { background: var(--primary-grad); color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2); }
        .save-session.success { background: var(--success); }
        button.primary { background: var(--primary-grad); color: white; border: none; font-weight: bold; cursor: pointer; }
        /* Localized disclaimer shown below the main content (non-fixed, outside rounded background) */
        .disclaimer { text-align: center; color: var(--text-dim); font-size: 0.85rem; padding: 6px 8px; margin: 6px 16px; font-style: italic; }
    </style>
</head>
<body>
    <div class="top-card">
        <div class="top-card-inner">
            <div style="display:flex;align-items:center;width:100%;gap:12px;">
                <a href="history.html" class="back-btn" aria-label="Back"><span class="material-symbols-outlined" aria-hidden="true" style="font-variation-settings: 'wght' 300;">arrow_back</span></a>
                <div style="flex:1;min-width:0;">
                    <h2 class="app-title-compact" data-i18n="history_header">Log Entry</h2>
                </div>
            </div>
        </div>
    </div>
    <div class="page-content">
        <div id="routineFormSection" class="card" style="margin-bottom: 20px;">
            <img src="illustration-history-workout.svg" alt="" style="display:block; margin:0 auto 36px; width:240px; max-width:80%; opacity:0.95;">
            <input type="date" id="logDate" style="margin-bottom:10px">
                <select id="routinePicker" onchange="generateSheet()"><option value="" data-i18n="history_placeholder_choose_routine">-- Choose Routine --</option></select>
                <div id="workoutSheet"></div>
                <div class="form-actions">
                    <button type="button" style="flex:1; width:100%; background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--text-dim); padding:12px; border-radius:12px;" onclick="location.href='history.html'" data-i18n="history_cancel">Cancel</button>
                    <button id="saveBtn" class="primary" style="flex:1; width:100%;" onclick="saveSession()" data-i18n="history_save_session">ðŸ’¾ Save Session</button>
                </div>
        </div>

        <!-- Weight entry handled elsewhere; removed from this page -->

    <!-- Localized disclaimer: will be translated by GN_I18N -->
    <!-- moved below page-content so it sits outside the rounded background -->

    <script>
        function showForm(id) {
            document.getElementById(id).style.display = 'block';
        }
        function hideForm(id) {
            document.getElementById(id).style.display = 'none';
        }

    let allEx = [];
    let isEditMode = false;
    let editLogId = null;
    let editDate = null;

    async function init() {
        await ensureDbOpen();
        const [catalogEx, customEx] = await Promise.all([
            db.catalog_exercises.toArray(),
            db.custom_exercises.toArray()
        ]);
        allEx = [
            ...catalogEx.map(ex => ({ ...ex, isCustom: false })),
            ...customEx.map(ex => ({ ...ex, isCustom: true }))
        ];
        const wks = await db.routines.toArray();
        const p = document.getElementById('routinePicker');
        wks.forEach(w => p.innerHTML += `<option value="${w.id}">${w.name}</option>`);
        document.getElementById('logDate').value = new Date().toISOString().split('T')[0];
        // If opened from History with a mode param, show only the requested form
        try {
            const params = new URLSearchParams(window.location.search);
            const mode = params.get('mode');
            const titleEl = document.querySelector('[data-i18n="history_header"]');
            const editParam = params.get('edit');
            const editDateParam = params.get('editDate');
            if (mode === 'routine') {
                document.getElementById('routineFormSection').style.display = 'block';
                document.getElementById('logDate').value = new Date().toISOString().split('T')[0];
                // if an edit param is present for a single log, prefill sheet with that log
                if (editParam) {
                    const id = parseInt(editParam, 10);
                    if (!isNaN(id)) {
                        isEditMode = true;
                        editLogId = id;
                        try {
                            const log = await db.history.get(id);
                            if (log) {
                                document.getElementById('logDate').value = log.date || document.getElementById('logDate').value;
                                document.getElementById('routinePicker').style.display = 'none';
                                await buildSheetFromLog(log);
                            }
                        } catch(e) { console.error('Failed to load log for edit', e); }
                    }
                }
                // if an editDate param is present, enter session-edit mode and prefill with all logs for the date
                if (editDateParam) {
                    const d = editDateParam;
                    isEditMode = true;
                    editDate = d;
                    try {
                        const logs = await db.history.where('date').equals(d).toArray();
                        document.getElementById('logDate').value = d;
                        document.getElementById('routinePicker').style.display = 'none';
                        await buildSheetFromLogs(logs || []);
                    } catch (e) { console.error('Failed to load logs for editDate', e); }
                }
                if (titleEl) {
                    if (isEditMode) {
                        if (window.GN_I18N && GN_I18N.t) titleEl.innerText = GN_I18N.t('history_edit_routine');
                        else titleEl.innerText = 'Editing routine';
                    } else {
                        if (window.GN_I18N && GN_I18N.t) titleEl.innerText = GN_I18N.t('history_section_log_routine');
                        else titleEl.innerText = 'Log routine';
                    }
                }
                try { if (window.GN_I18N && GN_I18N.t) document.title = GN_I18N.t('title_main') + ' | ' + (isEditMode ? GN_I18N.t('history_edit_routine') : GN_I18N.t('history_section_log_routine')); } catch(e){}
            }
            // Show disclaimer only when operating on routine entries
            try {
                const discEl = document.getElementById('disclaimer');
                if (discEl) discEl.style.display = (mode === 'routine' ? 'block' : 'none');
            } catch (e) {}
        } catch (e) {}
    }

    async function generateSheet() {
        const id = parseInt(document.getElementById('routinePicker').value);
        const sheet = document.getElementById('workoutSheet');
        if(!id) { sheet.innerHTML=""; return; }
        const wk = await db.routines.get(id);
        sheet.innerHTML = "";
        const phSets = GN_I18N.safeT ? GN_I18N.safeT('history_sets') : 'Sets';
        const phKg = GN_I18N.safeT ? GN_I18N.safeT('history_kg') : 'Kg';
        const phReps = GN_I18N.safeT ? GN_I18N.safeT('history_reps') : 'Reps';
        for (const item of wk.exerciseIds) {
            const id = typeof item === 'object' ? item.id : item;
            const isCustom = typeof item === 'object' ? !!item.isCustom : false;
            const ex = allEx.find(e => e.id === id && !!e.isCustom === isCustom);
            if (!ex) continue;
            const imgTable = isCustom ? db.custom_images : db.catalog_images;
            let imgSrc = defaultImage;
            if (ex.imageId) {
                const imgRec = await imgTable.get(ex.imageId);
                if (imgRec && imgRec.data) imgSrc = imgRec.data;
            }
            
            // Normalize incoming sets into an array of groups: {sets, reps, weight}
            const normalizeIncomingSets = (raw) => {
                if (!Array.isArray(raw) || raw.length === 0) return null;
                // compressed format: elements already have `sets` property
                const looksCompressed = raw.every(it => it && it.sets !== undefined);
                if (looksCompressed) return raw.map(it => ({ sets: it.sets || '', reps: it.reps || '', weight: it.weight || '' }));
                // expanded format: array of individual sets like [{reps,weight}, ...]
                const looksExpanded = raw.every(it => it && (it.reps !== undefined || it.weight !== undefined));
                if (!looksExpanded) return null;
                const compressed = [];
                let prevKey = null; let prevReps = null; let prevWeight = null; let count = 0;
                for (const it of raw) {
                    const r = (it.reps === null || it.reps === undefined) ? '' : it.reps;
                    const w = (it.weight === null || it.weight === undefined) ? '' : it.weight;
                    const key = `${r}:::${w}`;
                    if (key === prevKey) { count++; }
                    else {
                        if (prevKey !== null) compressed.push({ sets: count, reps: prevReps, weight: prevWeight });
                        prevKey = key; prevReps = r; prevWeight = w; count = 1;
                    }
                }
                if (prevKey !== null) compressed.push({ sets: count, reps: prevReps, weight: prevWeight });
                return compressed;
            };

            let initialSets = [];
            if (typeof item === 'object') {
                if (Array.isArray(item.sets)) {
                    const norm = normalizeIncomingSets(item.sets);
                    if (norm) initialSets = norm;
                    else initialSets = item.sets.map(s => ({ sets: s.sets || '', reps: s.reps || '', weight: s.weight || '' }));
                } else if (item.sets !== undefined || item.reps !== undefined || item.weight !== undefined) {
                    initialSets = [{ sets: item.sets || '', reps: item.reps || '', weight: item.weight || '' }];
                }
            }
            if (!initialSets || initialSets.length === 0) initialSets = [{ sets: '', reps: '', weight: '' }];

            // build rows HTML for each initial set group
            const rowsHtml = initialSets.map(s => `
                    <div class="set-row data-row">
                        <div class="field"><input type="number" min="0" class="s" value="${s.sets}"></div>
                        <div class="field"><input type="number" class="r" value="${s.reps}"></div>
                        <div class="field"><input type="number" step="0.5" class="w" value="${s.weight}"></div>
                        <div><button type="button" class="remove-set-btn" onclick="this.closest('.set-row').remove()" aria-label="Remove set"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div>
                    </div>
            `).join('');

            sheet.innerHTML += `<div class="exercise-row" data-id="${ex.id}" data-name="${ex.name}" data-name-pt="${ex.namePT || ''}" data-imgid="${ex.imageId || ''}" data-iscustom="${isCustom}">
                <div class="exercise-header">
                    <div class="exercise-left">
                        <img src="${imgSrc}" class="ex-thumb">
                        <strong>${ex.name}</strong>
                    </div>
                    <button onclick="this.closest('.exercise-row').remove()" style="background:none;border:none;color:var(--danger);cursor:pointer;padding:0;display:flex;align-items:center;justify-content:center;width:auto"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                </div>
                <div class="sets-container">
                    <div class="set-row header-row">
                        <div class="field"><label>${phSets}</label></div>
                        <div class="field"><label>${phReps}</label></div>
                        <div class="field"><label>${phKg}</label></div>
                        <div></div>
                    </div>
                    ${rowsHtml}
                    <button type="button" class="add-set-inline" onclick="(function(btn){ const container = btn.parentElement; addSetRowToContainer(container, { sets: '', reps: '', weight: '' }, btn); })(this)">+ Add set</button>
                </div>
            </div>`;
        }
        document.getElementById('saveBtn').style.display = "block";
    }

    // Build the sheet for a single existing log (edit mode)
    async function buildSheetFromLog(log) {
        if (!log) return;
        const sheet = document.getElementById('workoutSheet');
        sheet.innerHTML = '';
        const exId = log.exerciseId;
        const isCustom = (typeof log.isCustom === 'boolean') ? log.isCustom : false;
        // find exercise record
        let ex = allEx.find(e => e.id === exId && !!e.isCustom === isCustom);
        if (!ex) {
            // try DB lookup fallback
            ex = await (isCustom ? db.custom_exercises.get(exId) : db.catalog_exercises.get(exId));
            if (ex) ex = { ...ex, isCustom };
        }
        const imgTable = isCustom ? db.custom_images : db.catalog_images;
        let imgSrc = defaultImage;
        if (ex && ex.imageId) {
            const imgRec = await imgTable.get(ex.imageId);
            if (imgRec && imgRec.data) imgSrc = imgRec.data;
        } else if (log.imageId) {
            const imgRec = await imgTable.get(log.imageId);
            if (imgRec && imgRec.data) imgSrc = imgRec.data;
        }

        const phSets = GN_I18N.safeT ? GN_I18N.safeT('history_sets') : 'Sets';
        const phKg = GN_I18N.safeT ? GN_I18N.safeT('history_kg') : 'Kg';
        const phReps = GN_I18N.safeT ? GN_I18N.safeT('history_reps') : 'Reps';

        const initialSets = [{ sets: (log.sets || ''), reps: (log.reps || ''), weight: (log.weight || '') }];
        const rowsHtml = initialSets.map(s => `
                <div class="set-row data-row">
                    <div class="field"><input type="number" min="0" class="s" value="${s.sets}"></div>
                    <div class="field"><input type="number" class="r" value="${s.reps}"></div>
                    <div class="field"><input type="number" step="0.5" class="w" value="${s.weight}"></div>
                    <div><button type="button" class="remove-set-btn" onclick="this.closest('.set-row').remove()" aria-label="Remove set"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div>
                </div>
        `).join('');

        const name = (ex && ex.name) ? ex.name : (log.exerciseName || `#${exId}`);
        sheet.innerHTML += `<div class="exercise-row" data-id="${exId}" data-name="${name}" data-name-pt="${ex && ex.namePT || ''}" data-imgid="${ex && ex.imageId || log.imageId || ''}" data-iscustom="${isCustom}">
            <div class="exercise-header">
                <div class="exercise-left">
                    <img src="${imgSrc}" class="ex-thumb">
                    <strong>${name}</strong>
                </div>
                <button onclick="this.closest('.exercise-row').remove()" style="background:none;border:none;color:var(--danger);cursor:pointer;padding:0;display:flex;align-items:center;justify-content:center;width:auto"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
            </div>
            <div class="sets-container">
                <div class="set-row header-row">
                    <div class="field"><label>${phSets}</label></div>
                    <div class="field"><label>${phReps}</label></div>
                    <div class="field"><label>${phKg}</label></div>
                    <div></div>
                </div>
                ${rowsHtml}
                <button type="button" class="add-set-inline" onclick="(function(btn){ const container = btn.parentElement; addSetRowToContainer(container, { sets: '', reps: '', weight: '' }, btn); })(this)">+ Add set</button>
            </div>
        </div>`;
        document.getElementById('saveBtn').style.display = 'block';
    }

    // Build the sheet for multiple logs (session edit)
    async function buildSheetFromLogs(logs) {
        const sheet = document.getElementById('workoutSheet');
        sheet.innerHTML = '';
        const phSets = GN_I18N.safeT ? GN_I18N.safeT('history_sets') : 'Sets';
        const phKg = GN_I18N.safeT ? GN_I18N.safeT('history_kg') : 'Kg';
        const phReps = GN_I18N.safeT ? GN_I18N.safeT('history_reps') : 'Reps';
        for (const log of logs) {
            if (!log) continue;
            const exId = log.exerciseId;
            const isCustom = (typeof log.isCustom === 'boolean') ? log.isCustom : false;
            let ex = allEx.find(e => e.id === exId && !!e.isCustom === isCustom);
            if (!ex) {
                ex = await (isCustom ? db.custom_exercises.get(exId) : db.catalog_exercises.get(exId));
                if (ex) ex = { ...ex, isCustom };
            }
            const imgTable = isCustom ? db.custom_images : db.catalog_images;
            let imgSrc = defaultImage;
            if (ex && ex.imageId) {
                const imgRec = await imgTable.get(ex.imageId);
                if (imgRec && imgRec.data) imgSrc = imgRec.data;
            } else if (log.imageId) {
                const imgRec = await imgTable.get(log.imageId);
                if (imgRec && imgRec.data) imgSrc = imgRec.data;
            }

            const initialSets = [{ sets: (log.sets || ''), reps: (log.reps || ''), weight: (log.weight || '') }];
            const rowsHtml = initialSets.map(s => `
                    <div class="set-row data-row">
                        <div class="field"><input type="number" min="0" class="s" value="${s.sets}"></div>
                        <div class="field"><input type="number" class="r" value="${s.reps}"></div>
                        <div class="field"><input type="number" step="0.5" class="w" value="${s.weight}"></div>
                        <div><button type="button" class="remove-set-btn" onclick="this.closest('.set-row').remove()" aria-label="Remove set"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div>
                    </div>
            `).join('');

            const name = (ex && ex.name) ? ex.name : (log.exerciseName || `#${exId}`);
            sheet.innerHTML += `<div class="exercise-row" data-id="${exId}" data-name="${name}" data-name-pt="${ex && ex.namePT || ''}" data-imgid="${ex && ex.imageId || log.imageId || ''}" data-iscustom="${isCustom}">
                <div class="exercise-header">
                    <div class="exercise-left">
                        <img src="${imgSrc}" class="ex-thumb">
                        <strong>${name}</strong>
                    </div>
                    <button onclick="this.closest('.exercise-row').remove()" style="background:none;border:none;color:var(--danger);cursor:pointer;padding:0;display:flex;align-items:center;justify-content:center;width:auto"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                </div>
                <div class="sets-container">
                    <div class="set-row header-row">
                        <div class="field"><label>${phSets}</label></div>
                        <div class="field"><label>${phReps}</label></div>
                        <div class="field"><label>${phKg}</label></div>
                        <div></div>
                    </div>
                    ${rowsHtml}
                    <button type="button" class="add-set-inline" onclick="(function(btn){ const container = btn.parentElement; addSetRowToContainer(container, { sets: '', reps: '', weight: '' }, btn); })(this)">+ Add set</button>
                </div>
            </div>`;
        }
        document.getElementById('saveBtn').style.display = 'block';
    }

    // helper to add a set row into an existing sets-container (used by the add button)
    function addSetRowToContainer(container, setData, beforeNode) {
        if (!container) return;
        const makeField = (el) => { const f = document.createElement('div'); f.className = 'field'; f.appendChild(el); return f; };
        // create header if missing
        if (!container.querySelector('.header-row')) {
            const header = document.createElement('div'); header.className = 'set-row header-row';
            const labSets = document.createElement('div'); labSets.className='field'; const l1=document.createElement('label'); l1.textContent = (GN_I18N && GN_I18N.safeT) ? GN_I18N.safeT('history_sets') : 'Sets'; labSets.appendChild(l1);
            const labReps = document.createElement('div'); labReps.className='field'; const l2=document.createElement('label'); l2.textContent = (GN_I18N && GN_I18N.safeT) ? GN_I18N.safeT('history_reps') : 'Reps'; labReps.appendChild(l2);
            const labKg = document.createElement('div'); labKg.className='field'; const l3=document.createElement('label'); l3.textContent = (GN_I18N && GN_I18N.safeT) ? GN_I18N.safeT('history_kg') : 'Kg'; labKg.appendChild(l3);
            header.appendChild(labSets); header.appendChild(labReps); header.appendChild(labKg); header.appendChild(document.createElement('div'));
            container.appendChild(header);
        }

        const row = document.createElement('div'); row.className = 'set-row data-row';
        const setsInput = document.createElement('input'); setsInput.type = 'number'; setsInput.min = '0';
        const repsInput = document.createElement('input'); repsInput.type = 'number'; repsInput.min = '0';
        const weightInput = document.createElement('input'); weightInput.type = 'number'; weightInput.step = '0.5';
        const apply = (el, v) => { if (v !== undefined && v !== null && v !== '') el.value = v; };
        apply(setsInput, setData && setData.sets);
        apply(repsInput, setData && setData.reps);
        apply(weightInput, setData && setData.weight);
        row.appendChild(makeField(setsInput));
        row.appendChild(makeField(repsInput));
        row.appendChild(makeField(weightInput));
        const rm = document.createElement('button'); rm.type='button'; rm.className='remove-set-btn'; rm.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
        rm.onclick = (e) => { e.stopPropagation(); row.remove(); };
        const rmWrap = document.createElement('div'); rmWrap.appendChild(rm);
        row.appendChild(rmWrap);
        if (beforeNode && beforeNode.parentElement === container) container.insertBefore(row, beforeNode);
        else container.appendChild(row);
    }

    async function saveSession() {
        const date = document.getElementById('logDate').value;
        const logs = [];
        const lang = GN_I18N.safeGetLang ? GN_I18N.safeGetLang() : 'en';
        document.querySelectorAll('.exercise-row').forEach(r => {
            // Aggregate sets from any .set-row.data-row inside the exercise
            const rows = r.querySelectorAll('.set-row.data-row');
            if (!rows || rows.length === 0) return;
            let totalSets = 0;
            let pickedReps = null;
            let pickedWeight = null;
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (!inputs || inputs.length < 3) return;
                const sRaw = (inputs[0].value || '').toString().trim();
                const rRaw = (inputs[1].value || '').toString().trim();
                const wRaw = (inputs[2].value || '').toString().trim();
                const sCount = (sRaw === '' ? 1 : (isNaN(Number(sRaw)) ? 1 : parseInt(sRaw, 10)));
                totalSets += sCount;
                if (!pickedReps && rRaw !== '') pickedReps = parseInt(rRaw, 10);
                if (!pickedWeight && wRaw !== '') pickedWeight = parseFloat(wRaw);
            });
            // require at least reps and weight to save
            if (pickedReps === null || pickedWeight === null) return;
            const name = (lang === 'pt' && r.dataset.namePt) ? r.dataset.namePt : (r.dataset.name || null);
            logs.push({ 
                exerciseId: parseInt(r.dataset.id), 
                isCustom: r.dataset.iscustom === 'true',
                exerciseName: name, 
                imageId: parseInt(r.dataset.imgid) || null, 
                sets: parseInt(totalSets) || 1, 
                weight: parseFloat(pickedWeight), 
                reps: parseInt(pickedReps), 
                date 
            });
        });
        if (isEditMode) {
            try {
                if (editDate) {
                    // Replace all logs for the edited date with the new ones
                    await db.history.where('date').equals(editDate).delete();
                    if (logs.length > 0) await db.history.bulkAdd(logs);
                } else if (editLogId) {
                    if (logs.length === 1) {
                        const updated = logs[0];
                        updated.id = editLogId;
                        await db.history.put(updated);
                    } else if (logs.length === 0) {
                        await db.history.delete(editLogId);
                    } else {
                        await db.history.delete(editLogId);
                        await db.history.bulkAdd(logs);
                    }
                } else {
                    // fallback: just add
                    if (logs.length > 0) await db.history.bulkAdd(logs);
                }
            } catch (e) { console.error('Failed to update log in edit mode', e); }
        } else {
            await db.history.bulkAdd(logs);
        }
        localStorage.setItem('has_local_changes', 'true');
        location.href = 'history.html';
    }

    async function deleteDateLogs(date) { /* not used here, but keep for API parity */ }

    async function deleteLog(id) { /* not used here, but keep for API parity */ }

    if (window.GN_I18N) {
        try { GN_I18N.applyTranslations(document); } catch(e){}
        try { document.title = GN_I18N.t('title_main') + ' | ' + GN_I18N.t('history_header'); } catch(e){}
    }
    init();
    </script>
    </div>
    <div id="disclaimer" class="disclaimer" data-i18n="history_disclaimer_stats_only">The values changed here will not be applied to the routines. Only to the statistics.</div>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GymNerd | Log Entry</title>
    <link rel="icon" type="image/svg+xml" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <link href="https://fonts.googleapis.com" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,300,0,0" rel="stylesheet">
    <script src="auth.js"></script>
    <script src="gn-i18n.js"></script>
    <script src="drive-storage.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="db.js"></script>
    <style>
        :root { --primary: #3b82f6; --primary-grad: linear-gradient(135deg, #60a5fa 0%, #2563eb 100%); --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --text-dim: #94a3b8; --success: #10b981; --danger: #ef4444; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); max-width: 500px; margin: 0 auto; padding: 0; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .top-card { position: static; background: linear-gradient(180deg, #ffffff 0%, #ffffff 70%, #f3f4f6 100%); color: #0f172a; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; padding: 10px 16px 6px; box-shadow: 0 6px 16px rgba(2,6,23,0.06); padding-top: calc(10px + constant(safe-area-inset-top)); padding-top: calc(10px + env(safe-area-inset-top)); }
        body::before { content: ''; position: fixed; top: 0; left: 0; right: 0; height: constant(safe-area-inset-top); height: env(safe-area-inset-top); background: #ffffff; z-index: 1100; pointer-events: none; }
        .top-card-inner { max-width: 100%; display:flex; flex-direction:column; align-items:center; gap:8px; padding-bottom: 2px; }
        .page-content { padding: 16px; padding-top: 12px; }
        .top-card .topbar { background: transparent; padding: 6px 0; display:flex; align-items:center; justify-content:space-between; width:100%; }
        #topbar-title { flex: 1; min-width: 0; display:flex; align-items:center; }
        .app-title-compact { font-weight: 900; font-size: 1.2rem; letter-spacing: -1px; background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 8px rgba(59,130,246,0.25)); font-style: italic; white-space:nowrap; overflow:visible; }
        .back-btn { text-decoration: none; font-size: 1.5rem; color: inherit; }
        .top-card .back-btn, .top-card .back-btn .material-symbols-outlined { display: inline-flex; align-items: center; justify-content: center; line-height: 1; }
        .card { background: var(--card); padding: 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px; }
        .card h2 { margin-top: 0; margin-bottom: 15px; font-size: 1.2rem; }
        select, input, button { padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); font-size: 1rem; width: 100%; box-sizing: border-box; background: rgba(255,255,255,0.05); color: white; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1) brightness(2); cursor: pointer; }
        .input-pair { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; grid-column: span 3; }
        .save-session { background: var(--primary-grad); color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2); }
        .save-session.success { background: var(--success); }
        button.primary { background: var(--primary-grad); color: white; border: none; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div class="top-card">
        <div class="top-card-inner">
            <div style="display:flex;align-items:center;width:100%;gap:12px;">
                <a href="history.html" class="back-btn" aria-label="Back"><span class="material-symbols-outlined" aria-hidden="true" style="font-variation-settings: 'wght' 300;">arrow_back</span></a>
                <div style="flex:1;min-width:0;">
                    <h2 data-i18n="history_header">Log Entry</h2>
                </div>
            </div>
        </div>
    </div>
    <div class="page-content">
        <div id="routineFormSection" class="card" style="margin-bottom: 20px;">
                <input type="date" id="logDate" style="margin-bottom:10px">
                <select id="routinePicker" onchange="generateSheet()"><option value="" data-i18n="history_placeholder_choose_routine">-- Choose Routine --</option></select>
                <div id="workoutSheet"></div>
                <div style="display:flex; gap:8px; margin-top:10px;">
                    <button type="button" style="flex:1; width:100%; background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--text-dim); padding:12px; border-radius:12px;" onclick="location.href='history.html'" data-i18n="history_cancel">Cancel</button>
                    <button id="saveBtn" class="primary" style="flex:1; width:100%;" onclick="saveSession()" data-i18n="history_save_session">ðŸ’¾ Save Session</button>
                </div>
        </div>

        <div id="weightFormSection" class="card" style="margin-bottom: 20px;">
                <form id="weightForm" onsubmit="event.preventDefault(); saveWeightEntry();">
                        <input type="date" id="weightDate" required style="margin-bottom:10px">
                    <input type="number" id="weightKg" step="0.1" min="0" data-i18n-placeholder="history_weight_kg" placeholder="Weight (kg)" required>
                    <div style="display:flex; gap:8px; margin-top:10px;">
                        <button type="button" style="flex:1; width:100%; background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--text-dim); padding:12px; border-radius:12px;" onclick="location.href='history.html'" data-i18n="history_cancel">Cancel</button>
                        <button type="submit" class="primary" style="flex:1; width:100%;" data-i18n="history_save_weight">ðŸ’¾ Save Weight</button>
                    </div>
                </form>
                <div id="weightSaveMsg" style="color:var(--success);margin-top:8px;display:none" data-i18n="history_weight_saved">Weight saved!</div>
        </div>

    <script>
        function showForm(id) {
            document.getElementById(id).style.display = 'block';
        }
        function hideForm(id) {
            document.getElementById(id).style.display = 'none';
        }

        async function saveWeightEntry() {
                const date = document.getElementById('weightDate').value;
                const weight = parseFloat(document.getElementById('weightKg').value);
                if (!date || isNaN(weight)) return;
                await ensureDbOpen();
                await db.weights.put({ date, weight });
                localStorage.setItem('has_local_changes', 'true');
                document.getElementById('weightSaveMsg').style.display = 'block';
                setTimeout(() => { document.getElementById('weightSaveMsg').style.display = 'none'; }, 1500);
                hideForm('weightFormSection');
                try { renderWeightHistory(); } catch(e){}
        }

    let allEx = [];

    async function init() {
        await ensureDbOpen();
        const [catalogEx, customEx] = await Promise.all([
            db.catalog_exercises.toArray(),
            db.custom_exercises.toArray()
        ]);
        allEx = [
            ...catalogEx.map(ex => ({ ...ex, isCustom: false })),
            ...customEx.map(ex => ({ ...ex, isCustom: true }))
        ];
        const wks = await db.routines.toArray();
        const p = document.getElementById('routinePicker');
        wks.forEach(w => p.innerHTML += `<option value="${w.id}">${w.name}</option>`);
        document.getElementById('logDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('weightDate').value = new Date().toISOString().split('T')[0];
        // If opened from History with a mode param, show only the requested form
        try {
            const params = new URLSearchParams(window.location.search);
            const mode = params.get('mode');
            const titleEl = document.querySelector('[data-i18n="history_header"]');
            if (mode === 'routine') {
                document.getElementById('routineFormSection').style.display = 'block';
                document.getElementById('weightFormSection').style.display = 'none';
                document.getElementById('logDate').value = new Date().toISOString().split('T')[0];
                if (titleEl) {
                    if (window.GN_I18N && GN_I18N.t) titleEl.innerText = GN_I18N.t('history_section_log_routine');
                    else titleEl.innerText = 'Log routine';
                }
                try { if (window.GN_I18N && GN_I18N.t) document.title = GN_I18N.t('title_main') + ' | ' + GN_I18N.t('history_section_log_routine'); } catch(e){}
            } else if (mode === 'weight') {
                document.getElementById('weightFormSection').style.display = 'block';
                document.getElementById('routineFormSection').style.display = 'none';
                document.getElementById('weightDate').value = new Date().toISOString().split('T')[0];
                if (titleEl) {
                    if (window.GN_I18N && GN_I18N.t) titleEl.innerText = GN_I18N.t('history_section_log_weight');
                    else titleEl.innerText = 'Log weight';
                }
                try { if (window.GN_I18N && GN_I18N.t) document.title = GN_I18N.t('title_main') + ' | ' + GN_I18N.t('history_section_log_weight'); } catch(e){}
            }
        } catch (e) {}
    }

    async function generateSheet() {
        const id = parseInt(document.getElementById('routinePicker').value);
        const sheet = document.getElementById('workoutSheet');
        if(!id) { sheet.innerHTML=""; return; }
        const wk = await db.routines.get(id);
        sheet.innerHTML = "";
        const phSets = GN_I18N.safeT ? GN_I18N.safeT('history_sets') : 'Sets';
        const phKg = GN_I18N.safeT ? GN_I18N.safeT('history_kg') : 'Kg';
        const phReps = GN_I18N.safeT ? GN_I18N.safeT('history_reps') : 'Reps';
        for (const item of wk.exerciseIds) {
            const id = typeof item === 'object' ? item.id : item;
            const isCustom = typeof item === 'object' ? !!item.isCustom : false;
            const ex = allEx.find(e => e.id === id && !!e.isCustom === isCustom);
            if (!ex) continue;
            const imgTable = isCustom ? db.custom_images : db.catalog_images;
            let imgSrc = defaultImage;
            if (ex.imageId) {
                const imgRec = await imgTable.get(ex.imageId);
                if (imgRec && imgRec.data) imgSrc = imgRec.data;
            }
            
            let sets, weight, reps;
            if (typeof item === 'object') {
                if (Array.isArray(item.sets)) {
                    sets = item.sets.length;
                    weight = item.sets[0]?.weight || '';
                    reps = item.sets[0]?.reps || '';
                } else {
                    sets = item.sets || 3;
                    weight = item.weight || '';
                    reps = item.reps || '';
                }
            } else {
                sets = 3; weight = ''; reps = '';
            }

            sheet.innerHTML += `<div class="exercise-row" data-id="${ex.id}" data-name="${ex.name}" data-name-pt="${ex.namePT || ''}" data-imgid="${ex.imageId || ''}" data-iscustom="${isCustom}">
                <img src="${imgSrc}" class="ex-thumb"><strong>${ex.name}</strong><button onclick="this.parentElement.remove()" style="background:none;border:none;color:var(--danger);cursor:pointer;padding:0;display:flex;align-items:center;justify-content:center;width:auto"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                <div class="input-pair"><input type="number" placeholder="${phSets}" class="s" value="${sets}"><input type="number" step="0.5" placeholder="${phKg}" class="w" value="${weight}"><input type="number" placeholder="${phReps}" class="r" value="${reps}"></div></div>`;
        }
        document.getElementById('saveBtn').style.display = "block";
    }

    async function saveSession() {
        const date = document.getElementById('logDate').value;
        const logs = [];
        const lang = GN_I18N.safeGetLang ? GN_I18N.safeGetLang() : 'en';
        document.querySelectorAll('.exercise-row').forEach(r => {
            const sets = r.querySelector('.s').value;
            const weight = r.querySelector('.w').value;
            const reps = r.querySelector('.r').value;
            if(weight && reps) {
                const name = (lang === 'pt' && r.dataset.namePt) ? r.dataset.namePt : (r.dataset.name || null);
                logs.push({ 
                    exerciseId: parseInt(r.dataset.id), 
                    isCustom: r.dataset.iscustom === 'true',
                    exerciseName: name, 
                    imageId: parseInt(r.dataset.imgid) || null, 
                    sets: parseInt(sets) || 3, 
                    weight: parseFloat(weight), 
                    reps: parseInt(reps), 
                    date 
                });
            }
        });
        await db.history.bulkAdd(logs);
        localStorage.setItem('has_local_changes', 'true');
        location.href = 'history.html';
    }

    async function deleteDateLogs(date) { /* not used here, but keep for API parity */ }

    async function deleteLog(id) { /* not used here, but keep for API parity */ }

    if (window.GN_I18N) {
        try { GN_I18N.applyTranslations(document); } catch(e){}
        try { document.title = GN_I18N.t('title_main') + ' | ' + GN_I18N.t('history_header'); } catch(e){}
    }
    init();
    </script>
</div>
</body>
</html>

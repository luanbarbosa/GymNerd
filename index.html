<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GymNerd | Home</title>
    <link rel="icon" type="image/svg+xml" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <!-- Optional: set this to your deployed token-exchange function URL.
         Example:
         window.EXCHANGE_TOKEN_URL = 'https://us-central1-PROJECT.cloudfunctions.net/exchangeToken';
         If empty, the app will first try same-origin `/exchangeToken` (works when deployed
         to Firebase Hosting with rewrites). GitHub Pages won't accept POSTs at that path.
    -->
    <script>
        window.EXCHANGE_TOKEN_URL = '';
    </script>
    <script src="gn-i18n.js"></script>
    <script src="auth.js"></script>
    <script src="drive-storage.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="db.js"></script>
    <style>
        :root { --primary: #3b82f6; --primary-grad: linear-gradient(135deg, #60a5fa 0%, #2563eb 100%); --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --text-dim: #94a3b8; --success: #10b981; --danger: #ef4444; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); max-width: 500px; margin: 0 auto; padding: 0; line-height: 1.5; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .main-content { padding: 20px; display: none; }
        h1 { text-align: center; font-weight: 900; margin-bottom: 40px; margin-top: 20px; letter-spacing: -2px; font-size: 3.5rem; background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.5)); font-style: italic; }
        .app-title-compact { font-weight: 900; font-size: 1.4rem; letter-spacing: -1px; background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 12px rgba(59,130,246,0.35)); font-style: italic; }
        
        .menu-grid { display: grid; gap: 15px; margin-top: 64px; }
        .user-card { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; margin:12px 0 26px; }
        .user-avatar { width:96px; height:96px; border-radius:50%; object-fit:cover; border:2px solid rgba(255,255,255,0.06); }
        .user-line { display:flex; align-items:center; justify-content:center; gap:10px; }
        /* Same (larger) font-size for both greeting and name, styles differ */
        .user-greeting { font-weight:600; font-size:2.2rem; color: var(--text-dim); }
        .user-name { font-weight:900; font-size:2.2rem; letter-spacing:-0.6px; text-align:center; background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 18px rgba(37,99,235,0.32)); }
        .motivational-text { font-weight:500; font-size:0.95rem; color: #9aa6bd; text-align:center; margin-top:4px; font-style:italic; }
        .nav-card { background: var(--card); padding: 24px; border-radius: 16px; text-decoration: none; color: inherit; display: flex; justify-content: space-between; align-items: center; font-weight: 700; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid rgba(255,255,255,0.05); }
        .nav-card:active { transform: scale(0.97); }
        
        details { background: var(--card); border-radius: 16px; margin-top: 40px; border: 1px solid rgba(255,255,255,0.05); }
        summary { font-weight: bold; cursor: pointer; padding: 15px 20px; list-style: none; display: flex; justify-content: space-between; align-items: center; color: var(--text-dim); }
        summary .chevron { transition: transform 0.2s; color: var(--text-dim); }
        details[open] summary .chevron { transform: rotate(180deg); }
        .content-box { padding: 0 20px 20px 20px; border-top: 1px solid rgba(255,255,255,0.05); }
        
        .sync-btn { width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 10px; }
        .export-btn { background: var(--success); color: white; }
        .import-btn { background: #6366f1; color: white; }
        label { font-size: 0.75rem; font-weight: bold; color: #64748b; display: block; margin-top: 10px; }
    </style>
</head>
<body>

    <script>
        // Keep the main UI hidden until auth + initial sync complete
        window.showApp = function() {
            try { document.querySelector('.main-content').style.display = 'block'; } catch(e){}
            try { const blocker = document.getElementById('auth-blocker'); if (blocker) blocker.remove(); } catch(e){}
            try { const loader = document.getElementById('global-loader'); if (loader) loader.style.display = 'none'; } catch(e){}
        };
    </script>

    <div class="topbar" style="position:sticky;top:0;z-index:1200;display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:transparent;">
        <div id="topbar-title">
            <div class="app-title-compact" data-i18n="title_main">GymNerd</div>
        </div>
        <div id="topbar-actions">
            <a id="topbar-settings" href="settings.html" aria-label="Settings" style="display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;color:#94a3b8;border:1px solid rgba(255,255,255,0.04);border-radius:10px;text-decoration:none;">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06A2 2 0 1 1 2.28 18.9l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09c.7 0 1.27-.4 1.51-1a1.65 1.65 0 0 0-.33-1.82l-.06-.06A2 2 0 1 1 5.1 2.28l.06.06a1.65 1.65 0 0 0 1.82.33H7a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09c0 .6.4 1.17 1 1.51h.02c.7 0 1.27.4 1.51 1a1.65 1.65 0 0 0 .33 1.82l.06.06A2 2 0 1 1 19.4 6.1l-.06-.06a1.65 1.65 0 0 0-.33 1.82c.2.6.8 1 1.5 1H21a2 2 0 1 1 0 4h-.09c-.7 0-1.27.4-1.51 1z"></path></svg>
            </a>
        </div>
    </div>

    <div class="main-content">

        <button id="sync-pending-btn" class="nav-card" style="display:none; width:100%; background: #f59e0b; color: white; margin-bottom: 15px; border: none; cursor: pointer; box-shadow: 0 10px 20px rgba(245, 158, 11, 0.2);" onclick="syncToDrive()">
            <span data-i18n="sync_pending">‚òÅÔ∏è Sync Pending Changes</span><span>‚Üí</span>
        </button>

        <div id="home-user-main"></div>
        
        <div class="menu-grid">
            <a href="livesession.html" class="nav-card" style="background: var(--primary-grad); color: white; box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3);"><span data-i18n="menu_start_routine">üöÄ Start Routine</span><span>‚Üí</span></a>
            <a href="routines.html" class="nav-card"><span data-i18n="menu_routines">üèã Routines</span><span>‚Üí</span></a>
            <a href="history.html" class="nav-card"><span data-i18n="menu_history">üìã History</span><span>‚Üí</span></a>
            <a href="statistics.html" class="nav-card"><span data-i18n="menu_statistics">üìä Statistics</span><span>‚Üí</span></a>
        </div>
    </div>

    <script>

        // Render compact app title into the sticky topbar
        function renderCompactApp() {
            const container = document.getElementById('topbar-title');
            if (!container) return;
            container.innerHTML = `
                <div style="display:flex; align-items:center; gap:12px;">
                    <div style="flex:1; min-width:0;">
                        <div class="app-title-compact" data-i18n="title_main">GymNerd</div>
                    </div>
                </div>
            `;
            // ensure settings aria label is localized
            try {
                const s = document.getElementById('topbar-settings');
                if (s) s.setAttribute('aria-label', (typeof GN_I18N !== 'undefined') ? GN_I18N.t('menu_settings') : 'Settings');
            } catch(e){}
        }
        function renderMainUser() {
            const container = document.getElementById('home-user-main');
            if (!container) return;
            let user = null;
            try {
                if (typeof getGoogleUser === 'function') user = getGoogleUser();
                else {
                    const u = localStorage.getItem('google_user'); if (u) user = JSON.parse(u);
                }
            } catch (e) { user = null; }

            const name = user ? (user.name || user.email || '') : '';
            const avatar = user ? (user.picture || '') : '';

            // Simple greeting abbreviation: always show "Hi" or "Ol√°" next to the name
            const greeting = (typeof GN_I18N !== 'undefined') ? GN_I18N.t('greeting_hi') : ((navigator.language || '').toLowerCase().startsWith('pt') ? 'Ol√°' : 'Hi');

            const motivational = '';

            container.innerHTML = `
                <div class="user-card">
                    <div class="user-line" style="flex-direction:column; gap:8px;">
                        <img src="${avatar || 'favicon.png'}" alt="avatar" class="user-avatar" />
                        <div style="display:flex; flex-direction:row; align-items:center; gap:8px;">
                            <div class="user-greeting">${greeting}</div>
                            <div class="user-name">${name || 'GymNerd'}</div>
                        </div>
                    </div>
                    <div class="motivational-text">${motivational}</div>
                </div>
            `;
            // After rendering the DOM, attempt to load a motivational quote
            // and replace the placeholder text. This uses a remote raw GitHub
            // URL and falls back to a local file under `catalog/` if needed.
            try { loadMotivationalText(); } catch (e) { /* ignore */ }
        }

        async function loadMotivationalText() {
            const elem = document.querySelector('.motivational-text');
            if (!elem) return;

            const urls = {
                en: 'https://raw.githubusercontent.com/luanbarbosa/GymNerd/refs/heads/main/catalog/motivational-quotes-en.json',
                pt: 'https://raw.githubusercontent.com/luanbarbosa/GymNerd/refs/heads/main/catalog/motivational-quotes-pt.json'
            };

            function getLang() {
                try {
                    if (typeof GN_I18N !== 'undefined' && GN_I18N.safeGetLang) return GN_I18N.safeGetLang().slice(0,2).toLowerCase();
                    return (navigator.language || navigator.userLanguage || 'en').slice(0,2).toLowerCase();
                } catch (e) { return 'en'; }
            }

            const lang = getLang();
            const remote = urls[lang] || urls.en;

            async function tryFetch(u) {
                try {
                    const res = await fetch(u, { cache: 'no-cache' });
                    if (!res.ok) throw new Error('bad status ' + res.status);
                    const data = await res.json();
                    if (Array.isArray(data) && data.length > 0) return data;
                } catch (e) {
                    return null;
                }
                return null;
            }

            let quotes = await tryFetch(remote);
            if (!quotes) {
                // local fallback to packaged file
                quotes = await tryFetch(`catalog/motivational-quotes-${lang}.json`) || await tryFetch('catalog/motivational-quotes-en.json');
            }

            if (quotes && quotes.length > 0) {
                const pick = quotes[Math.floor(Math.random() * quotes.length)];
                if (pick && String(pick).trim()) {
                    elem.textContent = pick;
                } else {
                    try { elem.remove(); } catch (e) { elem.style.display = 'none'; }
                }
            } else {
                // If no quotes available, remove the motivational element entirely
                try { elem.remove(); } catch (e) { elem.style.display = 'none'; }
            }
        }

        // Initial render
        try { renderCompactApp(); } catch (e) {}
        try { renderMainUser(); } catch (e) {}
        try { GN_I18N && GN_I18N.applyTranslations && GN_I18N.applyTranslations(document.body); } catch (e) {}
    </script>
</body>
</html>
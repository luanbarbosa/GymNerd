<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
	<meta name="theme-color" content="#ffffff">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="default">
	<meta name="apple-mobile-web-app-title" content="GymNerd">
	<title>GymNerd | Home</title>
	<link rel="icon" type="image/svg+xml" href="favicon.svg">
	<link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon-180.png">
	<link rel="apple-touch-icon" sizes="167x167" href="icons/apple-touch-icon-167.png">
	<link rel="apple-touch-icon" sizes="152x152" href="icons/apple-touch-icon-152.png">
	<link rel="apple-touch-icon" sizes="120x120" href="icons/apple-touch-icon-120.png">
	<link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#2563eb">
	<link rel="manifest" href="./manifest.json">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
	<script>
		window.EXCHANGE_TOKEN_URL = '';
	</script>
	<script>
		// Startup watchdog: run after all scripts are loaded to ensure DriveStorage and db exist.
		document.addEventListener('DOMContentLoaded', async () => {
			try {
				const needs = localStorage.getItem && localStorage.getItem('needs_initial_download');
				if (needs !== 'true') return;
				console.info('[StartupWatchdog] needs_initial_download detected â€” starting auto-restore');
				try { if (window.showLoading) window.showLoading((typeof GN_I18N !== 'undefined') ? GN_I18N.t('welcome_back_syncing') : 'Welcome back! Syncing your data...'); } catch(e){}

				if (typeof DriveStorage === 'undefined') {
					console.warn('[StartupWatchdog] DriveStorage not available');
					}

				// Render the most-frequent exercise TYPE over a selected range
				async function renderFavoriteType(range = 'all') {
					try {
						if (typeof ensureDbOpen === 'function') await ensureDbOpen();
						const widget = document.getElementById('fav-type-widget');
						if (!widget) return;
						let items = await db.history.toArray();
						if (!items || items.length === 0) {
							widget.style.display = 'none';
							return;
						}
						const now = new Date(); now.setHours(0,0,0,0);
						if (range === 'year') {
							const start = new Date(now.getFullYear(), 0, 1);
							items = items.filter(it => { const d = new Date(it.date); d.setHours(0,0,0,0); return d >= start; });
						} else if (range === 'month') {
							const start = new Date(now.getFullYear(), now.getMonth(), 1);
							items = items.filter(it => { const d = new Date(it.date); d.setHours(0,0,0,0); return d >= start; });
						}
						if (!items || items.length === 0) { widget.style.display = 'none'; return; }
						const counts = {};
						for (const it of items) {
							let ex = null;
							try {
								if (it.isCustom === true) ex = await db.custom_exercises.get(it.exerciseId);
								else if (it.isCustom === false) ex = await db.catalog_exercises.get(it.exerciseId);
								else {
									ex = await db.catalog_exercises.get(it.exerciseId);
									if (!ex) ex = await db.custom_exercises.get(it.exerciseId);
								}
							} catch (e) { ex = null; }
							const type = (ex && ex.type) ? ex.type : 'other';
							counts[type] = (counts[type] || 0) + 1;
						}
						let bestType = null, bestCount = 0;
						for (const k of Object.keys(counts)) {
							if (counts[k] > bestCount) { bestCount = counts[k]; bestType = k; }
						}
						if (!bestType) { widget.style.display = 'none'; return; }
						// Localize label if helper available
						let label = bestType;
						try { if (window.GN_I18N && typeof GN_I18N.localizeExerciseType === 'function') label = GN_I18N.localizeExerciseType(bestType); else label = bestType.charAt(0).toUpperCase() + bestType.slice(1); } catch(e){}
						try { const nameEl = document.getElementById('fav-type-name'); if (nameEl) nameEl.textContent = label; } catch(e){}
						try { const countEl = document.getElementById('fav-type-count'); if (countEl) countEl.textContent = ` (${bestCount}x)`; } catch(e){}
						widget.style.display = 'flex';
					} catch (err) { console.error('renderFavoriteType failed', err); }
				}

				// wire up range selector
				try {
					const sel = document.getElementById('fav-type-range');
					if (sel) sel.addEventListener('change', (e) => {
						try { renderFavoriteType(e.target.value); } catch(err){}
						try { if (typeof renderFavoriteExercise === 'function') renderFavoriteExercise(e.target.value); else if (typeof window.renderFavoriteExercise === 'function') window.renderFavoriteExercise(e.target.value); } catch(err){}
					});
				} catch(e){}
					try { if (window.hideLoading) window.hideLoading(); } catch(e){}
					return;
				}

				try { if (typeof ensureDbOpen === 'function') await ensureDbOpen(); } catch(e){ console.warn('[StartupWatchdog] ensureDbOpen failed', e); }

				console.info('[StartupWatchdog] calling DriveStorage.load');
				const data = await DriveStorage.load();
				console.info('[StartupWatchdog] DriveStorage.load returned', { hasData: !!data, keys: data ? Object.keys(data) : [] });

				if (!data) {
					try { localStorage.removeItem('needs_initial_download'); } catch(e){}
					try { if (window.hideLoading) window.hideLoading(); } catch(e){}
					try { if (window.showApp) window.showApp(); } catch(e){}
					return;
				}

				if (typeof db !== 'undefined') {
					try {
						await db.transaction('rw', [db.catalog_exercises, db.catalog_images, db.custom_exercises, db.custom_images, db.routines, db.history, db.weights], async () => {
							if (db.catalog_images) {
								await db.catalog_images.clear();
								if (data.catalog_images) {
									const normalizedCatalogImages = data.catalog_images.map(img => ({
										...img,
										data: img.data ? (img.data.startsWith('data:') ? img.data : `data:image/png;base64,${img.data}`) : img.data
									}));
									await db.catalog_images.bulkAdd(normalizedCatalogImages);
								}
... (backup contains full original content)

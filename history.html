<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GymNerd | History</title>
    <link rel="icon" type="image/svg+xml" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <script src="auth.js"></script>
    <script src="gn-i18n.js"></script>
    <script src="drive-storage.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="db.js"></script>
    <style>
        :root { --primary: #3b82f6; --primary-grad: linear-gradient(135deg, #60a5fa 0%, #2563eb 100%); --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --text-dim: #94a3b8; --success: #10b981; --danger: #ef4444; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); max-width: 500px; margin: 0 auto; padding: 20px; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .header h2 { font-weight: 800; letter-spacing: -0.5px; background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; }
        .back-btn { text-decoration: none; font-size: 1.5rem; color: var(--text); }
        .card { background: var(--card); padding: 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px; }
        .card h2 { margin-top: 0; margin-bottom: 15px; font-size: 1.2rem; }
        select, input, button { padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); font-size: 1rem; width: 100%; box-sizing: border-box; background: rgba(255,255,255,0.05); color: white; }
        .exercise-row { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.05); display: grid; grid-template-columns: 50px 1fr 30px; gap: 15px; align-items: center; }
        .ex-thumb { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: #fff; }
        .log-entry img { background: #fff; }
        .input-pair { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; grid-column: span 3; }
        .input-pair input { background: #000; }
        .save-session { background: var(--primary-grad); color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2); }
        .save-session.success { background: var(--success); }

        details.history-section { background: var(--card); border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); margin-top: 20px; }
        summary.section-header { font-weight: 800; cursor: pointer; padding: 15px 20px; list-style: none; display: flex; justify-content: space-between; align-items: center; color: var(--text-dim); }
        summary .chevron { transition: transform 0.2s; color: var(--text-dim); }
        details[open] summary .chevron { transform: rotate(180deg); }

        details.month-group { margin-bottom: 15px; }
        summary.month-header { font-weight: 700; font-size: 0.85rem; color: var(--text-dim); cursor: pointer; padding: 8px 0; list-style: none; text-transform: uppercase; letter-spacing: 0.05em; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 10px; }

        details.history-group { background: rgba(255,255,255,0.02); border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 10px; overflow: hidden; }
        summary.date-header { padding: 12px 15px; font-size: 0.85rem; font-weight: 800; cursor: pointer; list-style: none; display: flex; justify-content: space-between; align-items: center; }
        .log-entry { padding: 10px 15px; border-bottom: 1px solid rgba(255,255,255,0.02); display: flex; justify-content: space-between; align-items: flex-start; font-size: 0.85rem; color: var(--text-dim); }
        .log-entry .meta { display:flex; flex-direction:column; gap:6px; align-items:flex-start; }
        .log-entry .name-row { display:flex; align-items:center; gap:8px; font-weight:700; color:var(--text); }
        .log-entry .data-row { font-size:0.85rem; color:var(--text-dim); }
        .delete-btn { background:none; border:none; color:var(--danger); cursor:pointer; padding:8px; display:inline-flex; align-items:center; justify-content:center; border-radius:10px; width:40px; height:40px; touch-action:manipulation; opacity:0.9 }
        .delete-btn svg { width:18px; height:18px; }
        .date-header .delete-btn { margin-left:12px; margin-right:6px; opacity:0.8 }
        .log-entry { gap: 8px; }
        .date-delete-btn { background:none; border:1px solid rgba(255,255,255,0.06); color:var(--danger); padding:8px 12px; border-radius:10px; cursor:pointer; }
    </style>
</head>
<body>
    <div class="header"><a href="index.html" class="back-btn">‚Üê</a><h2 data-i18n="history_header">History</h2></div>
        <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                <button id="toggleRoutineForm" class="save-session" style="flex:1" data-i18n="history_btn_new_routine">New Routine Entry</button>
                <button id="toggleWeightForm" class="save-session" style="flex:1" data-i18n="history_btn_new_weight">New Weight Entry</button>
        </div>

        <div id="routineFormSection" class="card" style="display:none; margin-bottom: 20px;">
                <div class="section-header"><h2 data-i18n="history_section_log_routine">Log Routine</h2></div>
                <select id="routinePicker" onchange="generateSheet()"><option value="" data-i18n="history_placeholder_choose_routine">-- Choose Routine --</option></select>
                <input type="date" id="logDate" style="margin-top:10px">
                <div id="workoutSheet"></div>
                <button id="saveBtn" class="save-session" style="display:none" onclick="saveSession()" data-i18n="history_save_session">üíæ Save Session</button>
                <button type="button" class="save-session" style="background:var(--danger);margin-top:10px" onclick="hideForm('routineFormSection')" data-i18n="history_cancel">Cancel</button>
        </div>

        <div id="weightFormSection" class="card" style="display:none; margin-bottom: 20px;">
                <div class="section-header"><h2 data-i18n="history_section_log_weight">Log Weight</h2></div>
                <form id="weightForm" onsubmit="event.preventDefault(); saveWeightEntry();">
                        <input type="date" id="weightDate" required style="margin-bottom:10px">
                    <input type="number" id="weightKg" step="0.1" min="0" data-i18n-placeholder="history_weight_kg" placeholder="Weight (kg)" required>
                    <button type="submit" class="save-session" style="margin-top:10px" data-i18n="history_save_weight">üíæ Save Weight</button>
                </form>
                <div id="weightSaveMsg" style="color:var(--success);margin-top:8px;display:none" data-i18n="history_weight_saved">Weight saved!</div>
                <button type="button" class="save-session" style="background:var(--danger);margin-top:10px" onclick="hideForm('weightFormSection')" data-i18n="history_cancel">Cancel</button>
        </div>
    <details class="history-section">
    <summary class="section-header"><span data-i18n="history_weight_header">Weight History</span><svg class="chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></summary>
        <div id="weight-history" style="padding: 0 15px 10px 15px;"></div>
    </details>

    <details class="history-section">
    <summary class="section-header"><span data-i18n="history_workout_header">Workout History</span><svg class="chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></summary>
        <div id="history" style="padding: 0 15px 10px 15px;"></div>
    </details>

        <script>
                function showForm(id) {
                    document.getElementById(id).style.display = 'block';
                }
                function hideForm(id) {
                    document.getElementById(id).style.display = 'none';
                }
                function formatDateDisplay(dateStr){
                    if (!dateStr) return dateStr;
                    const parts = dateStr.split('-');
                    if (parts.length !== 3) return dateStr;
                    return `${parts[2]}-${parts[1]}-${parts[0]}`;
                }
                document.getElementById('toggleRoutineForm').onclick = () => {
                    const r = document.getElementById('routineFormSection');
                    const w = document.getElementById('weightFormSection');
                    const isOpen = r.style.display === 'block';
                    if (isOpen) {
                        r.style.display = 'none';
                    } else {
                        r.style.display = 'block';
                        w.style.display = 'none';
                        document.getElementById('logDate').value = new Date().toISOString().split('T')[0];
                    }
                };
                document.getElementById('toggleWeightForm').onclick = () => {
                    const r = document.getElementById('routineFormSection');
                    const w = document.getElementById('weightFormSection');
                    const isOpen = w.style.display === 'block';
                    if (isOpen) {
                        w.style.display = 'none';
                    } else {
                        w.style.display = 'block';
                        r.style.display = 'none';
                        document.getElementById('weightDate').value = new Date().toISOString().split('T')[0];
                    }
                };
                // Set default dates on page load
                document.getElementById('logDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('weightDate').value = new Date().toISOString().split('T')[0];

                async function saveWeightEntry() {
                        const date = document.getElementById('weightDate').value;
                        const weight = parseFloat(document.getElementById('weightKg').value);
                        if (!date || isNaN(weight)) return;
                        await ensureDbOpen();
                        await db.weights.put({ date, weight });
                        localStorage.setItem('has_local_changes', 'true');
                        document.getElementById('weightSaveMsg').style.display = 'block';
                        setTimeout(() => { document.getElementById('weightSaveMsg').style.display = 'none'; }, 1500);
                        hideForm('weightFormSection');
                        try { renderWeightHistory(); } catch(e){}
                }
        let allEx = [];

        async function init() {
            await ensureDbOpen();
            // Default images will use `defaultImage` defined in `db.js` when specific images are missing.
            const [catalogEx, customEx] = await Promise.all([
                db.catalog_exercises.toArray(),
                db.custom_exercises.toArray()
            ]);
            allEx = [
                ...catalogEx.map(ex => ({ ...ex, isCustom: false })),
                ...customEx.map(ex => ({ ...ex, isCustom: true }))
            ];
            const wks = await db.routines.toArray();
            const p = document.getElementById('routinePicker');
            wks.forEach(w => p.innerHTML += `<option value="${w.id}">${w.name}</option>`);
            renderHistory();
        }

        async function generateSheet() {
            const id = parseInt(document.getElementById('routinePicker').value);
            const sheet = document.getElementById('workoutSheet');
            if(!id) { sheet.innerHTML=""; return; }
            const wk = await db.routines.get(id);
            sheet.innerHTML = "";
            const phSets = GN_I18N.safeT ? GN_I18N.safeT('history_sets') : 'Sets';
            const phKg = GN_I18N.safeT ? GN_I18N.safeT('history_kg') : 'Kg';
            const phReps = GN_I18N.safeT ? GN_I18N.safeT('history_reps') : 'Reps';
            for (const item of wk.exerciseIds) {
                const id = typeof item === 'object' ? item.id : item;
                const isCustom = typeof item === 'object' ? !!item.isCustom : false;
                const ex = allEx.find(e => e.id === id && !!e.isCustom === isCustom);
                if (!ex) continue;
                const imgTable = isCustom ? db.custom_images : db.catalog_images;
                let imgSrc = defaultImage;
                if (ex.imageId) {
                    const imgRec = await imgTable.get(ex.imageId);
                    if (imgRec && imgRec.data) imgSrc = imgRec.data;
                }
                
                let sets, weight, reps;
                if (typeof item === 'object') {
                    if (Array.isArray(item.sets)) {
                        sets = item.sets.length;
                        weight = item.sets[0]?.weight || '';
                        reps = item.sets[0]?.reps || '';
                    } else {
                        sets = item.sets || 3;
                        weight = item.weight || '';
                        reps = item.reps || '';
                    }
                } else {
                    sets = 3; weight = ''; reps = '';
                }

                sheet.innerHTML += `<div class="exercise-row" data-id="${ex.id}" data-name="${ex.name}" data-name-pt="${ex.namePT || ''}" data-imgid="${ex.imageId || ''}" data-iscustom="${isCustom}">
                    <img src="${imgSrc}" class="ex-thumb"><strong>${ex.name}</strong><button onclick="this.parentElement.remove()" style="background:none;border:none;color:var(--danger);cursor:pointer;padding:0;display:flex;align-items:center;justify-content:center;width:auto"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                    <div class="input-pair"><input type="number" placeholder="${phSets}" class="s" value="${sets}"><input type="number" step="0.5" placeholder="${phKg}" class="w" value="${weight}"><input type="number" placeholder="${phReps}" class="r" value="${reps}"></div></div>`;
            }
            document.getElementById('saveBtn').style.display = "block";
        }

        async function saveSession() {
            const date = document.getElementById('logDate').value;
            const logs = [];
            const lang = GN_I18N.safeGetLang ? GN_I18N.safeGetLang() : 'en';
            document.querySelectorAll('.exercise-row').forEach(r => {
                const sets = r.querySelector('.s').value;
                const weight = r.querySelector('.w').value;
                const reps = r.querySelector('.r').value;
                if(weight && reps) {
                    const name = (lang === 'pt' && r.dataset.namePt) ? r.dataset.namePt : (r.dataset.name || null);
                    logs.push({ 
                        exerciseId: parseInt(r.dataset.id), 
                        isCustom: r.dataset.iscustom === 'true',
                        exerciseName: name, 
                        imageId: parseInt(r.dataset.imgid) || null, 
                        sets: parseInt(sets) || 3, 
                        weight: parseFloat(weight), 
                        reps: parseInt(reps), 
                        date 
                    });
                }
            });
            await db.history.bulkAdd(logs);
            localStorage.setItem('has_local_changes', 'true');
            location.reload();
        }

        async function deleteDateLogs(date) {
            const fmt = formatDateDisplay(date);
            if (window.GN_I18N && typeof GN_I18N.t === 'function') {
                const tmpl = GN_I18N.t('history_confirm_delete');
                if (confirm(tmpl.replace('{date}', fmt))) {
                    await db.history.where('date').equals(date).delete();
                    localStorage.setItem('has_local_changes', 'true');
                    renderHistory();
                }
            } else {
                if(confirm(`Delete all entries for ${fmt}?`)) {
                    await db.history.where('date').equals(date).delete();
                    localStorage.setItem('has_local_changes', 'true');
                    renderHistory();
                }
            }
        }

        async function deleteLog(id) {
            const fmt = '';
            if (window.GN_I18N && typeof GN_I18N.t === 'function') {
                const tmpl = GN_I18N.t('history_confirm_delete_exercise') || 'Delete this exercise?';
                if (!confirm(tmpl)) return;
            } else {
                if (!confirm('Delete this exercise?')) return;
            }
            try {
                await db.history.delete(id);
                localStorage.setItem('has_local_changes', 'true');
                renderHistory();
            } catch (e) {
                console.error('Failed to delete log', e);
            }
        }

        async function renderHistory() {
            const logs = await db.history.orderBy('date').reverse().toArray();
            if (!logs || logs.length === 0) {
                const container = document.getElementById('history');
                const msg = (window.GN_I18N && GN_I18N.safeT) ? GN_I18N.safeT('history_no_history') : 'No history data';
                container.innerHTML = `<div style="padding:12px;color:var(--text-dim)">${msg}</div>`;
                return;
            }
            const groups = logs.reduce((acc, l) => {
                const month = l.date.substring(0, 7); // YYYY-MM
                if (!acc[month]) acc[month] = {};
                if (!acc[month][l.date]) acc[month][l.date] = [];
                acc[month][l.date].push(l);
                return acc;
            }, {});

            const container = document.getElementById('history');
            const lang = (window.GN_I18N && GN_I18N.getLang) ? GN_I18N.getLang() : 'en';
            const locale = lang === 'pt' ? 'pt' : 'en';
            container.innerHTML = "";

            for (const month of Object.keys(groups).sort().reverse()) {
                const monthDet = document.createElement('details');
                monthDet.className = "month-group";
                const [y, m] = month.split('-');
                const monthName = new Date(y, m - 1).toLocaleString(locale, { month: 'long', year: 'numeric' });
                monthDet.innerHTML = `<summary class="month-header"><span>${monthName}</span><svg class="chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></summary>`;
                
                for (const date of Object.keys(groups[month]).sort().reverse()) {
                    const dateDet = document.createElement('details');
                    dateDet.className = "history-group";
                            const delTitle = GN_I18N.safeT ? GN_I18N.safeT('history_delete_session') : 'Delete Session';
                            const formattedDate = formatDateDisplay(date);
                            dateDet.innerHTML = `<summary class="date-header"><span>${formattedDate}</span><svg class="chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></summary>`;
                    for (const l of groups[month][date]) {
                        // Prefer DB lookup so we can show localized names dynamically
                        const lang = (window.GN_I18N && GN_I18N.getLang) ? GN_I18N.getLang() : 'en';
                        let imageId = l.imageId;
                        let isCustom = (typeof l.isCustom === 'boolean') ? l.isCustom : undefined;
                        let exRec = null;

                        // Try to find exercise record in DB (custom first if unknown)
                        if (isCustom === true) exRec = await db.custom_exercises.get(l.exerciseId);
                        else if (isCustom === false) exRec = await db.catalog_exercises.get(l.exerciseId);
                        else {
                            exRec = await db.custom_exercises.get(l.exerciseId);
                            if (!exRec) exRec = await db.catalog_exercises.get(l.exerciseId);
                        }

                        if (exRec) {
                            if (!imageId && exRec.imageId) imageId = exRec.imageId;
                        }

                        const imgTable = isCustom ? db.custom_images : db.catalog_images;
                        let imgSrc = defaultImage;
                        if (imageId) {
                            const imgRec = await imgTable.get(imageId);
                            if (imgRec && imgRec.data) imgSrc = imgRec.data;
                        }

                        const setsText = (lang === 'pt') ? 's√©ries' : (GN_I18N.safeT ? GN_I18N.safeT('history_fmt_sets_short') : 'sets');
                        const kgSuffix = GN_I18N.safeT ? GN_I18N.safeT('history_fmt_kg_suffix') : 'kg';
                        const displayName = (exRec ? ((lang === 'pt' && exRec.namePT) ? exRec.namePT : exRec.name) : (l.exerciseName || (l.exerciseId ? `#${l.exerciseId}` : 'Unknown')));

                        dateDet.innerHTML += `<div class="log-entry"><div class="meta"><div class="name-row"><img src="${imgSrc}" style="width:25px;height:25px;border-radius:4px;object-fit:cover"> ${displayName}</div><div class="data-row">${l.sets || 3} ${setsText} x ${l.weight}${kgSuffix} x ${l.reps}</div></div><button class="delete-btn" aria-label="Delete exercise" title="Delete exercise" onclick="event.stopPropagation(); deleteLog(${l.id})"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div>`;
                    }
                    // add date-level text delete button at the bottom of the date box
                    const pageLang = (window.GN_I18N && GN_I18N.getLang) ? GN_I18N.getLang() : 'en';
                    const delText = (pageLang === 'pt') ? 'Deletar' : 'Exclude';
                    dateDet.innerHTML += `<div style="padding:10px 12px;display:flex;justify-content:flex-end"><button class="date-delete-btn" aria-label="${delTitle}" title="${delTitle}" onclick="event.stopPropagation(); deleteDateLogs('${date}')">${delText}</button></div>`;
                    monthDet.appendChild(dateDet);
                }
                container.appendChild(monthDet);
            }
        }

        async function renderWeightHistory() {
            const weights = await db.weights.orderBy('date').reverse().toArray();
            const container = document.getElementById('weight-history');
            container.innerHTML = '';
            if (!weights || weights.length === 0) {
                const msg = (window.GN_I18N && GN_I18N.safeT) ? GN_I18N.safeT('history_no_weight') : 'No weight history';
                container.innerHTML = `<div style="padding:12px;color:var(--text-dim)">${msg}</div>`;
                return;
            }
            const kgSuffix = (window.GN_I18N && GN_I18N.safeT) ? GN_I18N.safeT('history_fmt_kg_suffix') : 'kg';
            for (const w of weights) {
                const formatted = formatDateDisplay(w.date);
                container.innerHTML += `<div class="log-entry"><div class="meta"><div class="name-row">${formatted}</div><div class="data-row">${w.weight} ${kgSuffix}</div></div></div>`;
            }
        }
        if (window.GN_I18N) {
            try { GN_I18N.applyTranslations(document); } catch(e){}
            try { document.title = GN_I18N.t('title_main') + ' | ' + GN_I18N.t('history_header'); } catch(e){}
        }
        init();
        try { renderWeightHistory(); } catch(e){}
    </script>
</body>
</html>